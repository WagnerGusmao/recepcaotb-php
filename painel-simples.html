<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Terra do Bugio - Sistema de Recep√ß√£o</title>
    
    <!-- Favicon - Logo Terra do Bugio -->
    <link rel="icon" type="image/jpeg" href="imagem/terrabugio.jpg">
    <link rel="shortcut icon" type="image/jpeg" href="imagem/terrabugio.jpg">
    <link rel="apple-touch-icon" sizes="180x180" href="imagem/terrabugio.jpg">
    <link rel="apple-touch-icon" sizes="152x152" href="imagem/terrabugio.jpg">
    <link rel="apple-touch-icon" sizes="120x120" href="imagem/terrabugio.jpg">
    <link rel="apple-touch-icon" sizes="76x76" href="imagem/terrabugio.jpg">
    <link rel="apple-touch-icon" href="imagem/terrabugio.jpg">
    <meta name="theme-color" content="#2c3e50">
    <meta name="msapplication-TileColor" content="#2c3e50">
    <meta name="msapplication-TileImage" content="imagem/terrabugio.jpg">
    
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- jsPDF via CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" 
            integrity="sha512-qZvrmS2ekKPF2mSznTQsxqPgnpkI4DNTlrdUmTzrDgektczlKNRRhy5X5AAOnx5S09ydFYWWNSfcEqDTTHgtNA==" 
            crossorigin="anonymous" 
            referrerpolicy="no-referrer">
    </script>
    
    <!-- Adicionando html2canvas para melhor suporte a elementos HTML -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="js/municipios-completos.js"></script>
    
    <script>
        // Fun√ß√£o para formatar data do MySQL para exibi√ß√£o correta
        function formatarDataMySQL(dataString) {
            if (!dataString) return 'N/A';
            
            try {
                // Se a data n√£o tem timezone, assumir que √© hor√°rio local (S√£o Paulo)
                if (dataString.indexOf('T') === -1 && dataString.indexOf('+') === -1 && dataString.indexOf('Z') === -1) {
                    // Adicionar 'T' para formato ISO e tratar como hor√°rio local
                    const isoString = dataString.replace(' ', 'T');
                    const date = new Date(isoString);
                    return date.toLocaleDateString('pt-BR');
                }
                
                const date = new Date(dataString);
                return date.toLocaleDateString('pt-BR');
            } catch (error) {
                console.error('Erro ao formatar data:', error);
                return dataString;
            }
        }
        
        // Fun√ß√£o para formatar data/hora do MySQL para exibi√ß√£o correta
        function formatarDataHoraMySQL(dataString) {
            if (!dataString) return 'N/A';
            
            try {
                // Se a data n√£o tem timezone, assumir que √© hor√°rio local (S√£o Paulo)
                if (dataString.indexOf('T') === -1 && dataString.indexOf('+') === -1 && dataString.indexOf('Z') === -1) {
                    // Adicionar 'T' para formato ISO e tratar como hor√°rio local
                    const isoString = dataString.replace(' ', 'T');
                    const date = new Date(isoString);
                    return date.toLocaleString('pt-BR');
                }
                
                const date = new Date(dataString);
                return date.toLocaleString('pt-BR');
            } catch (error) {
                console.error('Erro ao formatar data/hora:', error);
                return dataString;
            }
        }

        // Fun√ß√£o para abrir a p√°gina de backup/restore
        function abrirBackup() {
            // Verificar se o usu√°rio √© administrador
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            
            if (user.tipo === 'administrador') {
                window.location.href = 'backend/backup.html';
            } else {
                alert('Apenas administradores podem acessar o gerenciamento de backup.');
            }
        }

        // Configura√ß√£o global para jsPDF
        (function() {
            // Fun√ß√£o para verificar se o jsPDF est√° dispon√≠vel
            function verificarJsPDF() {
                // Verificar se est√° dispon√≠vel como m√≥dulo UMD (vers√£o mais recente)
                if (typeof window.jspdf !== 'undefined' && window.jspdf.jsPDF) {
                    console.log('‚úÖ jsPDF carregado via UMD');
                    return true;
                }
                // Verificar se est√° dispon√≠vel globalmente (vers√µes antigas)
                else if (typeof window.jsPDF === 'function') {
                    console.log('‚úÖ jsPDF carregado globalmente');
                    return true;
                }
                // Verificar se est√° dispon√≠vel como vari√°vel global (outro padr√£o)
                else if (typeof jsPDF === 'function') {
                    console.log('‚úÖ jsPDF carregado como vari√°vel global');
                    return true;
                }
                
                console.warn('‚ùå jsPDF n√£o foi carregado corretamente');
                return false;
            }
            
            // Fun√ß√£o para obter a refer√™ncia correta do jsPDF
            function obterJsPDF() {
                if (typeof window.jspdf !== 'undefined' && window.jspdf.jsPDF) {
                    return window.jspdf.jsPDF;
                } else if (typeof window.jsPDF === 'function') {
                    return window.jsPDF;
                } else if (typeof jsPDF === 'function') {
                    return jsPDF;
                }
                throw new Error('jsPDF n√£o est√° dispon√≠vel');
            }
            
            // Expor fun√ß√µes globalmente
            window.verificarJsPDF = verificarJsPDF;
            window.obterJsPDF = obterJsPDF;
            
            // Verificar quando o DOM estiver pronto
            document.addEventListener('DOMContentLoaded', function() {
                if (verificarJsPDF()) {
                    console.log('jsPDF est√° pronto para uso');
                } else {
                    console.warn('jsPDF n√£o est√° dispon√≠vel');
                }
            });
        })();
    </script>
    
    <script src="js/script.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { font-family: Arial, sans-serif; margin: 0; padding: 10px; }
        .header { background: rgba(44, 62, 80, 0.95); backdrop-filter: blur(10px); color: white; padding: 15px; margin-bottom: 20px; border-radius: 5px; display: flex; align-items: center; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .header h1 { margin: 0; font-size: 1.5rem; flex-grow: 1; }
        .header .logo { width: 50px; height: 50px; margin-right: 15px; border-radius: 50%; object-fit: cover; border: 3px solid white; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: transform 0.3s ease; }
        .header .logo:hover { transform: scale(1.05); }
        .menu { display: flex; gap: 5px; margin-bottom: 20px; flex-wrap: wrap; }
        .menu-btn { padding: 8px 15px; background: #f8f9fa; border: 1px solid #ddd; cursor: pointer; border-radius: 5px; font-size: 0.9rem; }
        .menu-btn.active { background: #007bff; color: white; }
        .section { display: none; }
        .section.active { display: block; }
        input, select, button { padding: 8px; margin: 5px; border-radius: 3px; border: 1px solid #ddd; }
        table { width: 100%; border-collapse: collapse; overflow-x: auto; display: block; white-space: nowrap; }
        th, td { padding: 8px; border: 1px solid #ddd; text-align: left; }
        th { background: #f8f9fa; }
        
        /* Responsividade */
        @media (max-width: 768px) {
            body { padding: 5px; }
            .header { padding: 10px; }
            .header h1 { font-size: 1.2rem; }
            .menu { gap: 3px; }
            .menu-btn { padding: 6px 10px; font-size: 0.8rem; }
            input, select, button { padding: 6px; margin: 3px; font-size: 0.9rem; }
            th, td { padding: 6px; font-size: 0.85rem; }
            table { font-size: 0.8rem; }
        }
        
        @media (max-width: 480px) {
            .header h1 { font-size: 1rem; }
            .menu { flex-direction: column; }
            .menu-btn { width: 100%; text-align: center; }
            input, select, button { width: 100%; margin: 2px 0; }
            th, td { padding: 4px; font-size: 0.75rem; }
        }
    </style>
</head>
<body>
    <div class="header">
        <img src="imagem/terrabugio.jpg" alt="Terra do Bugio" class="logo">
        <h1>üìä Painel Terra do Bugio</h1>
        <span id="userInfo"></span>
        <button onclick="logout()" style="background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 4px; margin-left: 10px;">Sair</button>
    </div>

    <div class="menu">
        <button class="menu-btn active" onclick="showSection('frequencia')">üìù Frequ√™ncia</button>
        <button class="menu-btn" onclick="showSection('cadastro')">üë§ Cadastrar Pessoa</button>
        <button class="menu-btn" onclick="showSection('voluntarios')">ü§ù Volunt√°rios</button>
        <button class="menu-btn" onclick="showSection('frequencia_voluntarios')" id="btnFrequenciaVoluntarios" style="display: none;">‚è∞ Frequ√™ncia Volunt√°rios</button>
        <button class="menu-btn" onclick="showSection('relatorios')">üìä Relat√≥rios</button>
        <button class="menu-btn" onclick="showSection('usuarios')">üë• Usu√°rios</button>
        <button class="menu-btn" onclick="showSection('duplicatas')">üîç Duplicatas</button>
        <button class="menu-btn" onclick="abrirBackup()" style="background-color: #28a745; color: white; border-color: #28a745;">üíæ Backup/Restore</button>
        <button class="menu-btn" onclick="showSection('perfil')">üë§ Meu Perfil</button>
    </div>

    <!-- Se√ß√£o Frequ√™ncia -->
    <div id="frequencia" class="section active">
        <h2>üìù Lan√ßar Frequ√™ncia</h2>
        <input type="text" id="buscaPessoa" placeholder="Buscar por nome ou CPF" style="width: 300px;">
        <div id="resultadoBusca"></div>
        
        <div id="formFrequencia" style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa;">
            <h3>Dados da Pessoa</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px; margin-bottom: 20px;">
                <input type="text" id="editNome" placeholder="Nome completo">
                <input type="text" id="editCpf" placeholder="CPF">
                <input type="date" id="editNascimento" placeholder="Data de nascimento">
                <select id="editReligiao">
                    <option value="">Religi√£o</option>
                    <option value="Cat√≥lica">Cat√≥lica</option>
                    <option value="Evang√©lica">Evang√©lica</option>
                    <option value="Esp√≠rita">Esp√≠rita</option>
                    <option value="Espiritualista Livre">Espiritualista Livre</option>
                    <option value="Umbanda">Umbanda</option>
                    <option value="Candombl√©">Candombl√©</option>
                    <option value="Budista">Budista</option>
                    <option value="Judaica">Judaica</option>
                    <option value="Isl√¢mica">Isl√¢mica</option>
                    <option value="Agn√≥stica">Agn√≥stica</option>
                    <option value="Ateia">Ateia</option>
                    <option value="Outras">Outras</option>
                    <option value="N√£o informar">N√£o informar</option>
                </select>
                <select id="editEstado">
                    <option value="">Estado</option>
                    <option value="AC">Acre</option>
                    <option value="AL">Alagoas</option>
                    <option value="AP">Amap√°</option>
                    <option value="AM">Amazonas</option>
                    <option value="BA">Bahia</option>
                    <option value="CE">Cear√°</option>
                    <option value="DF">Distrito Federal</option>
                    <option value="ES">Esp√≠rito Santo</option>
                    <option value="GO">Goi√°s</option>
                    <option value="MA">Maranh√£o</option>
                    <option value="MT">Mato Grosso</option>
                    <option value="MS">Mato Grosso do Sul</option>
                    <option value="MG">Minas Gerais</option>
                    <option value="PA">Par√°</option>
                    <option value="PB">Para√≠ba</option>
                    <option value="PR">Paran√°</option>
                    <option value="PE">Pernambuco</option>
                    <option value="PI">Piau√≠</option>
                    <option value="RJ">Rio de Janeiro</option>
                    <option value="RN">Rio Grande do Norte</option>
                    <option value="RS">Rio Grande do Sul</option>
                    <option value="RO">Rond√¥nia</option>
                    <option value="RR">Roraima</option>
                    <option value="SC">Santa Catarina</option>
                    <option value="SP">S√£o Paulo</option>
                    <option value="SE">Sergipe</option>
                    <option value="TO">Tocantins</option>
                </select>
                <select id="editCidade">
                    <option value="">Selecione primeiro o estado</option>
                </select>
                <input type="tel" id="editTelefone" placeholder="Telefone">
                <input type="email" id="editEmail" placeholder="E-mail">
                <textarea id="editObservacao" placeholder="Observa√ß√µes" rows="3"></textarea>
            </div>
            <button onclick="atualizarPessoa(this)" style="background: #28a745; color: white; margin-bottom: 20px;">Atualizar Dados</button>
            
            <h3>Registrar Frequ√™ncia</h3>
            <div style="margin-bottom: 10px;">
                <label><input type="radio" name="tipo" value="comum" onchange="toggleCamposPet()"> Comum</label>
                <label><input type="radio" name="tipo" value="hospital" onchange="toggleCamposPet()"> Hospital</label>
                <label><input type="radio" name="tipo" value="hospital_acompanhante" onchange="toggleCamposPet()"> Hospital Acompanhante</label>
                <label><input type="radio" name="tipo" value="crianca" onchange="toggleCamposPet()"> Crian√ßa</label>
                <label><input type="radio" name="tipo" value="pet" onchange="toggleCamposPet()"> Pet</label>
            </div>
            
            <!-- Campos normais (para todos os tipos exceto pet) -->
            <div id="camposNormais">
                <input type="number" id="numeroSenha" placeholder="N√∫mero da senha" min="1">
            </div>
            
            <!-- Campos espec√≠ficos para pet -->
            <div id="camposPet" style="display: none;">
                <input type="number" id="numeroSenhaTutor" placeholder="N√∫mero da senha do tutor" min="1">
                <input type="number" id="numeroSenhaPet" placeholder="N√∫mero da senha do pet" min="1">
            </div>
            
            <input type="date" id="dataFrequencia">
            <button onclick="marcarFrequencia(this)">Marcar Frequ√™ncia</button>
        </div>
    </div>

    <!-- Se√ß√£o Cadastro de Pessoa -->
    <div id="cadastro" class="section">
        <h2>üë§ Cadastrar Nova Pessoa</h2>
        
        <div style="max-width: 800px; margin: 0 auto;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <div>
                    <label for="cadastroNome">Nome Completo *</label>
                    <input type="text" id="cadastroNome" placeholder="Nome completo da pessoa" required>
                </div>
                <div>
                    <label for="cadastroCpf">CPF</label>
                    <input type="text" id="cadastroCpf" placeholder="000.000.000-00" maxlength="14">
                </div>
                <div>
                    <label for="cadastroNascimento">Data de Nascimento</label>
                    <input type="date" id="cadastroNascimento">
                </div>
                <div>
                    <label for="cadastroReligiao">Religi√£o</label>
                    <select id="cadastroReligiao">
                        <option value="">Selecione a religi√£o</option>
                        <option value="Cat√≥lica">Cat√≥lica</option>
                        <option value="Evang√©lica">Evang√©lica</option>
                        <option value="Esp√≠rita">Esp√≠rita</option>
                        <option value="Espiritualista Livre">Espiritualista Livre</option>
                        <option value="Umbanda">Umbanda</option>
                        <option value="Candombl√©">Candombl√©</option>
                        <option value="Budista">Budista</option>
                        <option value="Judaica">Judaica</option>
                        <option value="Isl√¢mica">Isl√¢mica</option>
                        <option value="Agn√≥stica">Agn√≥stica</option>
                        <option value="Ateia">Ateia</option>
                        <option value="Outras">Outras</option>
                        <option value="N√£o informar">N√£o informar</option>
                    </select>
                </div>
                <div>
                    <label for="cadastroEstado">Estado</label>
                    <select id="cadastroEstado">
                        <option value="">Selecione o estado</option>
                        <option value="AC">Acre</option>
                        <option value="AL">Alagoas</option>
                        <option value="AP">Amap√°</option>
                        <option value="AM">Amazonas</option>
                        <option value="BA">Bahia</option>
                        <option value="CE">Cear√°</option>
                        <option value="DF">Distrito Federal</option>
                        <option value="ES">Esp√≠rito Santo</option>
                        <option value="GO">Goi√°s</option>
                        <option value="MA">Maranh√£o</option>
                        <option value="MT">Mato Grosso</option>
                        <option value="MS">Mato Grosso do Sul</option>
                        <option value="MG">Minas Gerais</option>
                        <option value="PA">Par√°</option>
                        <option value="PB">Para√≠ba</option>
                        <option value="PR">Paran√°</option>
                        <option value="PE">Pernambuco</option>
                        <option value="PI">Piau√≠</option>
                        <option value="RJ">Rio de Janeiro</option>
                        <option value="RN">Rio Grande do Norte</option>
                        <option value="RS">Rio Grande do Sul</option>
                        <option value="RO">Rond√¥nia</option>
                        <option value="RR">Roraima</option>
                        <option value="SC">Santa Catarina</option>
                        <option value="SP">S√£o Paulo</option>
                        <option value="SE">Sergipe</option>
                        <option value="TO">Tocantins</option>
                    </select>
                </div>
                <div>
                    <label for="cadastroCidade">Cidade</label>
                    <select id="cadastroCidade">
                        <option value="">Selecione primeiro o estado</option>
                    </select>
                </div>
                <div>
                    <label for="cadastroTelefone">Telefone</label>
                    <input type="text" id="cadastroTelefone" placeholder="(00) 00000-0000">
                </div>
                <div>
                    <label for="cadastroEmail">E-mail</label>
                    <input type="email" id="cadastroEmail" placeholder="email@exemplo.com">
                </div>
                <div>
                    <label for="cadastroIndicacao">Como nos conheceu?</label>
                    <select id="cadastroIndicacao">
                        <option value="">Selecione uma op√ß√£o</option>
                        <option value="Amigos/Parentes">Amigos/Parentes</option>
                        <option value="Curso Terra do Bugio">Curso Terra do Bugio</option>
                        <option value="Facebook">Facebook</option>
                        <option value="Instagram">Instagram</option>
                        <option value="Mercado Mistico">Mercado M√≠stico</option>
                        <option value="R√°dio Atual">R√°dio Atual</option>
                        <option value="TV Astral">TV Astral</option>
                        <option value="Youtube">Youtube</option>
                    </select>
                </div>
                <div style="grid-column: 1 / -1;">
                    <label for="cadastroObservacao">Observa√ß√µes</label>
                    <textarea id="cadastroObservacao" placeholder="Observa√ß√µes adicionais" rows="3" style="width: 100%; resize: vertical;"></textarea>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="cadastrarPessoa(this)" style="background: #28a745; color: white; padding: 12px 30px; font-size: 16px; border: none; border-radius: 5px; cursor: pointer;">
                    Cadastrar Pessoa
                </button>
                <button onclick="limparFormularioCadastro()" style="background: #6c757d; color: white; padding: 12px 30px; font-size: 16px; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px;">
                    Limpar Formul√°rio
                </button>
            </div>
            
            <div id="cadastroResultado" style="margin-top: 20px;"></div>
        </div>
    </div>

    <!-- Se√ß√£o Volunt√°rios -->
    <div id="voluntarios" class="section">
        <h2>ü§ù Gerenciar Volunt√°rios</h2>
        
        <div style="margin-bottom: 20px;">
            <button onclick="mostrarModalNovoVoluntario()" style="background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                ‚ûï Novo Volunt√°rio
            </button>
            <input type="text" id="buscaVoluntarios" placeholder="Buscar volunt√°rios por nome, CPF ou e-mail" 
                   style="width: 300px; padding: 8px; margin-right: 10px;">
            <button onclick="buscarVoluntarios()" style="background: #007bff; color: white; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer;">
                üîç Buscar
            </button>
        </div>
        
        <div id="listaVoluntarios">
            <p>Carregando volunt√°rios...</p>
        </div>
    </div>

    <!-- Se√ß√£o Frequ√™ncia de Volunt√°rios -->
    <div id="frequencia_voluntarios" class="section">
        <h2>‚è∞ Lan√ßar Frequ√™ncia de Volunt√°rios</h2>
        <p style="color: #666; margin-bottom: 20px;">
            <i>‚ö†Ô∏è Acesso restrito: Apenas administradores e l√≠deres podem lan√ßar frequ√™ncia de volunt√°rios.</i>
        </p>
        
        <!-- Busca de Volunt√°rio -->
        <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
            <h3>1. Selecionar Volunt√°rio</h3>
            <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                <input type="text" id="buscaVoluntario" placeholder="Buscar volunt√°rio por nome, CPF ou e-mail" 
                       style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <button onclick="buscarVoluntarioFrequencia()" style="background: #007bff; color: white; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer;">
                    üîç Buscar
                </button>
            </div>
            <div id="resultadoBuscaVoluntario"></div>
        </div>
        
        <!-- Formul√°rio de Frequ√™ncia -->
        <div id="formularioFrequenciaVoluntario" style="display: none; padding: 15px; background: #e8f5e8; border-radius: 5px;">
            <h3>2. Registrar Frequ√™ncia</h3>
            <div id="dadosVoluntarioSelecionado" style="margin-bottom: 15px; padding: 10px; background: white; border-radius: 4px; border-left: 4px solid #28a745;"></div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Data do Trabalho:</label>
                    <input type="date" id="dataTrabalhoVoluntario" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Hora de In√≠cio:</label>
                    <input type="time" id="horaInicioVoluntario" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Hora de Fim:</label>
                    <input type="time" id="horaFimVoluntario" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Local de In√≠cio:</label>
                    <select id="localInicioVoluntario" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">Selecione o local de in√≠cio</option>
                        <option value="Recep√ß√£o">Recep√ß√£o</option>
                        <option value="Caf√©">Caf√©</option>
                        <option value="Brech√≥">Brech√≥</option>
                        <option value="Memorial">Memorial</option>
                        <option value="Hospital">Hospital</option>
                        <option value="Pet">Pet</option>
                        <option value="Espa√ßo Crian√ßa">Espa√ßo Crian√ßa</option>
                        <option value="Acolhimento">Acolhimento</option>
                        <option value="Seguran√ßa">Seguran√ßa</option>
                    </select>
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Local de Fim (opcional):</label>
                    <select id="localFimVoluntario" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">Mesmo local de in√≠cio</option>
                        <option value="Recep√ß√£o">Recep√ß√£o</option>
                        <option value="Caf√©">Caf√©</option>
                        <option value="Brech√≥">Brech√≥</option>
                        <option value="Memorial">Memorial</option>
                        <option value="Hospital">Hospital</option>
                        <option value="Pet">Pet</option>
                        <option value="Espa√ßo Crian√ßa">Espa√ßo Crian√ßa</option>
                        <option value="Acolhimento">Acolhimento</option>
                        <option value="Seguran√ßa">Seguran√ßa</option>
                    </select>
                </div>
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Observa√ß√µes (opcional):</label>
                <textarea id="observacoesVoluntario" rows="3" placeholder="Observa√ß√µes sobre o trabalho realizado..." 
                          style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;"></textarea>
            </div>
            
            <div style="text-align: center;">
                <button onclick="registrarFrequenciaVoluntario()" style="background: #28a745; color: white; padding: 12px 30px; font-size: 16px; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                    ‚úÖ Registrar Frequ√™ncia
                </button>
                <button onclick="cancelarFrequenciaVoluntario()" style="background: #6c757d; color: white; padding: 12px 30px; font-size: 16px; border: none; border-radius: 5px; cursor: pointer;">
                    ‚ùå Cancelar
                </button>
            </div>
        </div>
        
        <!-- Hist√≥rico de Frequ√™ncias -->
        <div style="margin-top: 30px;">
            <h3>üìã Frequ√™ncias Recentes</h3>
            <div style="margin-bottom: 15px;">
                <input type="date" id="filtroDataInicioVoluntarios" placeholder="Data in√≠cio" style="margin-right: 10px;">
                <input type="date" id="filtroDataFimVoluntarios" placeholder="Data fim" style="margin-right: 10px;">
                <select id="filtroLocalVoluntarios" style="margin-right: 10px;">
                    <option value="">Todos os locais</option>
                    <option value="Recep√ß√£o">Recep√ß√£o</option>
                    <option value="Caf√©">Caf√©</option>
                    <option value="Brech√≥">Brech√≥</option>
                    <option value="Memorial">Memorial</option>
                    <option value="Hospital">Hospital</option>
                    <option value="Pet">Pet</option>
                    <option value="Espa√ßo Crian√ßa">Espa√ßo Crian√ßa</option>
                    <option value="Acolhimento">Acolhimento</option>
                    <option value="Seguran√ßa">Seguran√ßa</option>
                </select>
                <button onclick="carregarFrequenciasVoluntarios()" style="background: #007bff; color: white; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer;">
                    üîç Filtrar
                </button>
            </div>
            <div id="listaFrequenciasVoluntarios">
                <p>Carregando frequ√™ncias...</p>
            </div>
        </div>
    </div>

    <!-- Se√ß√£o Relat√≥rios -->
    <div id="relatorios" class="section">
        <h2>üìä Relat√≥rios</h2>
        <div style="margin-bottom: 20px;">
            <div style="margin-bottom: 15px;">
                <input type="date" id="dataInicio" placeholder="Data in√≠cio">
                <input type="date" id="dataFim" placeholder="Data fim">
                <select id="filtroTipo">
                    <option value="">Todos os tipos</option>
                    <option value="comum">Comum</option>
                    <option value="hospital">Hospital</option>
                    <option value="hospital_acompanhante">Hospital Acompanhante</option>
                    <option value="crianca">Crian√ßa</option>
                    <option value="pet">Pet</option>
                </select>
            </div>
            <div>
                <button onclick="gerarRelatorio(this)" style="background: #007bff; color: white; margin-right: 10px;">Relat√≥rio Geral</button>
                <button onclick="gerarRelatorioMensal(this)" style="background: #ffc107; color: black; margin-right: 10px;">Relat√≥rio Mensal</button>
                <button onclick="gerarRelatorioPessoasCidades(this)" style="background: #6f42c1; color: white; margin-right: 10px;">Pessoas por Cidade</button>
                <button onclick="gerarRelatorioContatos(this)" style="background: #28a745; color: white; margin-right: 10px;">Relat√≥rio de Contatos</button>
                <button onclick="gerarRelatorioCadastros(this)" style="background: #fd7e14; color: white; margin-right: 10px;">Relat√≥rio de Cadastros</button>
                <button onclick="gerarRelatorioVoluntarios(this)" style="background: #e83e8c; color: white; margin-right: 10px;" id="btnRelatorioVoluntarios">‚è∞ Relat√≥rio Volunt√°rios</button>
            </div>
            
            <!-- Filtros espec√≠ficos para relat√≥rio de volunt√°rios -->
            <div id="filtrosVoluntarios" style="display: none; margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 5px; border-left: 4px solid #e83e8c;">
                <h4 style="margin: 0 0 15px 0; color: #e83e8c;">‚è∞ Filtros para Relat√≥rio de Volunt√°rios</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Local de Trabalho:</label>
                        <select id="filtroLocalVoluntarios" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="">Todos os locais</option>
                            <option value="Recep√ß√£o">Recep√ß√£o</option>
                            <option value="Caf√©">Caf√©</option>
                            <option value="Brech√≥">Brech√≥</option>
                            <option value="Memorial">Memorial</option>
                            <option value="Hospital">Hospital</option>
                            <option value="Pet">Pet</option>
                            <option value="Espa√ßo Crian√ßa">Espa√ßo Crian√ßa</option>
                            <option value="Acolhimento">Acolhimento</option>
                            <option value="Seguran√ßa">Seguran√ßa</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Volunt√°rio Espec√≠fico:</label>
                        <select id="filtroVoluntarioEspecifico" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="">Todos os volunt√°rios</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Per√≠odo:</label>
                        <select id="filtroPeriodoVoluntarios" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="">Personalizado</option>
                            <option value="hoje">Hoje</option>
                            <option value="semana">Esta semana</option>
                            <option value="mes">Este m√™s</option>
                            <option value="trimestre">√öltimo trimestre</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 15px; display: none;" id="botoesExportacao">
                <strong>üì§ Exportar:</strong>
                <button onclick="exportarCSV(this)" style="background: #17a2b8; color: white; margin: 0 5px; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer;">üìÑ CSV</button>
                <button onclick="exportarPDF(this)" style="background: #dc3545; color: white; margin: 0 5px; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer;">üìë PDF</button>
                <button onclick="exportarXLSX(this)" style="background: #28a745; color: white; margin: 0 5px; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer;">üìä XLSX</button>
            </div>
        </div>
        <div id="relatorioResultado"></div>
    </div>

    <!-- Se√ß√£o Usu√°rios -->
    <div id="usuarios" class="section">
        <h2>üë• Gerenciar Usu√°rios</h2>
        <button onclick="mostrarModalNovoUsuario(this)">Novo Usu√°rio</button>
        <div id="usuariosLista"></div>
    </div>

    <!-- Modal Novo Usu√°rio -->
    <div id="modalNovoUsuario" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <h3 style="margin-top: 0; color: #007bff;">üë§ Cadastrar Novo Usu√°rio</h3>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Selecionar Volunt√°rio:</label>
                <select id="selecionarVoluntario" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <option value="">Carregando volunt√°rios...</option>
                </select>
                <small style="color: #666;">Selecione um volunt√°rio para criar o usu√°rio baseado nos seus dados</small>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Nome:</label>
                <input type="text" id="novoUsuarioNome" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" placeholder="Nome completo" readonly>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">E-mail:</label>
                <input type="email" id="novoUsuarioEmail" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" placeholder="email@exemplo.com">
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Senha:</label>
                <input type="password" id="novoUsuarioSenha" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" placeholder="Senha segura">
            </div>
            
            <div style="margin-bottom: 25px;">
                <label style="display: block; margin-bottom: 10px; font-weight: bold;">Tipo de Usu√°rio:</label>
                
                <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; background: #f8f9fa;">
                    <div style="margin-bottom: 15px;">
                        <label style="display: flex; align-items: flex-start; cursor: pointer; padding: 10px; border: 2px solid transparent; border-radius: 8px; transition: all 0.2s;" onmouseover="this.style.borderColor='#007bff'; this.style.background='#e3f2fd'" onmouseout="this.style.borderColor='transparent'; this.style.background='white'">
                            <input type="radio" name="tipoUsuario" value="geral" style="margin-right: 10px; margin-top: 2px;">
                            <div>
                                <div style="font-weight: bold; color: #28a745;">üë§ GERAL</div>
                                <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                                    ‚úÖ Lan√ßar frequ√™ncias<br>
                                    ‚úÖ Atualizar dados de pessoas<br>
                                    ‚ùå N√£o acessa relat√≥rios<br>
                                    ‚ùå N√£o gerencia usu√°rios
                                </div>
                            </div>
                        </label>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: flex; align-items: flex-start; cursor: pointer; padding: 10px; border: 2px solid transparent; border-radius: 8px; transition: all 0.2s;" onmouseover="this.style.borderColor='#007bff'; this.style.background='#e3f2fd'" onmouseout="this.style.borderColor='transparent'; this.style.background='white'">
                            <input type="radio" name="tipoUsuario" value="lider" style="margin-right: 10px; margin-top: 2px;">
                            <div>
                                <div style="font-weight: bold; color: #ffc107;">üë®‚Äçüíº L√çDER</div>
                                <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                                    ‚úÖ Lan√ßar frequ√™ncias<br>
                                    ‚úÖ Atualizar dados de pessoas<br>
                                    ‚úÖ <strong>Acessar relat√≥rios</strong><br>
                                    ‚ùå N√£o gerencia usu√°rios
                                </div>
                            </div>
                        </label>
                    </div>
                    
                    <div>
                        <label style="display: flex; align-items: flex-start; cursor: pointer; padding: 10px; border: 2px solid transparent; border-radius: 8px; transition: all 0.2s;" onmouseover="this.style.borderColor='#007bff'; this.style.background='#e3f2fd'" onmouseout="this.style.borderColor='transparent'; this.style.background='white'">
                            <input type="radio" name="tipoUsuario" value="administrador" style="margin-right: 10px; margin-top: 2px;">
                            <div>
                                <div style="font-weight: bold; color: #dc3545;">üëë ADMINISTRADOR</div>
                                <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                                    ‚úÖ Lan√ßar frequ√™ncias<br>
                                    ‚úÖ Atualizar dados de pessoas<br>
                                    ‚úÖ <strong>Acessar relat√≥rios</strong><br>
                                    ‚úÖ <strong>Gerenciar usu√°rios</strong>
                                </div>
                            </div>
                        </label>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="fecharModalNovoUsuario()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">Cancelar</button>
                <button onclick="salvarNovoUsuario()" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">Criar Usu√°rio</button>
            </div>
        </div>
    </div>

    <!-- Modal Editar Tipo de Usu√°rio -->
    <div id="modalEditarTipoUsuario" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 500px;">
            <h3 style="margin-top: 0; color: #007bff;">‚úèÔ∏è Editar Tipo de Usu√°rio</h3>
            
            <div style="margin-bottom: 20px; padding: 15px; background: #e3f2fd; border-radius: 5px; border-left: 4px solid #007bff;">
                <strong>‚ö†Ô∏è Aten√ß√£o:</strong> Apenas administradores podem alterar o tipo de usu√°rio. Esta a√ß√£o afetar√° as permiss√µes do usu√°rio no sistema.
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Usu√°rio:</label>
                <input type="text" id="editTipoUsuarioNome" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; background: #f8f9fa;" readonly>
            </div>
            
            <div style="margin-bottom: 25px;">
                <label style="display: block; margin-bottom: 10px; font-weight: bold;">Novo Tipo de Usu√°rio:</label>
                
                <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; background: #f8f9fa;">
                    <div style="margin-bottom: 15px;">
                        <label style="display: flex; align-items: flex-start; cursor: pointer; padding: 10px; border: 2px solid transparent; border-radius: 8px; transition: all 0.2s;" onmouseover="this.style.borderColor='#007bff'; this.style.background='#e3f2fd'" onmouseout="this.style.borderColor='transparent'; this.style.background='white'">
                            <input type="radio" name="novoTipoUsuario" value="geral" style="margin-right: 10px; margin-top: 2px;">
                            <div>
                                <div style="font-weight: bold; color: #28a745;">üë§ GERAL</div>
                                <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                                    ‚úÖ Lan√ßar frequ√™ncias<br>
                                    ‚úÖ Atualizar dados de pessoas<br>
                                    ‚ùå N√£o acessa relat√≥rios<br>
                                    ‚ùå N√£o gerencia usu√°rios
                                </div>
                            </div>
                        </label>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: flex; align-items: flex-start; cursor: pointer; padding: 10px; border: 2px solid transparent; border-radius: 8px; transition: all 0.2s;" onmouseover="this.style.borderColor='#007bff'; this.style.background='#e3f2fd'" onmouseout="this.style.borderColor='transparent'; this.style.background='white'">
                            <input type="radio" name="novoTipoUsuario" value="lider" style="margin-right: 10px; margin-top: 2px;">
                            <div>
                                <div style="font-weight: bold; color: #ffc107;">üë®‚Äçüíº L√çDER</div>
                                <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                                    ‚úÖ Lan√ßar frequ√™ncias<br>
                                    ‚úÖ Atualizar dados de pessoas<br>
                                    ‚úÖ <strong>Acessar relat√≥rios</strong><br>
                                    ‚úÖ <strong>Gerenciar volunt√°rios</strong><br>
                                    ‚ùå N√£o gerencia usu√°rios
                                </div>
                            </div>
                        </label>
                    </div>
                    
                    <div>
                        <label style="display: flex; align-items: flex-start; cursor: pointer; padding: 10px; border: 2px solid transparent; border-radius: 8px; transition: all 0.2s;" onmouseover="this.style.borderColor='#007bff'; this.style.background='#e3f2fd'" onmouseout="this.style.borderColor='transparent'; this.style.background='white'">
                            <input type="radio" name="novoTipoUsuario" value="administrador" style="margin-right: 10px; margin-top: 2px;">
                            <div>
                                <div style="font-weight: bold; color: #dc3545;">üëë ADMINISTRADOR</div>
                                <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                                    ‚úÖ <strong>Acesso completo ao sistema</strong><br>
                                    ‚úÖ Gerenciar usu√°rios<br>
                                    ‚úÖ Acessar todos os relat√≥rios<br>
                                    ‚úÖ Configura√ß√µes avan√ßadas
                                </div>
                            </div>
                        </label>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="fecharModalEditarTipoUsuario()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">Cancelar</button>
                <button onclick="salvarTipoUsuario()" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">Salvar Altera√ß√£o</button>
            </div>
        </div>
    </div>

    <!-- Se√ß√£o Meu Perfil -->
    <div id="perfil" class="section">
        <h2>üë§ Meu Perfil</h2>
        
        <div style="max-width: 600px; margin: 0 auto;">
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="margin-top: 0; color: #007bff;">üìã Informa√ß√µes da Conta</h3>
                
                <form id="formPerfil">
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Nome:</label>
                        <input type="text" id="perfilNome" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" required>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">E-mail:</label>
                        <input type="email" id="perfilEmail" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" required>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Tipo de Usu√°rio:</label>
                        <input type="text" id="perfilTipo" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; background: #e9ecef;" readonly>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button type="submit" style="flex: 1; padding: 12px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">
                            üíæ Salvar Altera√ß√µes
                        </button>
                        <button type="button" onclick="cancelarEdicaoPerfil()" style="flex: 1; padding: 12px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            ‚ùå Cancelar
                        </button>
                    </div>
                </form>
            </div>
            
            <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 20px; border-radius: 8px;">
                <h3 style="margin-top: 0; color: #856404;">üîê Alterar Senha</h3>
                
                <form id="formSenha">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Senha Atual:</label>
                        <input type="password" id="senhaAtual" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Nova Senha:</label>
                        <input type="password" id="novaSenha" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Confirmar Nova Senha:</label>
                        <input type="password" id="confirmarNovaSenha" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-bottom: 15px; font-size: 14px; color: #6c757d;">
                        <strong>Dica:</strong> Deixe os campos de senha em branco se n√£o quiser alter√°-la.
                    </div>
                    
                    <button type="submit" style="width: 100%; padding: 12px; background: #ffc107; color: #000; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">
                        üîë Alterar Senha
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Se√ß√£o Duplicatas -->
    <div id="duplicatas" class="section">
        <h2>üîç Gerenciar Duplicatas</h2>
        
        <div style="max-width: 1200px; margin: 0 auto;">
            <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="margin-top: 0; color: #856404;">‚ö†Ô∏è An√°lise de Duplicatas</h3>
                <p>Esta ferramenta identifica pessoas com nomes similares que podem ser duplicatas. <strong>Revise cuidadosamente antes de mesclar!</strong></p>
                <p style="margin-bottom: 0; font-size: 14px; color: #856404;"><strong>üí° Dica:</strong> Ap√≥s realizar mesclagens, execute uma nova an√°lise para ver os resultados atualizados.</p>
                
                <div style="display: flex; gap: 15px; align-items: center; margin-top: 15px;">
                    <label>
                        <strong>Limiar de Similaridade:</strong>
                        <select id="thresholdSimilaridade" style="margin-left: 10px; padding: 5px;">
                            <option value="0.95">95% - Muito restritivo</option>
                            <option value="0.90">90% - Restritivo</option>
                            <option value="0.85" selected>85% - Padr√£o</option>
                            <option value="0.80">80% - Flex√≠vel</option>
                            <option value="0.75">75% - Muito flex√≠vel</option>
                        </select>
                    </label>
                    <button onclick="analisarDuplicatas(this)" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                        üîç Analisar Duplicatas
                    </button>
                </div>
            </div>
            
            <div id="resultadoDuplicatas" style="display: none;">
                <div id="resumoDuplicatas" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;"></div>
                <div id="listaDuplicatas"></div>
            </div>
        </div>
    </div>

    <!-- Modal Novo Volunt√°rio -->
    <div id="modalNovoVoluntario" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <h3 style="margin-top: 0; color: #28a745;">ü§ù Cadastrar Novo Volunt√°rio</h3>
            
            <form id="formNovoVoluntario" style="display: grid; gap: 15px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Nome: *</label>
                    <input type="text" id="voluntarioNome" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">CPF:</label>
                    <input type="text" id="voluntarioCpf" placeholder="000.000.000-00" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Data de Nascimento:</label>
                    <input type="date" id="voluntarioDataNascimento" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Religi√£o:</label>
                    <select id="voluntarioReligiao" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">Selecione a religi√£o</option>
                        <option value="Cat√≥lica">Cat√≥lica</option>
                        <option value="Evang√©lica">Evang√©lica</option>
                        <option value="Esp√≠rita">Esp√≠rita</option>
                        <option value="Espiritualista Livre">Espiritualista Livre</option>
                        <option value="Umbanda">Umbanda</option>
                        <option value="Candombl√©">Candombl√©</option>
                        <option value="Budista">Budista</option>
                        <option value="Judaica">Judaica</option>
                        <option value="Isl√¢mica">Isl√¢mica</option>
                        <option value="Testemunha de Jeov√°">Testemunha de Jeov√°</option>
                        <option value="Adventista">Adventista</option>
                        <option value="Agn√≥stica">Agn√≥stica</option>
                        <option value="Ateia">Ateia</option>
                        <option value="Outras">Outras</option>
                        <option value="N√£o informar">N√£o informar</option>
                    </select>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 10px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Estado:</label>
                        <select id="voluntarioEstado" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="">Selecione</option>
                            <option value="AC">AC</option>
                            <option value="AL">AL</option>
                            <option value="AP">AP</option>
                            <option value="AM">AM</option>
                            <option value="BA">BA</option>
                            <option value="CE">CE</option>
                            <option value="DF">DF</option>
                            <option value="ES">ES</option>
                            <option value="GO">GO</option>
                            <option value="MA">MA</option>
                            <option value="MT">MT</option>
                            <option value="MS">MS</option>
                            <option value="MG">MG</option>
                            <option value="PA">PA</option>
                            <option value="PB">PB</option>
                            <option value="PR">PR</option>
                            <option value="PE">PE</option>
                            <option value="PI">PI</option>
                            <option value="RJ">RJ</option>
                            <option value="RN">RN</option>
                            <option value="RS">RS</option>
                            <option value="RO">RO</option>
                            <option value="RR">RR</option>
                            <option value="SC">SC</option>
                            <option value="SP">SP</option>
                            <option value="SE">SE</option>
                            <option value="TO">TO</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Cidade:</label>
                        <input type="text" id="voluntarioCidade" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">E-mail:</label>
                    <input type="email" id="voluntarioEmail" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                
                <!-- Se√ß√£o de Usu√°rio -->
                <div style="border-top: 2px solid #28a745; padding-top: 15px; margin-top: 15px;">
                    <h4 style="margin: 0 0 15px 0; color: #28a745;">üë§ Dados de Usu√°rio do Sistema</h4>
                    
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">
                            <input type="checkbox" id="criarUsuario" checked style="margin-right: 8px;">
                            Criar usu√°rio do sistema para este volunt√°rio
                        </label>
                        <small style="color: #666;">O volunt√°rio poder√° acessar o sistema com as credenciais criadas</small>
                    </div>
                    
                    <div id="camposUsuario" style="display: grid; gap: 15px; margin-top: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Tipo de Usu√°rio:</label>
                            <select id="tipoUsuario" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="geral">üë§ Geral - Acesso b√°sico ao sistema</option>
                                <option value="lider">üë• L√≠der - Pode gerenciar frequ√™ncias de volunt√°rios</option>
                                <option value="administrador" id="opcaoAdmin" style="display: none;">üîß Administrador - Acesso completo ao sistema</option>
                            </select>
                            <small style="color: #666;" id="infoTipoUsuario">Selecione o n√≠vel de acesso do usu√°rio</small>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Senha Inicial:</label>
                            <input type="text" id="senhaInicial" placeholder="Ser√° gerada automaticamente se deixar vazio" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <small style="color: #666;">Se n√£o informar, ser√° gerada uma senha aleat√≥ria</small>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" onclick="fecharModalVoluntario()" style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">
                        Cancelar
                    </button>
                    <button type="submit" style="background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">
                        Cadastrar Volunt√°rio
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Editar Volunt√°rio -->
    <div id="modalEditarVoluntario" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <h3 style="margin-top: 0; color: #007bff;">‚úèÔ∏è Editar Volunt√°rio</h3>
            
            <form id="formEditarVoluntario" style="display: grid; gap: 15px;">
                <input type="hidden" id="editVoluntarioId">
                
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Nome: *</label>
                    <input type="text" id="editVoluntarioNome" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">CPF:</label>
                    <input type="text" id="editVoluntarioCpf" placeholder="000.000.000-00" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Data de Nascimento:</label>
                    <input type="date" id="editVoluntarioDataNascimento" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Religi√£o:</label>
                    <select id="editVoluntarioReligiao" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">Selecione a religi√£o</option>
                        <option value="Cat√≥lica">Cat√≥lica</option>
                        <option value="Evang√©lica">Evang√©lica</option>
                        <option value="Esp√≠rita">Esp√≠rita</option>
                        <option value="Espiritualista Livre">Espiritualista Livre</option>
                        <option value="Umbanda">Umbanda</option>
                        <option value="Candombl√©">Candombl√©</option>
                        <option value="Budista">Budista</option>
                        <option value="Judaica">Judaica</option>
                        <option value="Isl√¢mica">Isl√¢mica</option>
                        <option value="Testemunha de Jeov√°">Testemunha de Jeov√°</option>
                        <option value="Adventista">Adventista</option>
                        <option value="Agn√≥stica">Agn√≥stica</option>
                        <option value="Ateia">Ateia</option>
                        <option value="Outras">Outras</option>
                        <option value="N√£o informar">N√£o informar</option>
                    </select>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 10px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Estado:</label>
                        <select id="editVoluntarioEstado" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="">Selecione</option>
                            <option value="AC">AC</option>
                            <option value="AL">AL</option>
                            <option value="AP">AP</option>
                            <option value="AM">AM</option>
                            <option value="BA">BA</option>
                            <option value="CE">CE</option>
                            <option value="DF">DF</option>
                            <option value="ES">ES</option>
                            <option value="GO">GO</option>
                            <option value="MA">MA</option>
                            <option value="MT">MT</option>
                            <option value="MS">MS</option>
                            <option value="MG">MG</option>
                            <option value="PA">PA</option>
                            <option value="PB">PB</option>
                            <option value="PR">PR</option>
                            <option value="PE">PE</option>
                            <option value="PI">PI</option>
                            <option value="RJ">RJ</option>
                            <option value="RN">RN</option>
                            <option value="RS">RS</option>
                            <option value="RO">RO</option>
                            <option value="RR">RR</option>
                            <option value="SC">SC</option>
                            <option value="SP">SP</option>
                            <option value="SE">SE</option>
                            <option value="TO">TO</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Cidade:</label>
                        <input type="text" id="editVoluntarioCidade" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">E-mail:</label>
                    <input type="email" id="editVoluntarioEmail" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" onclick="fecharModalEditarVoluntario()" style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">
                        Cancelar
                    </button>
                    <button type="submit" style="background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">
                        Salvar Altera√ß√µes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Mesclagem -->
    <div id="modalMesclagem" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <h3 style="margin-top: 0; color: #dc3545;">‚ö†Ô∏è Confirmar Mesclagem de Cadastros</h3>
            
            <div id="conteudoMesclagem"></div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button onclick="fecharModalMesclagem()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">Cancelar</button>
                <button onclick="confirmarMesclagem()" style="padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">üîÑ Confirmar Mesclagem</button>
            </div>
        </div>
    </div>

    <script>
        // FUN√á√ïES ESSENCIAIS DEFINIDAS PRIMEIRO (antes de qualquer verifica√ß√£o)
        
        // Fun√ß√£o para mostrar se√ß√µes (global) - DEVE estar dispon√≠vel imediatamente
        window.showSection = function(sectionId) {
            try {
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('active'));
                
                document.getElementById(sectionId).classList.add('active');
                if (event && event.target) {
                    event.target.classList.add('active');
                }
                
                // Carregar dados espec√≠ficos da se√ß√£o (se usu√°rio estiver logado)
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                if (user.id) {
                    if (sectionId === 'usuarios' && user.tipo === 'administrador') {
                        carregarUsuarios();
                    } else if (sectionId === 'voluntarios' && (user.tipo === 'administrador' || user.tipo === 'lider')) {
                        carregarVoluntarios();
                    } else if (sectionId === 'perfil') {
                        carregarPerfil();
                    } else if (sectionId === 'duplicatas' && user.tipo === 'administrador') {
                        console.log('Se√ß√£o de duplicatas carregada para administrador');
                    } else if (sectionId === 'frequencia_voluntarios') {
                        carregarFrequenciasVoluntarios();
                    }
                }
            } catch (error) {
                console.error('Erro em showSection:', error);
            }
        };
        
        // Fun√ß√£o de logout (global) - DEVE estar dispon√≠vel imediatamente
        window.logout = function() {
            try {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = 'login.html';
            } catch (error) {
                console.error('Erro em logout:', error);
                window.location.href = 'login.html';
            }
        };
        
        // Fun√ß√£o para carregar volunt√°rios para filtro (global)
        window.carregarVoluntariosParaFiltro = async function() {
            try {
                const token = localStorage.getItem('token');
                if (!token) return; // N√£o carregar se n√£o estiver autenticado
                
                const response = await fetch('/api/voluntarios', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const voluntarios = data.voluntarios || [];
                    
                    const select = document.getElementById('filtroVoluntarioEspecifico');
                    if (select) {
                        select.innerHTML = '<option value="">Todos os volunt√°rios</option>';
                        
                        voluntarios.forEach(voluntario => {
                            const option = document.createElement('option');
                            option.value = voluntario.id;
                            option.textContent = voluntario.nome;
                            select.appendChild(option);
                        });
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar volunt√°rios para filtro:', error);
            }
        };
        
        // Fun√ß√£o para carregar usu√°rios (global)
        window.carregarUsuarios = async function() {
            try {
                const token = localStorage.getItem('token');
                if (!token) return;
                
                console.log('Carregando usu√°rios...');
                const response = await fetch('/api/usuarios', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const usuarios = data.usuarios || [];
                    
                    const container = document.getElementById('listaUsuarios');
                    if (container) {
                        if (usuarios.length === 0) {
                            container.innerHTML = '<p>Nenhum usu√°rio encontrado.</p>';
                        } else {
                            container.innerHTML = usuarios.map(usuario => `
                                <div class="usuario-item" style="border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px;">
                                    <h4>${usuario.nome}</h4>
                                    <p><strong>Email:</strong> ${usuario.email}</p>
                                    <p><strong>Tipo:</strong> ${usuario.tipo}</p>
                                    <p><strong>Status:</strong> ${usuario.ativo ? 'Ativo' : 'Inativo'}</p>
                                    <button onclick="editarTipoUsuario(${usuario.id}, '${usuario.tipo}')" style="margin-right: 10px;">Editar Tipo</button>
                                    <button onclick="resetarSenhaUsuario(${usuario.id})" style="margin-right: 10px;">Reset Senha</button>
                                    <button onclick="toggleStatusUsuario(${usuario.id}, ${usuario.ativo})">${usuario.ativo ? 'Desativar' : 'Ativar'}</button>
                                </div>
                            `).join('');
                        }
                    }
                } else {
                    console.error('Erro ao carregar usu√°rios:', response.status);
                }
            } catch (error) {
                console.error('Erro ao carregar usu√°rios:', error);
            }
        };
        
        // Fun√ß√£o para carregar volunt√°rios (global)
        window.carregarVoluntarios = async function(busca = '') {
            try {
                const token = localStorage.getItem('token');
                if (!token) return;
                
                const url = busca ? `/api/voluntarios?busca=${encodeURIComponent(busca)}` : '/api/voluntarios';
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const voluntarios = data.voluntarios || [];
                    
                    const container = document.getElementById('listaVoluntarios');
                    if (container) {
                        if (voluntarios.length === 0) {
                            container.innerHTML = '<p>Nenhum volunt√°rio encontrado.</p>';
                        } else {
                            container.innerHTML = voluntarios.map(voluntario => `
                                <div class="voluntario-item" style="border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px;">
                                    <h4>${voluntario.nome}</h4>
                                    <p><strong>Email:</strong> ${voluntario.email || 'N√£o informado'}</p>
                                    <p><strong>CPF:</strong> ${voluntario.cpf || 'N√£o informado'}</p>
                                    <p><strong>Cidade:</strong> ${voluntario.cidade || 'N√£o informado'}</p>
                                    <button onclick="editarVoluntario(${voluntario.id})">Editar</button>
                                </div>
                            `).join('');
                        }
                    }
                } else {
                    console.error('Erro ao carregar volunt√°rios:', response.status);
                }
            } catch (error) {
                console.error('Erro ao carregar volunt√°rios:', error);
            }
        };
        
        // Fun√ß√£o para carregar perfil (global)
        window.carregarPerfil = function() {
            try {
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                const nomeElement = document.getElementById('perfilNome');
                const emailElement = document.getElementById('perfilEmail');
                const tipoElement = document.getElementById('perfilTipo');
                
                if (nomeElement) nomeElement.value = user.nome || '';
                if (emailElement) emailElement.value = user.email || '';
                if (tipoElement) tipoElement.value = user.tipo ? user.tipo.toUpperCase() : '';
            } catch (error) {
                console.error('Erro ao carregar perfil:', error);
            }
        };
        
        // Fun√ß√£o para carregar frequ√™ncias de volunt√°rios (global)
        window.carregarFrequenciasVoluntarios = async function() {
            try {
                const token = localStorage.getItem('token');
                if (!token) return;
                
                const container = document.getElementById('listaFrequenciasVoluntarios');
                if (container) {
                    container.innerHTML = '<p>Carregando frequ√™ncias...</p>';
                    
                    const response = await fetch('/api/frequencia_voluntarios?limit=20', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        const frequencias = data.frequencias || [];
                        
                        if (frequencias.length === 0) {
                            container.innerHTML = '<p>Nenhuma frequ√™ncia encontrada.</p>';
                        } else {
                            container.innerHTML = frequencias.map(freq => `
                                <div class="frequencia-item" style="border: 1px solid #ddd; padding: 10px; margin: 5px 0; border-radius: 5px;">
                                    <strong>${freq.voluntario_nome}</strong> - ${freq.data_trabalho}
                                    <br>Hor√°rio: ${freq.hora_inicio} √†s ${freq.hora_fim || 'Em andamento'}
                                    <br>Local: ${freq.local_inicio}
                                </div>
                            `).join('');
                        }
                    } else {
                        container.innerHTML = '<p>Erro ao carregar frequ√™ncias.</p>';
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar frequ√™ncias de volunt√°rios:', error);
                const container = document.getElementById('listaFrequenciasVoluntarios');
                if (container) {
                    container.innerHTML = '<p>Erro ao carregar frequ√™ncias.</p>';
                }
            }
        };
        
        // Vari√°veis globais
        let token = localStorage.getItem('token');
        let user = JSON.parse(localStorage.getItem('user') || '{}');
        let pessoaSelecionada = null;
        let pessoasEncontradas = [];
        
        // Fun√ß√£o para atualizar token do localStorage
        function atualizarToken() {
            const novoToken = localStorage.getItem('token');
            if (novoToken !== token) {
                token = novoToken;
                console.log('Token atualizado do localStorage');
            }
        }
        
        // Fun√ß√µes auxiliares para loading nos bot√µes
        function setButtonLoading(button, loading = true) {
            if (typeof button === 'string') {
                button = document.querySelector(button);
            }
            
            if (!button) return;
            
            if (loading) {
                button.dataset.originalText = button.innerHTML;
                button.dataset.originalDisabled = button.disabled;
                button.innerHTML = '‚è≥ Processando...';
                button.disabled = true;
                button.style.opacity = '0.7';
                button.style.cursor = 'not-allowed';
            } else {
                if (button.dataset.originalText) {
                    button.innerHTML = button.dataset.originalText;
                }
                button.disabled = button.dataset.originalDisabled === 'true';
                button.style.opacity = '1';
                button.style.cursor = 'pointer';
            }
        }
        
        function withButtonLoading(buttonSelector, asyncFunction) {
            return async function(...args) {
                const button = typeof buttonSelector === 'string' ? 
                    document.querySelector(buttonSelector) : buttonSelector;
                
                try {
                    setButtonLoading(button, true);
                    await asyncFunction.apply(this, args);
                } finally {
                    setButtonLoading(button, false);
                }
            };
        }

        // Fun√ß√£o para alternar campos de pet
        function toggleCamposPet() {
            const tipoSelecionado = document.querySelector('input[name="tipo"]:checked')?.value;
            const camposNormais = document.getElementById('camposNormais');
            const camposPet = document.getElementById('camposPet');
            
            if (tipoSelecionado === 'pet') {
                camposNormais.style.display = 'none';
                camposPet.style.display = 'block';
                // Limpar campo normal
                document.getElementById('numeroSenha').value = '';
            } else {
                camposNormais.style.display = 'block';
                camposPet.style.display = 'none';
                // Limpar campos de pet
                document.getElementById('numeroSenhaTutor').value = '';
                document.getElementById('numeroSenhaPet').value = '';
            }
        }

        // Verificar autentica√ß√£o e executar resto do c√≥digo apenas se v√°lido
        if (token && user && user.id) {
            // Verificar se precisa trocar senha (converter para boolean se necess√°rio)
            const deveTrocarSenha = user.deve_trocar_senha === 1 || user.deve_trocar_senha === '1' || user.deve_trocar_senha === true;
            if (deveTrocarSenha) {
                console.log('Redirecionando para troca de senha obrigat√≥ria');
                window.location.href = 'trocar-senha.html';
            } else {
                // Usu√°rio autenticado e n√£o precisa trocar senha - continuar execu√ß√£o normal

        // Verificar permiss√µes para frequ√™ncia de volunt√°rios ap√≥s autentica√ß√£o
        try {
            const btnFrequenciaVoluntarios = document.getElementById('btnFrequenciaVoluntarios');
            if (btnFrequenciaVoluntarios) {
                if (user.tipo === 'administrador' || user.tipo === 'lider') {
                    btnFrequenciaVoluntarios.style.display = 'inline-block';
                    console.log('Bot√£o de frequ√™ncia de volunt√°rios habilitado para:', user.tipo);
                } else {
                    btnFrequenciaVoluntarios.style.display = 'none';
                    console.log('Bot√£o de frequ√™ncia de volunt√°rios oculto para:', user.tipo);
                }
            } else {
                console.warn('Elemento btnFrequenciaVoluntarios n√£o encontrado');
            }
        } catch (error) {
            console.error('Erro ao verificar permiss√µes de frequ√™ncia de volunt√°rios:', error);
        }

        // Mostrar info do usu√°rio
        try {
            document.getElementById('userInfo').textContent = `${user.nome || 'Usu√°rio'} (${user.tipo || 'N/A'})`;
        } catch (error) {
            console.error('Erro ao mostrar info do usu√°rio:', error);
            document.getElementById('userInfo').textContent = 'Usu√°rio';
        }

        // Definir data atual
        try {
            const dataElement = document.getElementById('dataFrequencia');
            if (dataElement) {
                dataElement.value = new Date().toISOString().split('T')[0];
            }
        } catch (error) {
            console.error('Erro ao definir data atual:', error);
        }

        // Fun√ß√£o showSection j√° definida no in√≠cio do script - removendo duplicata

        // Buscar pessoas
        let timeoutBusca;
        
        document.getElementById('buscaPessoa').addEventListener('input', function() {
            clearTimeout(timeoutBusca);
            timeoutBusca = setTimeout(buscarPessoas, 300);
        });

        async function buscarPessoas() {
            const termo = document.getElementById('buscaPessoa').value;
            const resultado = document.getElementById('resultadoBusca');
            
            // Atualizar token do localStorage
            atualizarToken();
            
            console.log('Buscando por:', termo);
            console.log('Token atual:', token ? 'Existe' : 'N√£o existe');
            console.log('Token (primeiros 30 chars):', token ? token.substring(0, 30) + '...' : 'N/A');
            
            if (termo.length < 2) {
                resultado.innerHTML = '';
                return;
            }
            
            if (!token) {
                resultado.innerHTML = '<p style="color: red; padding: 10px;">‚ùå Token n√£o encontrado. Fa√ßa login novamente.</p>';
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
                return;
            }
            
            resultado.innerHTML = '<p style="padding: 10px; color: #666;">Buscando...</p>';
            
            try {
                const url = `/api/pessoas?busca=${encodeURIComponent(termo)}`;
                console.log('URL:', url);
                console.log('Enviando header Authorization:', `Bearer ${token.substring(0, 30)}...`);
                
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                console.log('Status da resposta:', response.status);
                
                if (!response.ok) {
                    if (response.status === 401) {
                        alert('Sess√£o expirada. Voc√™ ser√° redirecionado para o login.');
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        window.location.href = 'login.html';
                        return;
                    }
                    throw new Error(`Erro ${response.status}: ${response.statusText}`);
                }
                
                const pessoas = await response.json();
                console.log('Pessoas encontradas:', pessoas.length);
                
                // Armazenar resultados para uso posterior
                pessoasEncontradas = pessoas;
                
                if (pessoas.length === 0) {
                    resultado.innerHTML = '<p style="padding: 10px; color: #666;">Nenhuma pessoa encontrada</p>';
                    return;
                }
                
                resultado.innerHTML = pessoas.slice(0, 10).map((p, index) => `
                    <div data-index="${index}" class="pessoa-resultado" style="padding: 10px; border: 1px solid #ddd; margin: 2px 0; cursor: pointer; background: white; transition: all 0.2s;">
                        <strong>${p.nome}</strong><br>
                        <small>CPF: ${p.cpf || 'N/A'} | ${p.cidade || 'N/A'}/${p.estado || 'N/A'}</small>
                    </div>
                `).join('');
                
                // Adicionar event listeners para os resultados
                document.querySelectorAll('.pessoa-resultado').forEach(div => {
                    div.addEventListener('click', function() {
                        const index = parseInt(this.dataset.index);
                        selecionarPessoa(index);
                    });
                    
                    div.addEventListener('mouseover', function() {
                        this.style.backgroundColor = '#f0f0f0';
                    });
                    
                    div.addEventListener('mouseout', function() {
                        this.style.backgroundColor = 'white';
                    });
                });
                
            } catch (error) {
                console.error('Erro na busca:', error);
                resultado.innerHTML = `<p style="color: red; padding: 10px;">Erro: ${error.message}<br><small>Verifique se o servidor est√° rodando</small></p>`;
            }
        }

        function selecionarPessoa(index) {
            console.log('Selecionando pessoa √≠ndice:', index);
            console.log('Total de pessoas encontradas:', pessoasEncontradas.length);
            
            if (index >= 0 && index < pessoasEncontradas.length) {
                const pessoa = pessoasEncontradas[index];
                console.log('Pessoa selecionada:', pessoa);
                
                pessoaSelecionada = pessoa;
                
                try {
                    // Preencher campos de edi√ß√£o
                    console.log('Preenchendo campos...');
                    document.getElementById('editNome').value = pessoa.nome || '';
                    document.getElementById('editCpf').value = pessoa.cpf || '';
                    document.getElementById('editNascimento').value = pessoa.nascimento || '';
                    document.getElementById('editReligiao').value = pessoa.religiao || '';
                    document.getElementById('editEstado').value = pessoa.estado || '';
                    
                    // Carregar cidades do estado e depois selecionar a cidade
                    if (pessoa.estado) {
                        carregarCidades('editCidade', pessoa.estado);
                        // Aguardar um pouco para as cidades carregarem antes de selecionar
                        setTimeout(() => {
                            document.getElementById('editCidade').value = pessoa.cidade || '';
                        }, 100);
                    } else {
                        document.getElementById('editCidade').value = pessoa.cidade || '';
                    }
                    
                    document.getElementById('editTelefone').value = pessoa.telefone || '';
                    document.getElementById('editEmail').value = pessoa.email || '';
                    console.log('Campos preenchidos com sucesso');
                    
                    // Mostrar formul√°rio
                    console.log('Mostrando formul√°rio...');
                    document.getElementById('formFrequencia').style.display = 'block';
                    document.getElementById('resultadoBusca').innerHTML = '';
                    document.getElementById('buscaPessoa').value = pessoa.nome;
                    console.log('Formul√°rio exibido com sucesso');
                    
                    // Scroll para o formul√°rio
                    document.getElementById('formFrequencia').scrollIntoView({ behavior: 'smooth' });
                    
                } catch (error) {
                    console.error('Erro ao processar sele√ß√£o:', error);
                    alert('Erro ao selecionar pessoa: ' + error.message);
                }
            } else {
                console.error('Pessoa n√£o encontrada no √≠ndice:', index);
                console.error('√çndice:', index, 'Total:', pessoasEncontradas.length);
                alert('Erro ao selecionar pessoa');
            }
        }

        async function marcarFrequencia(button) {
            if (!pessoaSelecionada) {
                alert('Selecione uma pessoa');
                return;
            }
            
            const tipo = document.querySelector('input[name="tipo"]:checked')?.value;
            const data = document.getElementById('dataFrequencia').value;
            
            if (!tipo || !data) {
                alert('Selecione o tipo de frequ√™ncia e a data');
                return;
            }
            
            // Preparar dados da frequ√™ncia baseado no tipo
            let dadosFrequencia = {
                pessoaId: pessoaSelecionada.id,
                tipo,
                data
            };
            
            if (tipo === 'pet') {
                // Para pet, precisamos das duas senhas
                const numeroSenhaTutor = document.getElementById('numeroSenhaTutor').value;
                const numeroSenhaPet = document.getElementById('numeroSenhaPet').value;
                
                if (!numeroSenhaTutor || !numeroSenhaPet) {
                    alert('Para tipo Pet, preencha ambas as senhas (tutor e pet)');
                    return;
                }
                
                dadosFrequencia.numeroSenhaTutor = numeroSenhaTutor;
                dadosFrequencia.numeroSenhaPet = numeroSenhaPet;
                dadosFrequencia.numeroSenha = `${numeroSenhaTutor}/${numeroSenhaPet}`; // Para compatibilidade com backend
            } else {
                // Para outros tipos, usar campo normal
                const numeroSenha = document.getElementById('numeroSenha').value;
                
                if (!numeroSenha) {
                    alert('Preencha o n√∫mero da senha');
                    return;
                }
                
                dadosFrequencia.numeroSenha = numeroSenha;
            }
            
            setButtonLoading(button, true);
            
            try {
                const response = await fetch('/api/frequencias', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json; charset=utf-8',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(dadosFrequencia)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // Criar div de notifica√ß√£o personalizada
                    const notification = document.createElement('div');
                    notification.innerHTML = '‚úÖ Frequ√™ncia registrada com sucesso!';
                    notification.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #28a745;
                        color: white;
                        padding: 15px 20px;
                        border-radius: 5px;
                        font-weight: bold;
                        z-index: 1000;
                        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                    `;
                    document.body.appendChild(notification);
                    
                    // Remover ap√≥s 4 segundos
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 4000);
                    
                    console.log('Frequ√™ncia registrada:', result.frequencia);
                    limparFormulario();
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    const errorMessage = errorData.error || `Erro ${response.status}: ${response.statusText}`;
                    
                    if (response.status === 401) {
                        alert('Sess√£o expirada. Voc√™ ser√° redirecionado para o login.');
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        window.location.href = 'login.html';
                        return;
                    }
                    
                    if (response.status === 409) {
                        alert('‚ö†Ô∏è J√° existe frequ√™ncia registrada para esta pessoa nesta data!');
                    } else {
                        alert(`Erro ao registrar frequ√™ncia: ${errorMessage}`);
                    }
                }
            } catch (error) {
                console.error('Erro ao registrar frequ√™ncia:', error);
                alert('Erro de conex√£o: ' + error.message);
            } finally {
                setButtonLoading(button, false);
            }
        }

        function limparFormulario() {
            document.getElementById('formFrequencia').style.display = 'none';
            document.getElementById('buscaPessoa').value = '';
            pessoaSelecionada = null;
            
            // Limpar campos de edi√ß√£o
            document.getElementById('editNome').value = '';
            document.getElementById('editCpf').value = '';
            document.getElementById('editNascimento').value = '';
            document.getElementById('editReligiao').value = '';
            document.getElementById('editCidade').value = '';
            document.getElementById('editEstado').value = '';
            document.getElementById('editTelefone').value = '';
            document.getElementById('editEmail').value = '';
            
            // Limpar campos de frequ√™ncia
            document.querySelectorAll('input[name="tipo"]').forEach(r => r.checked = false);
            document.getElementById('numeroSenha').value = '';
            document.getElementById('numeroSenhaTutor').value = '';
            document.getElementById('numeroSenhaPet').value = '';
            document.getElementById('dataFrequencia').value = new Date().toISOString().split('T')[0];
            
            // Resetar visibilidade dos campos
            document.getElementById('camposNormais').style.display = 'block';
            document.getElementById('camposPet').style.display = 'none';
        }

        async function gerarRelatorio(button) {
            setButtonLoading(button, true);
            
            // Ocultar filtros espec√≠ficos de volunt√°rios
            document.getElementById('filtrosVoluntarios').style.display = 'none';
            
            const dataInicio = document.getElementById('dataInicio').value;
            const dataFim = document.getElementById('dataFim').value;
            const tipo = document.getElementById('filtroTipo').value;
            
            let url = '/api/frequencias?';
            if (dataInicio) url += `dataInicio=${dataInicio}&`;
            if (dataFim) url += `dataFim=${dataFim}&`;
            if (tipo) url += `tipo=${tipo}&`;
            
            try {
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        alert('Sess√£o expirada. Voc√™ ser√° redirecionado para o login.');
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        window.location.href = 'login.html';
                        return;
                    }
                    throw new Error(`Erro ${response.status}: ${response.statusText}`);
                }
                
                const frequencias = await response.json();
                
                // Calcular estat√≠sticas
                const tipoStats = {};
                const pessoasUnicas = new Set();
                
                frequencias.forEach(f => {
                    // Normalizar tipo para evitar duplicatas
                    const tipoNormalizado = f.tipo.toLowerCase().trim();
                    tipoStats[tipoNormalizado] = (tipoStats[tipoNormalizado] || 0) + 1;
                    pessoasUnicas.add(f.pessoa_id);
                });
                
                // Usar per√≠odo selecionado pelo usu√°rio, n√£o das frequ√™ncias retornadas
                let periodo = 'Per√≠odo completo';
                if (dataInicio && dataFim) {
                    const dataInicioFormatada = new Date(dataInicio).toLocaleDateString('pt-BR');
                    const dataFimFormatada = new Date(dataFim).toLocaleDateString('pt-BR');
                    periodo = `${dataInicioFormatada} a ${dataFimFormatada}`;
                } else if (dataInicio) {
                    const dataInicioFormatada = new Date(dataInicio).toLocaleDateString('pt-BR');
                    periodo = `A partir de ${dataInicioFormatada}`;
                } else if (dataFim) {
                    const dataFimFormatada = new Date(dataFim).toLocaleDateString('pt-BR');
                    periodo = `At√© ${dataFimFormatada}`;
                }
                
                document.getElementById('relatorioResultado').innerHTML = `
                    <h3>üìã Relat√≥rio Geral</h3>
                    
                    <!-- Resumo Estat√≠stico -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin-top: 0; color: #007bff;">üìä Resumo Estat√≠stico</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                            <div style="background: white; padding: 15px; border-radius: 5px; text-align: center; border-left: 4px solid #007bff;">
                                <div style="font-size: 24px; font-weight: bold; color: #007bff;">${frequencias.length}</div>
                                <div style="color: #666;">Total de Frequ√™ncias</div>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 5px; text-align: center; border-left: 4px solid #28a745;">
                                <div style="font-size: 24px; font-weight: bold; color: #28a745;">${pessoasUnicas.size}</div>
                                <div style="color: #666;">Pessoas Diferentes</div>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 5px; text-align: center; border-left: 4px solid #ffc107;">
                                <div style="font-size: 24px; font-weight: bold; color: #ffc107;">${(frequencias.length / pessoasUnicas.size).toFixed(1)}</div>
                                <div style="color: #666;">Frequ√™ncias por Pessoa</div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <strong>üìÖ Per√≠odo Selecionado:</strong> ${periodo}
                            ${frequencias.length === 0 ? '<br><span style="color: #dc3545; font-size: 14px;">‚ö†Ô∏è Nenhuma frequ√™ncia encontrada no per√≠odo selecionado</span>' : ''}
                        </div>
                        
                        <div>
                            <strong>üìà Por Tipo de Presen√ßa:</strong>
                            <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 8px;">
                                ${Object.entries(tipoStats).map(([tipo, count]) => `
                                    <span style="background: ${getTipoColor(tipo)}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px;">
                                        ${tipo.toUpperCase().replace('_', ' ')}: ${count}
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tabela Detalhada -->
                    <h4>üìã Registros Detalhados (${frequencias.length} registros)</h4>
                    <table>
                        <thead>
                            <tr style="background: #007bff; color: white;">
                                <th>N¬∫ | Nome</th>
                                <th>Tipo</th>
                                <th>Senha</th>
                                <th>Data</th>
                                <th>Registrado em</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${frequencias.map((f, index) => `
                                <tr>
                                    <td><strong>${index + 1}</strong> ${f.pessoa_nome || 'Nome n√£o encontrado'}</td>
                                    <td><span style="background: ${getTipoColor(f.tipo.toLowerCase())}; color: white; padding: 3px 8px; border-radius: 10px; font-size: 12px;">${f.tipo.toUpperCase().replace('_', ' ')}</span></td>
                                    <td>${f.numero_senha || f.numero_senha === 0 ? f.numero_senha : 'N/A'}</td>
                                    <td>${formatarDataMySQL(f.data)}</td>
                                    <td>${formatarDataHoraMySQL(f.created_at)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
                document.getElementById('botoesExportacao').style.display = 'block';
                // Armazenar dados do relat√≥rio atual para exporta√ß√£o
                window.relatorioAtual = {
                    tipo: 'Relat√≥rio Geral',
                    dados: frequencias,
                    filtros: { dataInicio, dataFim, tipo }
                };
            } catch (error) {
                console.error('Erro ao gerar relat√≥rio:', error);
                document.getElementById('relatorioResultado').innerHTML = `<p style="color: red;">Erro ao gerar relat√≥rio: ${error.message}</p>`;
            } finally {
                setButtonLoading(button, false);
            }
        }

        async function gerarRelatorioMensal(button) {
            setButtonLoading(button, true);
            
            // Ocultar filtros espec√≠ficos de volunt√°rios
            document.getElementById('filtrosVoluntarios').style.display = 'none';
            
            try {
                const response = await fetch('/api/frequencias', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        alert('Sess√£o expirada. Voc√™ ser√° redirecionado para o login.');
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        window.location.href = 'login.html';
                        return;
                    }
                    throw new Error(`Erro ${response.status}: ${response.statusText}`);
                }
                
                const frequencias = await response.json();
                
                // Agrupar por m√™s/ano (apenas ano corrente)
                const anoCorrente = new Date().getFullYear();
                const mesStats = {};
                
                // Inicializar todos os meses do ano corrente
                for (let mes = 1; mes <= 12; mes++) {
                    const mesAno = `${String(mes).padStart(2, '0')}/${anoCorrente}`;
                    mesStats[mesAno] = { total: 0, tipos: {}, pessoas: new Set() };
                }
                
                frequencias.forEach(f => {
                    const data = new Date(f.data);
                    
                    // Filtrar apenas o ano corrente
                    if (data.getFullYear() === anoCorrente) {
                        const mesAno = `${String(data.getMonth() + 1).padStart(2, '0')}/${data.getFullYear()}`;
                        
                        mesStats[mesAno].total++;
                        mesStats[mesAno].tipos[f.tipo] = (mesStats[mesAno].tipos[f.tipo] || 0) + 1;
                        mesStats[mesAno].pessoas.add(f.pessoa_id);
                    }
                });
                
                const meses = Object.entries(mesStats)
                    .sort((a, b) => {
                        const [mesA] = a[0].split('/');
                        const [mesB] = b[0].split('/');
                        return parseInt(mesA) - parseInt(mesB);
                    });
                
                document.getElementById('relatorioResultado').innerHTML = `
                    <h3>üìÖ Relat√≥rio Mensal ${anoCorrente} (${meses.length} meses)</h3>
                    <table>
                        <thead>
                            <tr style="background: #ffc107; color: black;">
                                <th>M√™s/Ano</th>
                                <th>Total</th>
                                <th>Pessoas</th>
                                <th>Comum</th>
                                <th>Hospital</th>
                                <th>Acompanhante</th>
                                <th>Crian√ßa</th>
                                <th>Pet</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${meses.map(([mes, stats]) => `
                                <tr>
                                    <td style="font-weight: bold;">${mes}</td>
                                    <td style="text-align: center; font-weight: bold;">${stats.total}</td>
                                    <td style="text-align: center;">${stats.pessoas.size}</td>
                                    <td style="text-align: center;">${stats.tipos.comum || 0}</td>
                                    <td style="text-align: center;">${stats.tipos.hospital || 0}</td>
                                    <td style="text-align: center;">${stats.tipos.hospital_acompanhante || 0}</td>
                                    <td style="text-align: center;">${stats.tipos.crianca || 0}</td>
                                    <td style="text-align: center;">${(stats.tipos.pet_tutor || 0) + (stats.tipos.pet_animal || 0) + (stats.tipos.pet || 0)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
                document.getElementById('botoesExportacao').style.display = 'block';
                // Armazenar dados do relat√≥rio atual para exporta√ß√£o
                window.relatorioAtual = {
                    tipo: 'Relat√≥rio Mensal',
                    dados: frequencias,
                    filtros: {}
                };
            } catch (error) {
                console.error('Erro ao gerar relat√≥rio mensal:', error);
                document.getElementById('relatorioResultado').innerHTML = `<p style="color: red;">Erro ao gerar relat√≥rio mensal: ${error.message}</p>`;
            } finally {
                setButtonLoading(button, false);
            }
        }

        function getTipoColor(tipo) {
            const colors = {
                'comum': '#28a745',
                'hospital': '#dc3545',
                'hospital_acompanhante': '#ffc107',
                'crianca': '#17a2b8',
                'pet': '#6f42c1',
                'pet_tutor': '#6f42c1',
                'pet_animal': '#fd7e14'
            };
            return colors[tipo] || '#6c757d';
        }

        function normalizarCidade(cidade) {
            if (!cidade) return cidade;
            return cidade
                .replace(/S\?o/g, 'S√£o')
                .replace(/S\?O/g, 'S√ÉO')
                .replace(/a\?o/g, '√£o')
                .replace(/A\?O/g, '√ÉO');
        }

        async function gerarRelatorioContatos(button) {
            setButtonLoading(button, true);
            
            // Ocultar filtros espec√≠ficos de volunt√°rios
            document.getElementById('filtrosVoluntarios').style.display = 'none';
            try {
                // Usar os mesmos filtros de data dos outros relat√≥rios
                const dataInicio = document.getElementById('dataInicio').value;
                const dataFim = document.getElementById('dataFim').value;
                const tipo = document.getElementById('filtroTipo').value;
                
                let url = '/api/frequencias?';
                if (dataInicio) url += `dataInicio=${dataInicio}&`;
                if (dataFim) url += `dataFim=${dataFim}&`;
                if (tipo) url += `tipo=${tipo}&`;
                
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        alert('Sess√£o expirada. Voc√™ ser√° redirecionado para o login.');
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        window.location.href = 'login.html';
                        return;
                    }
                    throw new Error(`Erro ${response.status}: ${response.statusText}`);
                }
                
                const frequencias = await response.json();
                
                // Agrupar por pessoa para evitar duplicatas
                const pessoasUnicas = new Map();
                
                frequencias.forEach(f => {
                    if (!pessoasUnicas.has(f.pessoa_id)) {
                        pessoasUnicas.set(f.pessoa_id, {
                            nome: f.pessoa_nome,
                            telefone: f.telefone || 'N√£o informado',
                            email: f.email || 'N√£o informado',
                            tipos: new Set()
                        });
                    }
                    pessoasUnicas.get(f.pessoa_id).tipos.add(f.tipo);
                });
                
                // Converter para array e ordenar por nome
                const pessoas = Array.from(pessoasUnicas.values())
                    .map(p => ({
                        ...p,
                        tiposAtendimento: Array.from(p.tipos).join(', ')
                    }))
                    .sort((a, b) => a.nome.localeCompare(b.nome));
                
                // Criar t√≠tulo com per√≠odo selecionado
                let tituloPeriodo = '';
                if (dataInicio && dataFim) {
                    // Ajustar para o fuso hor√°rio local para evitar mudan√ßa de data
                    const dataInicioObj = new Date(dataInicio + 'T00:00:00');
                    const dataFimObj = new Date(dataFim + 'T00:00:00');
                    
                    const dataInicioFormatada = dataInicioObj.toLocaleDateString('pt-BR');
                    const dataFimFormatada = dataFimObj.toLocaleDateString('pt-BR');
                    
                    tituloPeriodo = ` (${dataInicioFormatada} a ${dataFimFormatada})`;
                } else if (dataInicio) {
                    const dataInicioObj = new Date(dataInicio + 'T00:00:00');
                    const dataInicioFormatada = dataInicioObj.toLocaleDateString('pt-BR');
                    tituloPeriodo = ` (a partir de ${dataInicioFormatada})`;
                } else if (dataFim) {
                    const dataFimObj = new Date(dataFim + 'T00:00:00');
                    const dataFimFormatada = dataFimObj.toLocaleDateString('pt-BR');
                    tituloPeriodo = ` (at√© ${dataFimFormatada})`;
                }
                
                let tituloTipo = '';
                if (tipo) {
                    tituloTipo = ` - Tipo: ${tipo.toUpperCase().replace('_', ' ')}`;
                }
                
                document.getElementById('relatorioResultado').innerHTML = `
                    <h3>üìû Relat√≥rio de Contatos${tituloPeriodo}${tituloTipo}</h3>
                    
                    <!-- Resumo Estat√≠stico -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin-top: 0; color: #28a745;">üìä Resumo</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                            <div style="background: white; padding: 15px; border-radius: 5px; text-align: center; border-left: 4px solid #28a745;">
                                <div style="font-size: 24px; font-weight: bold; color: #28a745;">${pessoas.length}</div>
                                <div style="color: #666;">Pessoas √önicas</div>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 5px; text-align: center; border-left: 4px solid #007bff;">
                                <div style="font-size: 24px; font-weight: bold; color: #007bff;">${frequencias.length}</div>
                                <div style="color: #666;">Total de Frequ√™ncias</div>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 5px; text-align: center; border-left: 4px solid #ffc107;">
                                <div style="font-size: 24px; font-weight: bold; color: #ffc107;">${pessoas.filter(p => p.telefone !== 'N√£o informado').length}</div>
                                <div style="color: #666;">Com Telefone</div>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 5px; text-align: center; border-left: 4px solid #17a2b8;">
                                <div style="font-size: 24px; font-weight: bold; color: #17a2b8;">${pessoas.filter(p => p.email !== 'N√£o informado').length}</div>
                                <div style="color: #666;">Com E-mail</div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <strong>üìÖ Per√≠odo Selecionado:</strong> ${tituloPeriodo || 'Per√≠odo completo'}
                            ${pessoas.length === 0 ? '<br><span style="color: #dc3545; font-size: 14px;">‚ö†Ô∏è Nenhuma pessoa encontrada no per√≠odo selecionado</span>' : ''}
                        </div>
                    </div>
                    
                    <!-- Tabela de Contatos -->
                    <h4>üìã Lista de Contatos (${pessoas.length} pessoas)</h4>
                    <div style="max-height: 600px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px;">
                        <table style="width: 100%;">
                            <thead style="position: sticky; top: 0; background: white;">
                                <tr style="background: #28a745; color: white;">
                                    <th style="padding: 12px; text-align: left;">#</th>
                                    <th style="padding: 12px; text-align: left;">Nome</th>
                                    <th style="padding: 12px; text-align: left;">Telefone</th>
                                    <th style="padding: 12px; text-align: left;">E-mail</th>
                                    <th style="padding: 12px; text-align: left;">Tipos de Atendimento</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${pessoas.map((p, index) => `
                                    <tr style="${index % 2 === 0 ? 'background: #f8f9fa;' : ''}">
                                        <td style="padding: 10px; text-align: center; font-weight: bold;">${index + 1}</td>
                                        <td style="padding: 10px;"><strong>${p.nome}</strong></td>
                                        <td style="padding: 10px;">
                                            ${p.telefone !== 'N√£o informado' 
                                                ? `<a href="tel:${p.telefone}" style="color: #007bff; text-decoration: none;">${p.telefone}</a>` 
                                                : '<span style="color: #6c757d; font-style: italic;">N√£o informado</span>'
                                            }
                                        </td>
                                        <td style="padding: 10px;">
                                            ${p.email !== 'N√£o informado' 
                                                ? `<a href="mailto:${p.email}" style="color: #007bff; text-decoration: none;">${p.email}</a>` 
                                                : '<span style="color: #6c757d; font-style: italic;">N√£o informado</span>'
                                            }
                                        </td>
                                        <td style="padding: 10px;">
                                            <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                                                ${Array.from(p.tipos).map(tipo => `
                                                    <span style="background: ${getTipoColor(tipo.toLowerCase())}; color: white; padding: 2px 6px; border-radius: 8px; font-size: 11px; white-space: nowrap;">
                                                        ${tipo.toUpperCase().replace('_', ' ')}
                                                    </span>
                                                `).join('')}
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    ${pessoas.length > 0 ? `
                        <div style="margin-top: 15px; padding: 15px; background: #e9ecef; border-radius: 5px; text-align: center;">
                            <strong>üìä Estat√≠sticas de Contato:</strong><br>
                            Telefones cadastrados: ${pessoas.filter(p => p.telefone !== 'N√£o informado').length} de ${pessoas.length} (${((pessoas.filter(p => p.telefone !== 'N√£o informado').length / pessoas.length) * 100).toFixed(1)}%)<br>
                            E-mails cadastrados: ${pessoas.filter(p => p.email !== 'N√£o informado').length} de ${pessoas.length} (${((pessoas.filter(p => p.email !== 'N√£o informado').length / pessoas.length) * 100).toFixed(1)}%)
                        </div>
                    ` : ''}
                `;
                
                const botoesExportacao = document.getElementById('botoesExportacao');
                if (botoesExportacao) {
                    botoesExportacao.style.display = 'block';
                }
                
            } catch (error) {
                console.error('Erro no relat√≥rio de contatos:', error);
                document.getElementById('relatorioResultado').innerHTML = `
                    <p style="color: red;">Erro ao gerar relat√≥rio de contatos: ${error.message}</p>
                    <p style="color: orange;">Verifique se voc√™ tem permiss√£o para acessar relat√≥rios.</p>
                `;
            } finally {
                setButtonLoading(button, false);
            }
        }

        async function gerarRelatorioPessoasCidades(button) {
            setButtonLoading(button, true);
            
            // Ocultar filtros espec√≠ficos de volunt√°rios
            document.getElementById('filtrosVoluntarios').style.display = 'none';
            try {
                // Usar os mesmos filtros de data do relat√≥rio geral
                const dataInicio = document.getElementById('dataInicio').value;
                const dataFim = document.getElementById('dataFim').value;
                const tipo = document.getElementById('filtroTipo').value;
                
                let url = '/api/frequencias?';
                if (dataInicio) url += `dataInicio=${dataInicio}&`;
                if (dataFim) url += `dataFim=${dataFim}&`;
                if (tipo) url += `tipo=${tipo}&`;
                
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) {
                    throw new Error(`Erro ${response.status}: ${response.statusText}`);
                }
                
                const frequencias = await response.json();
                
                // Debug: verificar estrutura dos dados
                console.log('=== DEBUG RELAT√ìRIO CIDADES ===');
                console.log('Status da resposta:', response.status);
                console.log('Total de frequ√™ncias:', frequencias.length);
                if (frequencias.length > 0) {
                    console.log('Primeira frequ√™ncia:', frequencias[0]);
                    console.log('Campos dispon√≠veis:', Object.keys(frequencias[0]));
                    console.log('Cidade da primeira:', frequencias[0].cidade);
                    console.log('Estado da primeira:', frequencias[0].estado);
                } else {
                    console.log('Nenhuma frequ√™ncia retornada');
                }
                console.log('=== FIM DEBUG ===');
                
                // Agrupar frequ√™ncias por cidade
                const cidadeStats = {};
                
                frequencias.forEach(f => {
                    if (f.cidade && f.cidade.trim() !== '') {
                        const cidadeNormalizada = normalizarCidade(f.cidade.trim());
                        const chave = `${cidadeNormalizada}/${f.estado || 'N/A'}`;
                        if (!cidadeStats[chave]) {
                            cidadeStats[chave] = { total: 0, pessoas: new Set() };
                        }
                        cidadeStats[chave].total++;
                        cidadeStats[chave].pessoas.add(f.pessoa_id);
                    }
                });
                
                // Se n√£o encontrou cidades nas frequ√™ncias, mostrar mensagem explicativa
                if (Object.keys(cidadeStats).length === 0) {
                    document.getElementById('relatorioResultado').innerHTML = `
                        <div style="text-align: center; padding: 40px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px;">
                            <h3 style="color: #856404;">‚ö†Ô∏è Dados de Cidade N√£o Dispon√≠veis</h3>
                            <p>Foram encontradas <strong>${frequencias.length} frequ√™ncias</strong>, mas nenhuma possui dados de cidade.</p>
                            <p>Isso pode acontecer se:</p>
                            <ul style="text-align: left; display: inline-block;">
                                <li>As frequ√™ncias foram registradas antes da implementa√ß√£o dos dados de cidade</li>
                                <li>Os dados de cidade n√£o est√£o sendo retornados pela API</li>
                                <li>As pessoas n√£o possuem cidade cadastrada</li>
                            </ul>
                            <p><em>Verifique se a API de frequ√™ncias est√° retornando os campos cidade e estado.</em></p>
                        </div>
                    `;
                    return;
                }
                
                // Ordenar e pegar top 10
                const top10Cidades = Object.entries(cidadeStats)
                    .map(([cidade, stats]) => ({ cidade, total: stats.total, pessoas: stats.pessoas.size }))
                    .sort((a, b) => b.total - a.total)
                    .slice(0, 10);
                
                const todasCidades = Object.entries(cidadeStats)
                    .map(([cidade, stats]) => ({ cidade, total: stats.total, pessoas: stats.pessoas.size }))
                    .sort((a, b) => b.total - a.total);
                
                const totalFrequencias = frequencias.length;
                
                // Criar t√≠tulo com per√≠odo selecionado
                let tituloPeriodo = '';
                if (dataInicio && dataFim) {
                    // Ajustar para o fuso hor√°rio local para evitar mudan√ßa de data
                    const dataInicioObj = new Date(dataInicio + 'T00:00:00');
                    const dataFimObj = new Date(dataFim + 'T00:00:00');
                    
                    const dataInicioFormatada = dataInicioObj.toLocaleDateString('pt-BR');
                    const dataFimFormatada = dataFimObj.toLocaleDateString('pt-BR');
                    
                    tituloPeriodo = ` (${dataInicioFormatada} a ${dataFimFormatada})`;
                } else if (dataInicio) {
                    const dataInicioObj = new Date(dataInicio + 'T00:00:00');
                    const dataInicioFormatada = dataInicioObj.toLocaleDateString('pt-BR');
                    tituloPeriodo = ` (a partir de ${dataInicioFormatada})`;
                } else if (dataFim) {
                    const dataFimObj = new Date(dataFim + 'T00:00:00');
                    const dataFimFormatada = dataFimObj.toLocaleDateString('pt-BR');
                    tituloPeriodo = ` (at√© ${dataFimFormatada})`;
                }
                
                let tituloTipo = '';
                if (tipo) {
                    tituloTipo = ` - Tipo: ${tipo}`;
                }
                
                // Criar gr√°fico de pizza
                const canvasId = 'graficoTop10Cidades';
                
                document.getElementById('relatorioResultado').innerHTML = `
                    <h3>üèÜ Top 10 Cidades por Frequ√™ncia${tituloPeriodo}${tituloTipo}</h3>
                    <p style="color: #666; margin-bottom: 20px;">Total: ${totalFrequencias} frequ√™ncias encontradas</p>
                    <div style="display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;">
                        <div style="flex: 1;">
                            <canvas id="${canvasId}" width="400" height="400"></canvas>
                        </div>
                        <div style="flex: 1;">
                            <table style="width: 100%;">
                                <thead>
                                    <tr style="background: #6f42c1; color: white;">
                                        <th>Posi√ß√£o</th>
                                        <th>Cidade/Estado</th>
                                        <th>Total Frequ√™ncias</th>
                                        <th>Pessoas √önicas</th>
                                        <th>%</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${top10Cidades.map((c, index) => {
                                        const percentual = ((c.total / totalFrequencias) * 100).toFixed(1);
                                        return `
                                            <tr>
                                                <td style="text-align: center; font-weight: bold;">${index + 1}¬∫</td>
                                                <td><strong>${normalizarCidade(c.cidade)}</strong></td>
                                                <td style="text-align: center;">${c.total}</td>
                                                <td style="text-align: center;">${c.pessoas}</td>
                                                <td style="text-align: center;">${percentual}%</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <h3>üìä Lista Completa de Todas as Cidades (${todasCidades.length} cidades)</h3>
                    <div style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px;">
                        <table style="width: 100%;">
                            <thead style="position: sticky; top: 0; background: white;">
                                <tr style="background: #6c757d; color: white;">
                                    <th style="padding: 10px;">#</th>
                                    <th style="padding: 10px;">Cidade/Estado</th>
                                    <th style="padding: 10px;">Total Frequ√™ncias</th>
                                    <th style="padding: 10px;">Pessoas √önicas</th>
                                    <th style="padding: 10px;">M√©dia por Pessoa</th>
                                    <th style="padding: 10px;">%</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${todasCidades.map((c, index) => {
                                    const percentual = ((c.total / totalFrequencias) * 100).toFixed(1);
                                    const media = (c.total / c.pessoas).toFixed(1);
                                    return `
                                        <tr style="${index % 2 === 0 ? 'background: #f8f9fa;' : ''}">
                                            <td style="text-align: center; padding: 8px;">${index + 1}</td>
                                            <td style="padding: 8px;"><strong>${normalizarCidade(c.cidade)}</strong></td>
                                            <td style="text-align: center; padding: 8px;">${c.total}</td>
                                            <td style="text-align: center; padding: 8px;">${c.pessoas}</td>
                                            <td style="text-align: center; padding: 8px;">${media}</td>
                                            <td style="text-align: center; padding: 8px;">${percentual}%</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div style="margin-top: 10px; padding: 10px; background: #e9ecef; border-radius: 5px; text-align: center;">
                        <strong>Total de frequ√™ncias: ${totalFrequencias} | Cidades representadas: ${todasCidades.length}</strong>
                    </div>
                `;
                
                // Criar gr√°fico de pizza
                const ctx = document.getElementById(canvasId).getContext('2d');
                
                // Destruir gr√°fico anterior se existir
                if (window.chartInstance) {
                    window.chartInstance.destroy();
                }
                
                const cores = [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                    '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
                ];
                
                // Garantir que temos exatamente 10 cidades para o gr√°fico
                const cidadesGrafico = top10Cidades.slice(0, 10);
                
                window.chartInstance = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: cidadesGrafico.map(c => normalizarCidade(c.cidade)),
                        datasets: [{
                            data: cidadesGrafico.map(c => c.total),
                            backgroundColor: cores.slice(0, cidadesGrafico.length),
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: `Top ${cidadesGrafico.length} Cidades por Frequ√™ncia`,
                                font: { size: 16, weight: 'bold' }
                            },
                            legend: {
                                position: 'bottom',
                                labels: { padding: 20, usePointStyle: true }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((context.parsed / total) * 100).toFixed(1);
                                        return `${context.label}: ${context.parsed} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
                
                const botoesExportacao = document.getElementById('botoesExportacao');
                if (botoesExportacao) {
                    botoesExportacao.style.display = 'block';
                }
            } catch (error) {
                console.error('Erro no relat√≥rio por cidades:', error);
                document.getElementById('relatorioResultado').innerHTML = `
                    <p style="color: red;">Erro ao gerar relat√≥rio de pessoas por cidade: ${error.message}</p>
                    <p style="color: orange;">Verifique se voc√™ tem permiss√£o para acessar relat√≥rios.</p>
                `;
            } finally {
                setButtonLoading(button, false);
            }
        }

        async function gerarRelatorioCadastros(button) {
            setButtonLoading(button, true);
            
            // Ocultar filtros espec√≠ficos de volunt√°rios
            document.getElementById('filtrosVoluntarios').style.display = 'none';
            try {
                const response = await fetch('/api/pessoas', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) {
                    throw new Error(`Erro ${response.status}: ${response.statusText}`);
                }
                
                const pessoas = await response.json();
                
                // Calcular estat√≠sticas
                const totalPessoas = pessoas.length;
                const comTelefone = pessoas.filter(p => p.telefone && p.telefone.trim()).length;
                const comEmail = pessoas.filter(p => p.email && p.email.trim()).length;
                const comCpf = pessoas.filter(p => p.cpf && p.cpf.trim()).length;
                const comNascimento = pessoas.filter(p => p.nascimento).length;
                
                // Agrupar por cidade
                const cidadeStats = {};
                pessoas.forEach(p => {
                    const cidade = p.cidade || 'N√£o informado';
                    if (!cidadeStats[cidade]) {
                        cidadeStats[cidade] = 0;
                    }
                    cidadeStats[cidade]++;
                });
                
                const cidades = Object.keys(cidadeStats).length;
                const cidadesMaisComuns = Object.entries(cidadeStats)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);
                
                // Agrupar por religi√£o
                const religiaoStats = {};
                pessoas.forEach(p => {
                    const religiao = p.religiao || 'N√£o informado';
                    if (!religiaoStats[religiao]) {
                        religiaoStats[religiao] = 0;
                    }
                    religiaoStats[religiao]++;
                });
                
                // Ordenar pessoas por nome
                pessoas.sort((a, b) => a.nome.localeCompare(b.nome));
                
                document.getElementById('relatorioResultado').innerHTML = `
                    <h3>üìã Relat√≥rio de Cadastros</h3>
                    
                    <!-- Resumo Estat√≠stico -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin-top: 0; color: #fd7e14;">üìä Resumo Estat√≠stico</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                            <div style="background: white; padding: 15px; border-radius: 5px; text-align: center; border-left: 4px solid #fd7e14;">
                                <div style="font-size: 24px; font-weight: bold; color: #fd7e14;">${totalPessoas}</div>
                                <div style="color: #666;">Total de Pessoas</div>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 5px; text-align: center; border-left: 4px solid #28a745;">
                                <div style="font-size: 24px; font-weight: bold; color: #28a745;">${comTelefone}</div>
                                <div style="color: #666;">Com Telefone</div>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 5px; text-align: center; border-left: 4px solid #007bff;">
                                <div style="font-size: 24px; font-weight: bold; color: #007bff;">${comEmail}</div>
                                <div style="color: #666;">Com E-mail</div>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 5px; text-align: center; border-left: 4px solid #6f42c1;">
                                <div style="font-size: 24px; font-weight: bold; color: #6f42c1;">${comCpf}</div>
                                <div style="color: #666;">Com CPF</div>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 5px; text-align: center; border-left: 4px solid #ffc107;">
                                <div style="font-size: 24px; font-weight: bold; color: #ffc107;">${comNascimento}</div>
                                <div style="color: #666;">Com Data Nasc.</div>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 5px; text-align: center; border-left: 4px solid #17a2b8;">
                                <div style="font-size: 24px; font-weight: bold; color: #17a2b8;">${cidades}</div>
                                <div style="color: #666;">Cidades</div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <strong>üìç Cidades mais comuns:</strong> 
                            ${cidadesMaisComuns.map(([cidade, count]) => 
                                `<span style="background: #e9ecef; padding: 2px 6px; border-radius: 3px; margin-right: 5px;">${cidade} (${count})</span>`
                            ).join('')}
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <strong>üìä Completude dos dados:</strong><br>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-top: 10px;">
                                <div>Telefone: <strong>${((comTelefone / totalPessoas) * 100).toFixed(1)}%</strong></div>
                                <div>E-mail: <strong>${((comEmail / totalPessoas) * 100).toFixed(1)}%</strong></div>
                                <div>CPF: <strong>${((comCpf / totalPessoas) * 100).toFixed(1)}%</strong></div>
                                <div>Data Nasc.: <strong>${((comNascimento / totalPessoas) * 100).toFixed(1)}%</strong></div>
                            </div>
                        </div>
                        
                        ${totalPessoas === 0 ? '<div style="color: #dc3545; font-size: 14px;">‚ö†Ô∏è Nenhuma pessoa cadastrada no sistema</div>' : ''}
                    </div>
                    
                    <!-- Tabela de Pessoas -->
                    <h4>üë• Lista de Pessoas Cadastradas (${totalPessoas} pessoas)</h4>
                    <div style="max-height: 600px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px;">
                        <table style="width: 100%;">
                            <thead style="position: sticky; top: 0; background: white;">
                                <tr style="background: #fd7e14; color: white;">
                                    <th style="padding: 12px; text-align: left;">#</th>
                                    <th style="padding: 12px; text-align: left;">Nome</th>
                                    <th style="padding: 12px; text-align: left;">CPF</th>
                                    <th style="padding: 12px; text-align: left;">Telefone</th>
                                    <th style="padding: 12px; text-align: left;">E-mail</th>
                                    <th style="padding: 12px; text-align: left;">Cidade</th>
                                    <th style="padding: 12px; text-align: left;">Estado</th>
                                    <th style="padding: 12px; text-align: left;">Religi√£o</th>
                                    <th style="padding: 12px; text-align: left;">Cadastrado em</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${pessoas.map((p, index) => `
                                    <tr style="${index % 2 === 0 ? 'background: #f8f9fa;' : ''}">
                                        <td style="padding: 10px; text-align: center; font-weight: bold;">${index + 1}</td>
                                        <td style="padding: 10px;"><strong>${p.nome}</strong></td>
                                        <td style="padding: 10px;">${p.cpf || '<span style="color: #6c757d; font-style: italic;">N√£o informado</span>'}</td>
                                        <td style="padding: 10px;">
                                            ${p.telefone 
                                                ? `<a href="tel:${p.telefone}" style="color: #007bff; text-decoration: none;">${p.telefone}</a>` 
                                                : '<span style="color: #6c757d; font-style: italic;">N√£o informado</span>'
                                            }
                                        </td>
                                        <td style="padding: 10px;">
                                            ${p.email 
                                                ? `<a href="mailto:${p.email}" style="color: #007bff; text-decoration: none;">${p.email}</a>` 
                                                : '<span style="color: #6c757d; font-style: italic;">N√£o informado</span>'
                                            }
                                        </td>
                                        <td style="padding: 10px;">${p.cidade || '<span style="color: #6c757d; font-style: italic;">N√£o informado</span>'}</td>
                                        <td style="padding: 10px;">${p.estado || '<span style="color: #6c757d; font-style: italic;">N√£o informado</span>'}</td>
                                        <td style="padding: 10px;">${p.religiao || '<span style="color: #6c757d; font-style: italic;">N√£o informado</span>'}</td>
                                        <td style="padding: 10px;">${p.created_at ? formatarDataMySQL(p.created_at) : 'N/A'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    ${totalPessoas > 0 ? `
                        <div style="margin-top: 15px; padding: 15px; background: #e9ecef; border-radius: 5px; text-align: center;">
                            <strong>üìà An√°lise de Dados:</strong><br>
                            ${comTelefone + comEmail === 0 ? 
                                '<span style="color: #dc3545;">‚ö†Ô∏è Nenhuma pessoa possui dados de contato cadastrados</span>' :
                                `Dados de contato dispon√≠veis para ${Math.max(comTelefone, comEmail)} pessoas (${((Math.max(comTelefone, comEmail) / totalPessoas) * 100).toFixed(1)}% do total)`
                            }
                        </div>
                    ` : ''}
                `;
                
                document.getElementById('botoesExportacao').style.display = 'block';
                // Armazenar dados do relat√≥rio atual para exporta√ß√£o
                window.relatorioAtual = {
                    tipo: 'Relat√≥rio de Cadastros',
                    dados: pessoas,
                    filtros: {}
                };
                
            } catch (error) {
                console.error('Erro no relat√≥rio de cadastros:', error);
                document.getElementById('relatorioResultado').innerHTML = `
                    <div style="color: red; padding: 20px; text-align: center;">
                        <h3>‚ùå Erro ao gerar relat√≥rio</h3>
                        <p>N√£o foi poss√≠vel carregar os dados de cadastros.</p>
                        <p style="font-size: 14px; color: #666;">Erro: ${error.message}</p>
                    </div>
                `;
            } finally {
                setButtonLoading(button, false);
            }
        }

        async function gerarRelatorioVoluntarios(button) {
            setButtonLoading(button, true);
            
            // Mostrar filtros espec√≠ficos para volunt√°rios e ocultar outros
            document.getElementById('filtrosVoluntarios').style.display = 'block';
            
            // Ocultar filtros de outros relat√≥rios se existirem
            const outrosFiltros = document.querySelectorAll('[id*="filtro"]:not(#filtrosVoluntarios)');
            outrosFiltros.forEach(filtro => {
                if (filtro.style && filtro.id !== 'filtroTipo' && filtro.id !== 'dataInicio' && filtro.id !== 'dataFim') {
                    filtro.style.display = 'none';
                }
            });
            
            try {
                const token = localStorage.getItem('token');
                
                // Obter filtros
                const dataInicio = document.getElementById('dataInicio').value;
                const dataFim = document.getElementById('dataFim').value;
                const localFiltro = document.getElementById('filtroLocalVoluntarios').value;
                const voluntarioFiltro = document.getElementById('filtroVoluntarioEspecifico').value;
                const periodoFiltro = document.getElementById('filtroPeriodoVoluntarios').value;
                
                // Calcular datas baseado no per√≠odo selecionado
                let dataInicioFinal = dataInicio;
                let dataFimFinal = dataFim;
                
                if (periodoFiltro) {
                    const hoje = new Date();
                    switch (periodoFiltro) {
                        case 'hoje':
                            dataInicioFinal = dataFimFinal = hoje.toISOString().split('T')[0];
                            break;
                        case 'semana':
                            const inicioSemana = new Date(hoje);
                            inicioSemana.setDate(hoje.getDate() - hoje.getDay());
                            dataInicioFinal = inicioSemana.toISOString().split('T')[0];
                            dataFimFinal = hoje.toISOString().split('T')[0];
                            break;
                        case 'mes':
                            dataInicioFinal = new Date(hoje.getFullYear(), hoje.getMonth(), 1).toISOString().split('T')[0];
                            dataFimFinal = hoje.toISOString().split('T')[0];
                            break;
                        case 'trimestre':
                            const inicioTrimestre = new Date(hoje);
                            inicioTrimestre.setMonth(hoje.getMonth() - 3);
                            dataInicioFinal = inicioTrimestre.toISOString().split('T')[0];
                            dataFimFinal = hoje.toISOString().split('T')[0];
                            break;
                    }
                }
                
                // Construir URL com filtros
                let url = '/api/frequencia_voluntarios?limit=1000';
                if (dataInicioFinal) url += `&data_inicio=${dataInicioFinal}`;
                if (dataFimFinal) url += `&data_fim=${dataFimFinal}`;
                if (localFiltro) url += `&local_inicio=${encodeURIComponent(localFiltro)}`;
                if (voluntarioFiltro) url += `&voluntario_id=${voluntarioFiltro}`;
                
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) {
                    throw new Error(`Erro ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                const frequencias = data.frequencias || [];
                
                // Processar dados para estat√≠sticas
                const totalFrequencias = frequencias.length;
                const voluntariosUnicos = new Set(frequencias.map(f => f.voluntario_id)).size;
                const locaisTrabalho = {};
                const voluntarioStats = {};
                const horasTrabalhadas = {};
                
                frequencias.forEach(freq => {
                    // Contar por local
                    locaisTrabalho[freq.local_inicio] = (locaisTrabalho[freq.local_inicio] || 0) + 1;
                    
                    // Estat√≠sticas por volunt√°rio
                    if (!voluntarioStats[freq.voluntario_nome]) {
                        voluntarioStats[freq.voluntario_nome] = {
                            nome: freq.voluntario_nome,
                            cpf: freq.voluntario_cpf,
                            frequencias: 0,
                            locais: new Set(),
                            ultimaFrequencia: freq.data_trabalho
                        };
                    }
                    voluntarioStats[freq.voluntario_nome].frequencias++;
                    voluntarioStats[freq.voluntario_nome].locais.add(freq.local_inicio);
                    
                    // Calcular horas trabalhadas (se tiver hora fim)
                    if (freq.hora_inicio && freq.hora_fim) {
                        const inicio = new Date(`2000-01-01T${freq.hora_inicio}`);
                        const fim = new Date(`2000-01-01T${freq.hora_fim}`);
                        const horas = (fim - inicio) / (1000 * 60 * 60);
                        if (horas > 0 && horas < 24) {
                            horasTrabalhadas[freq.voluntario_nome] = (horasTrabalhadas[freq.voluntario_nome] || 0) + horas;
                        }
                    }
                });
                
                // Ordenar locais por frequ√™ncia
                const locaisOrdenados = Object.entries(locaisTrabalho)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 5);
                
                // Ordenar volunt√°rios por frequ√™ncia
                const voluntariosOrdenados = Object.values(voluntarioStats)
                    .sort((a, b) => b.frequencias - a.frequencias)
                    .slice(0, 10);
                
                // Gerar HTML do relat√≥rio
                const filtrosAplicados = [];
                if (dataInicioFinal) filtrosAplicados.push(`Data in√≠cio: ${formatarDataMySQL(dataInicioFinal)}`);
                if (dataFimFinal) filtrosAplicados.push(`Data fim: ${formatarDataMySQL(dataFimFinal)}`);
                if (localFiltro) filtrosAplicados.push(`Local: ${localFiltro}`);
                if (voluntarioFiltro) {
                    const voluntarioNome = document.querySelector(`#filtroVoluntarioEspecifico option[value="${voluntarioFiltro}"]`)?.textContent;
                    if (voluntarioNome) filtrosAplicados.push(`Volunt√°rio: ${voluntarioNome}`);
                }
                if (periodoFiltro) filtrosAplicados.push(`Per√≠odo: ${periodoFiltro}`);
                
                document.getElementById('relatorioResultado').innerHTML = `
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <!-- Cabe√ßalho do Relat√≥rio -->
                        <div style="text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #e83e8c;">
                            <h3 style="color: #e83e8c; margin: 0; font-size: 24px;">‚è∞ Relat√≥rio de Frequ√™ncia de Volunt√°rios</h3>
                            <p style="color: #666; margin: 5px 0 0 0;">Gerado em ${new Date().toLocaleString('pt-BR')}</p>
                            ${filtrosAplicados.length > 0 ? `<p style="color: #666; font-size: 14px; margin: 5px 0 0 0;"><strong>Filtros:</strong> ${filtrosAplicados.join(' | ')}</p>` : ''}
                        </div>
                        
                        <!-- Estat√≠sticas Gerais -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
                            <div style="background: white; padding: 15px; border-radius: 5px; text-align: center; border-left: 4px solid #e83e8c;">
                                <div style="font-size: 24px; font-weight: bold; color: #e83e8c;">${totalFrequencias}</div>
                                <div style="color: #666;">Total de Frequ√™ncias</div>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 5px; text-align: center; border-left: 4px solid #28a745;">
                                <div style="font-size: 24px; font-weight: bold; color: #28a745;">${voluntariosUnicos}</div>
                                <div style="color: #666;">Volunt√°rios Ativos</div>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 5px; text-align: center; border-left: 4px solid #007bff;">
                                <div style="font-size: 24px; font-weight: bold; color: #007bff;">${Object.keys(locaisTrabalho).length}</div>
                                <div style="color: #666;">Locais de Trabalho</div>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 5px; text-align: center; border-left: 4px solid #ffc107;">
                                <div style="font-size: 24px; font-weight: bold; color: #ffc107;">${Object.values(horasTrabalhadas).reduce((a, b) => a + b, 0).toFixed(1)}h</div>
                                <div style="color: #666;">Horas Trabalhadas</div>
                            </div>
                        </div>
                        
                        <!-- Locais Mais Utilizados -->
                        ${locaisOrdenados.length > 0 ? `
                            <div style="margin-bottom: 30px;">
                                <h4 style="color: #e83e8c; margin-bottom: 15px;">üè¢ Locais Mais Utilizados</h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                                    ${locaisOrdenados.map(([local, count]) => `
                                        <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; text-align: center; border-left: 3px solid #e83e8c;">
                                            <div style="font-weight: bold; color: #e83e8c;">${count}</div>
                                            <div style="font-size: 12px; color: #666;">${local}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Top Volunt√°rios -->
                        ${voluntariosOrdenados.length > 0 ? `
                            <div style="margin-bottom: 30px;">
                                <h4 style="color: #e83e8c; margin-bottom: 15px;">üèÜ Volunt√°rios Mais Ativos</h4>
                                <div style="overflow-x: auto;">
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <thead>
                                            <tr style="background: #e83e8c; color: white;">
                                                <th style="padding: 12px; text-align: left;">Posi√ß√£o</th>
                                                <th style="padding: 12px; text-align: left;">Volunt√°rio</th>
                                                <th style="padding: 12px; text-align: center;">Frequ√™ncias</th>
                                                <th style="padding: 12px; text-align: center;">Locais</th>
                                                <th style="padding: 12px; text-align: center;">Horas</th>
                                                <th style="padding: 12px; text-align: center;">√öltima Frequ√™ncia</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${voluntariosOrdenados.map((vol, index) => `
                                                <tr style="border-bottom: 1px solid #eee;">
                                                    <td style="padding: 10px; text-align: center;">
                                                        <span style="background: ${index < 3 ? ['#ffd700', '#c0c0c0', '#cd7f32'][index] : '#e9ecef'}; color: ${index < 3 ? 'white' : '#666'}; padding: 4px 8px; border-radius: 50%; font-weight: bold;">
                                                            ${index + 1}¬∞
                                                        </span>
                                                    </td>
                                                    <td style="padding: 10px;">
                                                        <strong>${vol.nome}</strong><br>
                                                        <small style="color: #666;">${vol.cpf || 'CPF n√£o informado'}</small>
                                                    </td>
                                                    <td style="padding: 10px; text-align: center; font-weight: bold; color: #e83e8c;">${vol.frequencias}</td>
                                                    <td style="padding: 10px; text-align: center;">${vol.locais.size}</td>
                                                    <td style="padding: 10px; text-align: center;">${(horasTrabalhadas[vol.nome] || 0).toFixed(1)}h</td>
                                                    <td style="padding: 10px; text-align: center;">${formatarDataMySQL(vol.ultimaFrequencia)}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Lista Completa de Frequ√™ncias -->
                        <h4 style="color: #e83e8c; margin-bottom: 15px;">üìã Detalhamento das Frequ√™ncias (${totalFrequencias} registros)</h4>
                        <div style="max-height: 600px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead style="position: sticky; top: 0; background: white;">
                                    <tr style="background: #e83e8c; color: white;">
                                        <th style="padding: 12px; text-align: left;">Data</th>
                                        <th style="padding: 12px; text-align: left;">Volunt√°rio</th>
                                        <th style="padding: 12px; text-align: center;">Hor√°rio</th>
                                        <th style="padding: 12px; text-align: left;">Local In√≠cio</th>
                                        <th style="padding: 12px; text-align: left;">Local Fim</th>
                                        <th style="padding: 12px; text-align: left;">Observa√ß√µes</th>
                                        <th style="padding: 12px; text-align: left;">Lan√ßado por</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${frequencias.length > 0 ? frequencias.map(freq => `
                                        <tr style="border-bottom: 1px solid #eee;">
                                            <td style="padding: 10px;">${formatarDataMySQL(freq.data_trabalho)}</td>
                                            <td style="padding: 10px;">
                                                <strong>${freq.voluntario_nome}</strong><br>
                                                <small style="color: #666;">${freq.voluntario_cpf || 'CPF n√£o informado'}</small>
                                            </td>
                                            <td style="padding: 10px; text-align: center;">
                                                ${freq.hora_inicio}${freq.hora_fim ? ` - ${freq.hora_fim}` : ''}
                                            </td>
                                            <td style="padding: 10px;">
                                                <span style="background: #e8f5e8; padding: 2px 6px; border-radius: 3px; font-size: 0.9em;">
                                                    ${freq.local_inicio}
                                                </span>
                                            </td>
                                            <td style="padding: 10px;">
                                                ${freq.local_fim ? `<span style="background: #fff3cd; padding: 2px 6px; border-radius: 3px; font-size: 0.9em;">${freq.local_fim}</span>` : '-'}
                                            </td>
                                            <td style="padding: 10px; max-width: 200px;">
                                                ${freq.observacoes ? `<small>${freq.observacoes}</small>` : '-'}
                                            </td>
                                            <td style="padding: 10px;">
                                                <small>${freq.lancado_por_nome || 'N/A'}</small>
                                            </td>
                                        </tr>
                                    `).join('') : `
                                        <tr>
                                            <td colspan="7" style="padding: 20px; text-align: center; color: #666;">
                                                Nenhuma frequ√™ncia encontrada para os filtros selecionados
                                            </td>
                                        </tr>
                                    `}
                                </tbody>
                            </table>
                        </div>
                        
                        ${totalFrequencias === 0 ? '<div style="color: #dc3545; font-size: 14px; margin-top: 15px; text-align: center;">‚ö†Ô∏è Nenhuma frequ√™ncia de volunt√°rio registrada no per√≠odo selecionado</div>' : ''}
                    </div>
                `;
                
                document.getElementById('botoesExportacao').style.display = 'block';
                // Armazenar dados do relat√≥rio atual para exporta√ß√£o
                window.relatorioAtual = {
                    tipo: 'Relat√≥rio de Frequ√™ncia de Volunt√°rios',
                    dados: frequencias,
                    filtros: { dataInicio: dataInicioFinal, dataFim: dataFimFinal, local: localFiltro, voluntario: voluntarioFiltro }
                };
                
            } catch (error) {
                console.error('Erro no relat√≥rio de volunt√°rios:', error);
                document.getElementById('relatorioResultado').innerHTML = `
                    <div style="color: red; padding: 20px; text-align: center;">
                        <h3>‚ùå Erro ao gerar relat√≥rio</h3>
                        <p>N√£o foi poss√≠vel carregar os dados de frequ√™ncia de volunt√°rios.</p>
                        <p style="font-size: 14px; color: #666;">Erro: ${error.message}</p>
                        ${error.message.includes('401') ? '<p style="font-size: 14px; color: #dc3545;">Sua sess√£o expirou. Fa√ßa login novamente.</p>' : ''}
                    </div>
                `;
            } finally {
                setButtonLoading(button, false);
            }
        }

        function exportarCSV(button) {
            const tabela = document.querySelector('#relatorioResultado table');
            if (!tabela) {
                alert('Nenhum relat√≥rio para exportar');
                return;
            }
            
            setButtonLoading(button, true);
            
            let csv = '';
            const linhas = tabela.querySelectorAll('tr');
            
            linhas.forEach(linha => {
                const colunas = linha.querySelectorAll('th, td');
                const linhaCsv = Array.from(colunas).map(col => {
                    // Limpar o texto removendo HTML e espa√ßos extras
                    let texto = col.textContent || col.innerText || '';
                    texto = texto.trim();
                    
                    // Remover quebras de linha e espa√ßos m√∫ltiplos
                    texto = texto.replace(/\s+/g, ' ');
                    
                    // Escapar aspas duplas
                    texto = texto.replace(/"/g, '""');
                    
                    // Envolver em aspas se cont√©m v√≠rgula, quebra de linha ou aspas
                    if (texto.includes(',') || texto.includes('\n') || texto.includes('"')) {
                        return '"' + texto + '"';
                    }
                    
                    return texto;
                }).join(','); // Separado por v√≠rgula
                
                csv += linhaCsv + '\n';
            });
            
            // Adicionar BOM para UTF-8 (melhora compatibilidade com Excel)
            const BOM = '\uFEFF';
            const csvContent = BOM + csv;
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `relatorio_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            console.log('‚úÖ CSV exportado com separa√ß√£o por v√≠rgula');
            
            // Pequeno delay para garantir que o download iniciou
            setTimeout(() => {
                setButtonLoading(button, false);
            }, 500);
        }

        async function exportarPDF(button) {
            console.log('üîÑ Iniciando exporta√ß√£o PDF...');
            
            const tabela = document.querySelector('#relatorioResultado table');
            if (!tabela) {
                alert('Nenhum relat√≥rio para exportar');
                console.error('‚ùå Tabela n√£o encontrada para exporta√ß√£o');
                return;
            }
            
            console.log('‚úÖ Tabela encontrada:', tabela);
            setButtonLoading(button, true);
            
            try {
                // Carregar bibliotecas necess√°rias
                const [jsPDF, html2canvas] = await Promise.all([
                    carregarJsPDF(),
                    carregarHtml2Canvas()
                ]);
                
                console.log('‚úÖ Bibliotecas carregadas com sucesso');
                
                // Criar o documento PDF
                const doc = new jsPDF();
                console.log('‚úÖ Documento PDF criado');
                
                // T√≠tulo do relat√≥rio
                const titulo = window.relatorioAtual?.tipo || 'Relat√≥rio';
                doc.setFontSize(16);
                doc.text(titulo, 20, 20);
                doc.setFontSize(10);
                doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, 20, 30);
                console.log('‚úÖ T√≠tulo adicionado:', titulo);
                
                // Extrair dados da tabela
                const linhas = [];
                const rows = tabela.querySelectorAll('tr');
                
                let yPosition = 50;
                const lineHeight = 6;
                const pageHeight = 280;
                
                // Processar cada linha da tabela
                for (let i = 0; i < rows.length; i++) {
                    const row = rows[i];
                    const cells = row.querySelectorAll('th, td');
                    let linha = [];
                    
                    // Extrair conte√∫do das c√©lulas
                    cells.forEach(cell => {
                        linha.push(cell.textContent.trim());
                    });
                    
                    // Verificar se precisa de nova p√°gina
                    if (yPosition > pageHeight) {
                        doc.addPage();
                        yPosition = 20;
                    }
                    
                    // Estilizar cabe√ßalho
                    if (i === 0) {
                        doc.setFontSize(10);
                        doc.setFont(undefined, 'bold');
                    } else {
                        doc.setFontSize(8);
                        doc.setFont(undefined, 'normal');
                    }
                    
                    // Adicionar linha ao PDF
                    const text = linha.join(' | ');
                    const maxWidth = 170;
                    const lines = doc.splitTextToSize(text, maxWidth);
                    
                    // Adicionar cada linha de texto
                    for (let j = 0; j < lines.length; j++) {
                        if (yPosition > pageHeight) {
                            doc.addPage();
                            yPosition = 20;
                        }
                        doc.text(lines[j], 20, yPosition);
                        yPosition += lineHeight;
                    }
                    
                    yPosition += 2; // Espa√ßo extra entre linhas
                }
                
                // Adicionar o gr√°fico de cidades ao PDF, se estiver vis√≠vel
                const graficoCidades = document.getElementById('graficoTop10Cidades');
                const graficoContainer = graficoCidades ? graficoCidades.closest('#graficoContainer') : null;
                
                if (graficoContainer && graficoContainer.offsetWidth > 0) {
                    try {
                        // Adicionar nova p√°gina para o gr√°fico
                        doc.addPage();
                        
                        // T√≠tulo da se√ß√£o
                        doc.setFontSize(16);
                        doc.setTextColor(0, 0, 0); // Preto
                        doc.setFont(undefined, 'bold');
                        doc.text('Gr√°fico de Frequ√™ncia por Cidade', 20, 20);
                        
                        // Capturar o gr√°fico como imagem
                        const canvas = await html2canvas(graficoContainer, {
                            scale: 2, // Melhora a qualidade da imagem
                            useCORS: true,
                            logging: false,
                            backgroundColor: '#FFFFFF',
                            allowTaint: true,
                            removeContainer: false
                        });
                        
                        // Adicionar a imagem ao PDF
                        const imgData = canvas.toDataURL('image/png');
                        const imgProps = doc.getImageProperties(imgData);
                        
                        // Calcular dimens√µes mantendo a propor√ß√£o
                        const margin = 20;
                        const maxWidth = doc.internal.pageSize.getWidth() - (2 * margin);
                        const maxHeight = doc.internal.pageSize.getHeight() - 60; // Deixa espa√ßo para o t√≠tulo
                        
                        let imgWidth = imgProps.width;
                        let imgHeight = imgProps.height;
                        
                        // Redimensionar mantendo a propor√ß√£o
                        if (imgWidth > maxWidth) {
                            const ratio = maxWidth / imgWidth;
                            imgWidth = maxWidth;
                            imgHeight = imgHeight * ratio;
                        }
                        
                        if (imgHeight > maxHeight) {
                            const ratio = maxHeight / imgHeight;
                            imgHeight = maxHeight;
                            imgWidth = imgWidth * ratio;
                        }
                        
                        // Centralizar o gr√°fico na p√°gina
                        const x = (doc.internal.pageSize.getWidth() - imgWidth) / 2;
                        const y = 40; // Abaixo do t√≠tulo
                        
                        doc.addImage(imgData, 'PNG', x, y, imgWidth, imgHeight);
                        console.log('‚úÖ Gr√°fico de cidades adicionado ao PDF');
                        
                        // Adicionar legenda se dispon√≠vel
                        const listaCidades = document.getElementById('listaCidades');
                        if (listaCidades) {
                            const startY = y + imgHeight + 10;
                            if (startY < doc.internal.pageSize.getHeight() - 30) {
                                doc.setFontSize(10);
                                doc.setFont(undefined, 'normal');
                                doc.setTextColor(100);
                                doc.text('Legenda:', 20, startY);
                                
                                // Adicionar itens da legenda
                                const itensLegenda = Array.from(listaCidades.querySelectorAll('div')).slice(0, 10);
                                let currentY = startY + 8;
                                
                                itensLegenda.forEach((item, index) => {
                                    if (currentY > doc.internal.pageSize.getHeight() - 20) {
                                        doc.addPage();
                                        currentY = 20;
                                    }
                                    
                                    const texto = item.textContent.trim();
                                    doc.text(texto, 25, currentY);
                                    currentY += 6;
                                });
                            }
                        }
                    } catch (error) {
                        console.error('Erro ao adicionar gr√°fico ao PDF:', error);
                        // Continuar mesmo se houver erro no gr√°fico
                    }
                }
                
                // Salvar o PDF
                const nomeArquivo = `relatorio_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(nomeArquivo);
                console.log('‚úÖ PDF gerado com sucesso:', nomeArquivo);
                
                // Mostrar mensagem de sucesso
                alert('PDF gerado com sucesso!');
                
            } catch (error) {
                console.error('‚ùå Erro ao gerar PDF:', error);
                alert('Erro ao gerar PDF: ' + (error.message || 'Erro desconhecido'));
            } finally {
                // Desativar o estado de carregando
                setButtonLoading(button, false);
            }
        }
        
        // Fun√ß√£o para carregar o jsPDF
        function carregarJsPDF() {
            return new Promise((resolve, reject) => {
                // Verificar se j√° est√° carregado
                if (window.jspdf && window.jspdf.jsPDF) {
                    return resolve(window.jspdf.jsPDF);
                } else if (window.jsPDF) {
                    return resolve(window.jsPDF);
                } else if (typeof jsPDF === 'function') {
                    return resolve(jsPDF);
                }
                
                // Se n√£o estiver carregado, carregar o script
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                script.integrity = 'sha512-qZvrmS2ekKPF2mSznTQsxqPgnpkI4DNTlrdUmTzrDgektczlKNRRhy5X5AAOnx5S09ydFYWWNSfcEqDTTHgtNA==';
                script.crossOrigin = 'anonymous';
                
                script.onload = () => {
                    // Dar um tempo para o script ser processado
                    setTimeout(() => {
                        if (window.jspdf && window.jspdf.jsPDF) {
                            resolve(window.jspdf.jsPDF);
                        } else if (window.jsPDF) {
                            resolve(window.jsPDF);
                        } else if (typeof jsPDF === 'function') {
                            resolve(jsPDF);
                        } else {
                            reject(new Error('N√£o foi poss√≠vel carregar o jsPDF'));
                        }
                    }, 100);
                };
                
                script.onerror = () => {
                    reject(new Error('Falha ao carregar a biblioteca jsPDF'));
                };
                
                document.head.appendChild(script);
            });
        }
        
        // Fun√ß√£o para carregar o html2canvas
        function carregarHtml2Canvas() {
            return new Promise((resolve, reject) => {
                // Verificar se j√° est√° carregado
                if (window.html2canvas) {
                    return resolve(window.html2canvas);
                }
                
                // Se n√£o estiver carregado, carregar o script
                const script = document.createElement('script');
                script.src = 'https://html2canvas.hertzen.com/dist/html2canvas.min.js';
                script.crossOrigin = 'anonymous';
                
                script.onload = () => {
                    // Dar um tempo para o script ser processado
                    setTimeout(() => {
                        if (window.html2canvas) {
                            resolve(window.html2canvas);
                        } else {
                            reject(new Error('N√£o foi poss√≠vel carregar o html2canvas'));
                        }
                    }, 100);
                };
                
                script.onerror = () => {
                    reject(new Error('Falha ao carregar a biblioteca html2canvas'));
                };
                
                document.head.appendChild(script);
            });
        }

        function exportarXLSX(button) {
            const tabela = document.querySelector('#relatorioResultado table');
            if (!tabela) {
                alert('Nenhum relat√≥rio para exportar');
                return;
            }
            
            setButtonLoading(button, true);

            try {
                // Verificar se SheetJS est√° dispon√≠vel
                if (typeof XLSX === 'undefined') {
                    // Carregar SheetJS dinamicamente
                    const script = document.createElement('script');
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
                    script.onload = () => gerarXLSX();
                    script.onerror = () => {
                        alert('Erro ao carregar biblioteca de Excel');
                        setButtonLoading(button, false);
                    };
                    document.head.appendChild(script);
                } else {
                    gerarXLSX();
                }
            } catch (error) {
                alert('Erro ao exportar Excel: ' + error.message);
                setButtonLoading(button, false);
            }

            function gerarXLSX() {
                // Criar workbook
                const wb = XLSX.utils.book_new();
                
                // Converter tabela HTML para worksheet
                const ws = XLSX.utils.table_to_sheet(tabela);
                
                // Adicionar worksheet ao workbook
                const nomeAba = window.relatorioAtual?.tipo?.replace(/[^a-zA-Z0-9]/g, '_') || 'Relatorio';
                XLSX.utils.book_append_sheet(wb, ws, nomeAba);
                
                // Salvar arquivo
                const nomeArquivo = `relatorio_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, nomeArquivo);
                
                // Desabilitar loading ap√≥s salvar
                setTimeout(() => {
                    setButtonLoading(button, false);
                }, 500);
            }
        }

        async function carregarUsuarios() {
            try {
                console.log('Carregando usu√°rios...');
                const response = await fetch('/api/usuarios', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                console.log('Status da resposta:', response.status);
                
                if (!response.ok) {
                    if (response.status === 401) {
                        alert('Sess√£o expirada. Voc√™ ser√° redirecionado para o login.');
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        window.location.href = 'login.html';
                        return;
                    }
                    throw new Error(`Erro ${response.status}: ${response.statusText}`);
                }
                
                const usuarios = await response.json();
                console.log('Usu√°rios carregados:', usuarios.length);
                
                document.getElementById('usuariosLista').innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Email</th>
                                <th>Tipo</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${usuarios.map(u => `
                                <tr>
                                    <td>${u.nome}</td>
                                    <td>${u.email}</td>
                                    <td><span style="background: ${getTipoUserColor(u.tipo)}; color: white; padding: 3px 8px; border-radius: 10px; font-size: 12px;">${u.tipo.toUpperCase()}</span></td>
                                    <td><span style="color: ${u.ativo ? '#28a745' : '#dc3545'}; font-weight: bold;">${u.ativo ? '‚úÖ Ativo' : '‚ùå Inativo'}</span></td>
                                    <td>
                                        <button onclick="editarTipoUsuario(${u.id}, '${u.nome}', '${u.tipo}')" 
                                                style="background: #007bff; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px; margin-right: 5px;"
                                                title="Editar tipo do usu√°rio">
                                            ‚úèÔ∏è Editar Tipo
                                        </button>
                                        <button onclick="resetarSenhaUsuario(${u.id}, '${u.nome}')" 
                                                style="background: #ffc107; color: #000; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px; margin-right: 5px;"
                                                title="Resetar senha do usu√°rio">
                                            üîë Resetar Senha
                                        </button>
                                        ${u.ativo ? 
                                            `<button onclick="toggleUsuarioStatus(${u.id}, false, '${u.nome}')" 
                                                     style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px;"
                                                     title="Desativar usu√°rio">
                                                üö´ Desativar
                                             </button>` :
                                            `<button onclick="toggleUsuarioStatus(${u.id}, true, '${u.nome}')" 
                                                     style="background: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px;"
                                                     title="Ativar usu√°rio">
                                                ‚úÖ Ativar
                                             </button>`
                                        }
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Erro ao carregar usu√°rios:', error);
                document.getElementById('usuariosLista').innerHTML = `<p style="color: red;">Erro ao carregar usu√°rios: ${error.message}</p>`;
            }
        }

        async function mostrarModalNovoUsuario(button) {
            document.getElementById('modalNovoUsuario').style.display = 'block';
            
            // Limpar campos
            document.getElementById('novoUsuarioNome').value = '';
            document.getElementById('novoUsuarioEmail').value = '';
            document.getElementById('novoUsuarioSenha').value = '';
            document.querySelectorAll('input[name="tipoUsuario"]').forEach(r => r.checked = false);
            
            // Carregar volunt√°rios
            await carregarVoluntariosParaUsuario();
            
            // Event listener para sele√ß√£o de volunt√°rio
            document.getElementById('selecionarVoluntario').addEventListener('change', preencherDadosVoluntario);
        }

        // Carregar volunt√°rios para sele√ß√£o
        async function carregarVoluntariosParaUsuario() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/voluntarios', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const select = document.getElementById('selecionarVoluntario');
                    
                    select.innerHTML = '<option value="">Selecione um volunt√°rio</option>';
                    
                    data.voluntarios.forEach(voluntario => {
                        if (voluntario.email) { // S√≥ mostrar volunt√°rios com email
                            const option = document.createElement('option');
                            option.value = JSON.stringify(voluntario);
                            option.textContent = `${voluntario.nome} - ${voluntario.email}`;
                            select.appendChild(option);
                        }
                    });
                } else {
                    document.getElementById('selecionarVoluntario').innerHTML = '<option value="">Erro ao carregar volunt√°rios</option>';
                }
            } catch (error) {
                console.error('Erro ao carregar volunt√°rios:', error);
                document.getElementById('selecionarVoluntario').innerHTML = '<option value="">Erro ao carregar volunt√°rios</option>';
            }
        }

        // Preencher dados do volunt√°rio selecionado
        function preencherDadosVoluntario() {
            const select = document.getElementById('selecionarVoluntario');
            const voluntarioData = select.value;
            
            if (voluntarioData) {
                const voluntario = JSON.parse(voluntarioData);
                
                document.getElementById('novoUsuarioNome').value = voluntario.nome;
                document.getElementById('novoUsuarioEmail').value = voluntario.email;
                
                // Gerar senha aleat√≥ria
                const senhaAleatoria = gerarSenhaAleatoria();
                document.getElementById('novoUsuarioSenha').value = senhaAleatoria;
                
                // Selecionar tipo geral por padr√£o
                document.querySelector('input[name="tipoUsuario"][value="geral"]').checked = true;
            } else {
                // Limpar campos se nenhum volunt√°rio selecionado
                document.getElementById('novoUsuarioNome').value = '';
                document.getElementById('novoUsuarioEmail').value = '';
                document.getElementById('novoUsuarioSenha').value = '';
                document.querySelectorAll('input[name="tipoUsuario"]').forEach(r => r.checked = false);
            }
        }

        // Fun√ß√£o para gerar senha aleat√≥ria (reutilizada dos volunt√°rios)
        function gerarSenhaAleatoria() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789';
            let senha = '';
            for (let i = 0; i < 8; i++) {
                senha += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return senha;
        }
        
        function fecharModalNovoUsuario() {
            document.getElementById('modalNovoUsuario').style.display = 'none';
        }

        // Vari√°vel global para armazenar dados do usu√°rio sendo editado
        let usuarioEditandoTipo = null;

        function editarTipoUsuario(id, nome, tipoAtual) {
            usuarioEditandoTipo = { id, nome, tipoAtual };
            
            // Preencher dados no modal
            document.getElementById('editTipoUsuarioNome').value = nome;
            
            // Limpar sele√ß√µes anteriores
            document.querySelectorAll('input[name="novoTipoUsuario"]').forEach(r => r.checked = false);
            
            // Selecionar o tipo atual
            const radioAtual = document.querySelector(`input[name="novoTipoUsuario"][value="${tipoAtual}"]`);
            if (radioAtual) {
                radioAtual.checked = true;
            }
            
            // Mostrar modal
            document.getElementById('modalEditarTipoUsuario').style.display = 'block';
        }

        function fecharModalEditarTipoUsuario() {
            document.getElementById('modalEditarTipoUsuario').style.display = 'none';
            usuarioEditandoTipo = null;
        }

        async function salvarTipoUsuario() {
            if (!usuarioEditandoTipo) {
                alert('Erro: Dados do usu√°rio n√£o encontrados.');
                return;
            }

            const novoTipo = document.querySelector('input[name="novoTipoUsuario"]:checked')?.value;
            
            if (!novoTipo) {
                alert('Por favor, selecione o novo tipo de usu√°rio.');
                return;
            }

            if (novoTipo === usuarioEditandoTipo.tipoAtual) {
                alert('O tipo selecionado √© o mesmo atual. Nenhuma altera√ß√£o necess√°ria.');
                return;
            }

            // Confirma√ß√£o para altera√ß√µes cr√≠ticas
            const confirmacao = confirm(
                `Tem certeza que deseja alterar o tipo do usu√°rio "${usuarioEditandoTipo.nome}" de "${usuarioEditandoTipo.tipoAtual.toUpperCase()}" para "${novoTipo.toUpperCase()}"?\n\n` +
                `Esta a√ß√£o afetar√° as permiss√µes do usu√°rio no sistema.`
            );

            if (!confirmacao) {
                return;
            }

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/usuarios/${usuarioEditandoTipo.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ tipo: novoTipo })
                });

                if (response.ok) {
                    // Criar notifica√ß√£o de sucesso
                    const notification = document.createElement('div');
                    notification.innerHTML = `‚úÖ Tipo do usu√°rio "${usuarioEditandoTipo.nome}" alterado para "${novoTipo.toUpperCase()}" com sucesso!`;
                    notification.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #28a745;
                        color: white;
                        padding: 15px 20px;
                        border-radius: 5px;
                        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                        z-index: 10000;
                        max-width: 400px;
                        font-weight: bold;
                    `;
                    document.body.appendChild(notification);
                    
                    // Remover notifica√ß√£o ap√≥s 4 segundos
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 4000);
                    
                    fecharModalEditarTipoUsuario();
                    carregarUsuarios(); // Recarregar lista
                } else {
                    if (response.status === 401) {
                        alert('Sess√£o expirada. Voc√™ ser√° redirecionado para o login.');
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        window.location.href = 'login.html';
                        return;
                    }
                    
                    const errorData = await response.json();
                    alert(`Erro ao alterar tipo do usu√°rio: ${errorData.error || 'Erro desconhecido'}`);
                }
            } catch (error) {
                console.error('Erro ao alterar tipo do usu√°rio:', error);
                alert('Erro ao alterar tipo do usu√°rio. Verifique sua conex√£o e tente novamente.');
            }
        }
        
        function salvarNovoUsuario() {
            const nome = document.getElementById('novoUsuarioNome').value.trim();
            const email = document.getElementById('novoUsuarioEmail').value.trim();
            const senha = document.getElementById('novoUsuarioSenha').value;
            const tipo = document.querySelector('input[name="tipoUsuario"]:checked')?.value;
            
            // Obter ID do volunt√°rio selecionado
            const voluntarioSelect = document.getElementById('selecionarVoluntario');
            let voluntarioId = null;
            
            if (voluntarioSelect.value) {
                const voluntario = JSON.parse(voluntarioSelect.value);
                voluntarioId = voluntario.id;
            }
            
            // Valida√ß√µes
            if (!nome) {
                alert('Por favor, informe o nome.');
                document.getElementById('novoUsuarioNome').focus();
                return;
            }
            
            if (!email) {
                alert('Por favor, informe o e-mail.');
                document.getElementById('novoUsuarioEmail').focus();
                return;
            }
            
            if (!email.includes('@')) {
                alert('Por favor, informe um e-mail v√°lido.');
                document.getElementById('novoUsuarioEmail').focus();
                return;
            }
            
            if (!senha || senha.length < 4) {
                alert('Por favor, informe uma senha com pelo menos 4 caracteres.');
                document.getElementById('novoUsuarioSenha').focus();
                return;
            }
            
            if (!tipo) {
                alert('Por favor, selecione o tipo de usu√°rio.');
                return;
            }
            
            // Criar usu√°rio
            fetch('/api/usuarios', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json; charset=utf-8',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ nome, email, senha, tipo, voluntario_id: voluntarioId })
            }).then(async response => {
                if (response.ok) {
                    // Criar notifica√ß√£o de sucesso
                    const notification = document.createElement('div');
                    notification.innerHTML = '‚úÖ Usu√°rio criado com sucesso!';
                    notification.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #28a745;
                        color: white;
                        padding: 15px 20px;
                        border-radius: 5px;
                        font-weight: bold;
                        z-index: 2000;
                        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                    `;
                    document.body.appendChild(notification);
                    
                    // Remover ap√≥s 4 segundos
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 4000);
                    
                    fecharModalNovoUsuario();
                    carregarUsuarios();
                } else {
                    if (response.status === 401) {
                        alert('Sess√£o expirada. Voc√™ ser√° redirecionado para o login.');
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        window.location.href = 'login.html';
                        return;
                    }
                    
                    try {
                        const data = await response.json();
                        const errorMessage = data.error || `Erro ${response.status}: ${response.statusText}`;
                        alert('Erro ao criar usu√°rio: ' + errorMessage);
                    } catch (error) {
                        alert(`Erro ao criar usu√°rio: ${response.status} - ${response.statusText}`);
                    }
                }
            }).catch(error => {
                console.error('Erro:', error);
                alert('Erro de conex√£o ao criar usu√°rio');
            });
        }
        
        // Fechar modal ao clicar fora
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('modalNovoUsuario');
            if (event.target === modal) {
                fecharModalNovoUsuario();
            }
            
            const modalEditarTipo = document.getElementById('modalEditarTipoUsuario');
            if (event.target === modalEditarTipo) {
                fecharModalEditarTipoUsuario();
            }
        });
        
        // Fun√ß√£o antiga mantida para compatibilidade (n√£o ser√° mais usada)
        function criarUsuario() {
            mostrarModalNovoUsuario();
        }

        // Fun√ß√£o para obter cor do tipo de usu√°rio
        function getTipoUserColor(tipo) {
            const colors = {
                'geral': '#28a745',
                'lider': '#ffc107', 
                'administrador': '#dc3545'
            };
            return colors[tipo] || '#6c757d';
        }

        // Resetar senha de usu√°rio
        async function resetarSenhaUsuario(usuarioId, nomeUsuario) {
            const confirmacao = confirm(`Tem certeza que deseja resetar a senha do usu√°rio "${nomeUsuario}"?\n\nO usu√°rio precisar√° fazer login novamente com a nova senha.`);
            
            if (!confirmacao) {
                return;
            }
            
            const novaSenha = prompt(`Digite a nova senha para "${nomeUsuario}":\n(m√≠nimo 4 caracteres)`);
            
            if (!novaSenha) {
                return;
            }
            
            if (novaSenha.length < 4) {
                alert('A senha deve ter pelo menos 4 caracteres.');
                return;
            }
            
            try {
                const response = await fetch(`/api/usuarios/${usuarioId}/reset-senha`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json; charset=utf-8',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ novaSenha })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Criar notifica√ß√£o de sucesso
                    const notification = document.createElement('div');
                    notification.innerHTML = `üîë Senha de "${nomeUsuario}" resetada com sucesso!`;
                    notification.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #ffc107;
                        color: #000;
                        padding: 15px 20px;
                        border-radius: 5px;
                        font-weight: bold;
                        z-index: 2000;
                        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                    `;
                    document.body.appendChild(notification);
                    
                    // Remover ap√≥s 5 segundos
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 5000);
                    
                    alert(data.message);
                } else {
                    if (response.status === 401) {
                        alert('Sess√£o expirada. Voc√™ ser√° redirecionado para o login.');
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        window.location.href = 'login.html';
                        return;
                    }
                    
                    const errorMessage = data.error || `Erro ${response.status}: ${response.statusText}`;
                    alert('Erro ao resetar senha: ' + errorMessage);
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro de conex√£o ao resetar senha');
            }
        }

        // Ativar/Desativar usu√°rio
        async function toggleUsuarioStatus(usuarioId, novoStatus, nomeUsuario) {
            const acao = novoStatus ? 'ativar' : 'desativar';
            const confirmacao = confirm(`Tem certeza que deseja ${acao} o usu√°rio "${nomeUsuario}"?`);
            
            if (!confirmacao) {
                return;
            }
            
            try {
                // Primeiro, buscar os dados atuais do usu√°rio
                const responseGet = await fetch(`/api/usuarios`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const usuarios = await responseGet.json();
                const usuario = usuarios.find(u => u.id === usuarioId);
                
                if (!usuario) {
                    alert('Usu√°rio n√£o encontrado');
                    return;
                }
                
                // Atualizar apenas o status
                const response = await fetch(`/api/usuarios/${usuarioId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json; charset=utf-8',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        nome: usuario.nome,
                        email: usuario.email,
                        tipo: usuario.tipo,
                        ativo: novoStatus
                    })
                });
                
                if (response.ok) {
                    // Criar notifica√ß√£o de sucesso
                    const notification = document.createElement('div');
                    notification.innerHTML = `${novoStatus ? '‚úÖ' : 'üö´'} Usu√°rio "${nomeUsuario}" ${novoStatus ? 'ativado' : 'desativado'} com sucesso!`;
                    notification.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: ${novoStatus ? '#28a745' : '#dc3545'};
                        color: white;
                        padding: 15px 20px;
                        border-radius: 5px;
                        font-weight: bold;
                        z-index: 1000;
                        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                    `;
                    document.body.appendChild(notification);
                    
                    // Remover ap√≥s 4 segundos
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 4000);
                    
                    carregarUsuarios(); // Recarregar lista
                } else {
                    if (response.status === 401) {
                        alert('Sess√£o expirada. Voc√™ ser√° redirecionado para o login.');
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        window.location.href = 'login.html';
                        return;
                    }
                    
                    const data = await response.json().catch(() => ({}));
                    const errorMessage = data.error || `Erro ${response.status}: ${response.statusText}`;
                    alert('Erro ao alterar status: ' + errorMessage);
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro de conex√£o ao alterar status do usu√°rio');
            }
        }

        async function atualizarPessoa(button) {
            if (!pessoaSelecionada) {
                alert('Nenhuma pessoa selecionada');
                return;
            }
            
            setButtonLoading(button, true);
            
            const dadosAtualizados = {
                nome: document.getElementById('editNome').value,
                cpf: document.getElementById('editCpf').value,
                nascimento: document.getElementById('editNascimento').value,
                religiao: document.getElementById('editReligiao').value,
                cidade: document.getElementById('editCidade').value,
                estado: document.getElementById('editEstado').value,
                telefone: document.getElementById('editTelefone').value,
                email: document.getElementById('editEmail').value,
                observacao: document.getElementById('editObservacao').value
            };
            
            try {
                const response = await fetch(`/api/pessoas/${pessoaSelecionada.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json; charset=utf-8',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(dadosAtualizados)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // Criar div de notifica√ß√£o personalizada
                    const notification = document.createElement('div');
                    notification.innerHTML = '‚úÖ Dados atualizados com sucesso!';
                    notification.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #28a745;
                        color: white;
                        padding: 15px 20px;
                        border-radius: 5px;
                        font-weight: bold;
                        z-index: 1000;
                        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                    `;
                    document.body.appendChild(notification);
                    
                    // Remover ap√≥s 4 segundos
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 4000);
                    
                    // Atualizar objeto da pessoa selecionada com dados do servidor
                    if (result.pessoa) {
                        Object.assign(pessoaSelecionada, result.pessoa);
                    }
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    const errorMessage = errorData.error || `Erro ${response.status}: ${response.statusText}`;
                    
                    if (response.status === 401) {
                        alert('Sess√£o expirada. Voc√™ ser√° redirecionado para o login.');
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        window.location.href = 'login.html';
                        return;
                    }
                    
                    alert(`Erro ao atualizar dados: ${errorMessage}`);
                }
            } catch (error) {
                console.error('Erro ao atualizar pessoa:', error);
                alert('Erro de conex√£o: ' + error.message);
            } finally {
                setButtonLoading(button, false);
            }
        }

        // Fun√ß√£o logout j√° definida no in√≠cio do script - removendo duplicata

        // Testar conex√£o inicial
        async function testarConexao() {
            try {
                console.log('Testando conex√£o com servidor...');
                const response = await fetch('/api/pessoas?busca=test');
                console.log('Teste de conex√£o - Status:', response.status);
                
                if (response.ok) {
                    console.log('‚úÖ Servidor conectado com sucesso');
                } else {
                    console.warn('‚ö†Ô∏è Servidor respondeu com erro:', response.status);
                }
            } catch (error) {
                console.error('‚ùå Erro de conex√£o:', error);
                alert('ATEN√á√ÉO: N√£o foi poss√≠vel conectar ao servidor.\nVerifique se o servidor PHP est√° rodando na porta 8080.');
            }
        }
        
        // Executar teste de conex√£o
        testarConexao();
        
        // Carregar dados do perfil quando a se√ß√£o for aberta
        function carregarPerfil() {
            document.getElementById('perfilNome').value = user.nome || '';
            document.getElementById('perfilEmail').value = user.email || '';
            document.getElementById('perfilTipo').value = user.tipo ? user.tipo.toUpperCase() : '';
        }
        
        // Cancelar edi√ß√£o do perfil
        function cancelarEdicaoPerfil() {
            carregarPerfil();
            // Limpar campos de senha
            document.getElementById('senhaAtual').value = '';
            document.getElementById('novaSenha').value = '';
            document.getElementById('confirmarNovaSenha').value = '';
        }
        
        // Form de editar perfil
        document.getElementById('formPerfil').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const nome = document.getElementById('perfilNome').value.trim();
            const email = document.getElementById('perfilEmail').value.trim();
            
            if (!nome || !email) {
                alert('Nome e e-mail s√£o obrigat√≥rios.');
                return;
            }
            
            if (!email.includes('@')) {
                alert('Por favor, informe um e-mail v√°lido.');
                return;
            }
            
            try {
                const response = await fetch('/api/usuarios/perfil', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json; charset=utf-8',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ nome, email })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Atualizar dados do usu√°rio no localStorage
                    user.nome = nome;
                    user.email = email;
                    localStorage.setItem('user', JSON.stringify(user));
                    
                    // Atualizar display do nome no header
                    document.getElementById('userInfo').textContent = `${user.nome} (${user.tipo})`;
                    
                    // Mostrar sucesso
                    const notification = document.createElement('div');
                    notification.innerHTML = '‚úÖ Perfil atualizado com sucesso!';
                    notification.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #28a745;
                        color: white;
                        padding: 15px 20px;
                        border-radius: 5px;
                        font-weight: bold;
                        z-index: 2000;
                        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                    `;
                    document.body.appendChild(notification);
                    
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 4000);
                    
                } else {
                    if (response.status === 401) {
                        alert('Sess√£o expirada. Voc√™ ser√° redirecionado para o login.');
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        window.location.href = 'login.html';
                        return;
                    }
                    
                    const errorMessage = data.error || `Erro ${response.status}: ${response.statusText}`;
                    alert('Erro ao atualizar perfil: ' + errorMessage);
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro de conex√£o ao atualizar perfil');
            }
        });
        
        // Form de alterar senha
        document.getElementById('formSenha').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const senhaAtual = document.getElementById('senhaAtual').value;
            const novaSenha = document.getElementById('novaSenha').value;
            const confirmarNovaSenha = document.getElementById('confirmarNovaSenha').value;
            
            // Se n√£o preencheu nenhum campo de senha, n√£o fazer nada
            if (!senhaAtual && !novaSenha && !confirmarNovaSenha) {
                alert('Preencha os campos de senha para alter√°-la.');
                return;
            }
            
            if (!senhaAtual) {
                alert('Senha atual √© obrigat√≥ria.');
                return;
            }
            
            if (!novaSenha) {
                alert('Nova senha √© obrigat√≥ria.');
                return;
            }
            
            if (novaSenha.length < 4) {
                alert('Nova senha deve ter pelo menos 4 caracteres.');
                return;
            }
            
            if (novaSenha !== confirmarNovaSenha) {
                alert('As senhas n√£o coincidem.');
                return;
            }
            
            try {
                const nome = document.getElementById('perfilNome').value.trim();
                const email = document.getElementById('perfilEmail').value.trim();
                
                const response = await fetch('/api/usuarios/perfil', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json; charset=utf-8',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ nome, email, senhaAtual, novaSenha })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Atualizar dados do usu√°rio no localStorage
                    user.nome = nome;
                    user.email = email;
                    localStorage.setItem('user', JSON.stringify(user));
                    
                    // Limpar campos de senha
                    document.getElementById('senhaAtual').value = '';
                    document.getElementById('novaSenha').value = '';
                    document.getElementById('confirmarNovaSenha').value = '';
                    
                    // Mostrar sucesso
                    const notification = document.createElement('div');
                    notification.innerHTML = 'üîë Perfil e senha atualizados com sucesso!';
                    notification.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #ffc107;
                        color: #000;
                        padding: 15px 20px;
                        border-radius: 5px;
                        font-weight: bold;
                        z-index: 2000;
                        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                    `;
                    document.body.appendChild(notification);
                    
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 5000);
                    
                    alert(data.message + '\nSuas outras sess√µes foram invalidadas por seguran√ßa.');
                    
                } else {
                    alert('Erro ao alterar senha: ' + (data.error || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro de conex√£o ao alterar senha');
            }
        });
        
        // Vari√°veis globais para duplicatas
        let gruposDuplicatas = [];
        let mesclagem_atual = null;
        
        // Mostrar estat√≠sticas de performance
        async function mostrarEstatisticas() {
            try {
                const response = await fetch('/api/duplicatas/stats', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const stats = await response.json();
                    
                    return `
                        <div style="background: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <h4 style="margin: 0 0 10px 0; color: #495057;">üìä Estat√≠sticas do Sistema</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 10px;">
                                <div><strong>Total de pessoas:</strong> ${stats.total_pessoas.toLocaleString()}</div>
                                <div><strong>Total de frequ√™ncias:</strong> ${stats.total_frequencias.toLocaleString()}</div>
                                <div><strong>Pessoas ativas:</strong> ${stats.pessoas_com_frequencia.toLocaleString()}</div>
                            </div>
                            <div style="background: #e7f3ff; padding: 10px; border-radius: 5px; border-left: 4px solid #007bff;">
                                <strong>üí° Recomenda√ß√µes de Performance:</strong><br>
                                ‚Ä¢ M√°ximo recomendado por mesclagem: <strong>${stats.recomendacoes.max_mesclagem_simultanea} pessoas</strong><br>
                                ‚Ä¢ Tamanho ideal de lote: <strong>${stats.recomendacoes.lote_recomendado} pessoas</strong><br>
                                ‚Ä¢ Timeout sugerido: <strong>${stats.recomendacoes.timeout_sugerido}</strong><br>
                                ‚Ä¢ Cache de an√°lise: <strong>${stats.recomendacoes.cache_duracao}</strong>
                            </div>
                            ${stats.cache ? `
                                <div style="background: ${stats.cache.cache_ativo ? '#d4edda' : '#f8d7da'}; padding: 10px; border-radius: 5px; border-left: 4px solid ${stats.cache.cache_ativo ? '#28a745' : '#dc3545'}; margin-top: 10px;">
                                    <strong>üóÑÔ∏è Status do Cache:</strong><br>
                                    ‚Ä¢ Estado: <strong>${stats.cache.cache_ativo ? 'Ativo' : 'Inativo'}</strong><br>
                                    ${stats.cache.cache_ativo ? `
                                        ‚Ä¢ Gerado em: <strong>${stats.cache.cache_timestamp}</strong><br>
                                        ‚Ä¢ Limiar usado: <strong>${(stats.cache.cache_threshold * 100).toFixed(0)}%</strong><br>
                                        ‚Ä¢ Expira em: <strong>${stats.cache.cache_expira_em}s</strong><br>
                                        <button onclick="limparCache()" style="background: #ffc107; color: #212529; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px; margin-top: 5px;">
                                            üóëÔ∏è Limpar Cache
                                        </button>
                                    ` : '‚Ä¢ Use "Analisar Duplicatas" para gerar cache'}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
            } catch (error) {
                console.warn('N√£o foi poss√≠vel carregar estat√≠sticas:', error);
            }
            return '';
        }

        // Analisar duplicatas com estat√≠sticas e progresso
        async function analisarDuplicatas(button) {
            setButtonLoading(button, true);
            console.log('üîç Fun√ß√£o analisarDuplicatas() chamada');
            
            // Verificar se ProgressTimer est√° dispon√≠vel
            let usarProgresso = typeof progressTimer !== 'undefined';
            if (!usarProgresso) {
                console.warn('‚ö†Ô∏è ProgressTimer n√£o est√° dispon√≠vel, usando modo simples');
            }
            
            const threshold = document.getElementById('thresholdSimilaridade').value;
            console.log('üìä Threshold selecionado:', threshold);
            
            // Verificar se token est√° dispon√≠vel
            if (!token) {
                console.error('‚ùå Token de autentica√ß√£o n√£o encontrado');
                alert('Erro: Sess√£o expirada. Fa√ßa login novamente.');
                window.location.href = 'login.html';
                return;
            }
            
            // Verificar se usu√°rio √© administrador
            if (user.tipo !== 'administrador') {
                alert('Erro: Apenas administradores podem analisar duplicatas.');
                return;
            }
            
            // Criar temporizador de progresso para an√°lise (se dispon√≠vel)
            let timerId = null;
            if (usarProgresso) {
                timerId = progressTimer.create({
                    title: 'Analisando Duplicatas',
                    message: 'Carregando estat√≠sticas do sistema...',
                    estimatedTime: 15,
                    steps: [
                        { text: 'Carregando estat√≠sticas' },
                        { text: 'Consultando cadastros' },
                        { text: 'Calculando similaridades' },
                        { text: 'Agrupando duplicatas' },
                        { text: 'Formatando resultados' }
                    ]
                });
            }
            
            try {
                // Mostrar loading inicial
                document.getElementById('resumoDuplicatas').innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <div style="font-size: 18px; color: #007bff;">üîç Preparando an√°lise...</div>
                        <div style="font-size: 14px; color: #666; margin-top: 10px;">Carregando informa√ß√µes do sistema</div>
                    </div>
                `;
                document.getElementById('resultadoDuplicatas').style.display = 'block';
                
                // Carregar estat√≠sticas
                if (usarProgresso && timerId) {
                    progressTimer.nextStep(timerId);
                }
                const statsHtml = await mostrarEstatisticas();
                await new Promise(resolve => setTimeout(resolve, 800));

                if (usarProgresso && timerId) {
                    progressTimer.update(timerId, { message: 'Iniciando an√°lise de duplicatas...' });
                    progressTimer.nextStep(timerId);
                }
                
                console.log('Iniciando an√°lise de duplicatas com threshold:', threshold);
                
                const response = await fetch(`/api/duplicatas?threshold=${threshold}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Erro na resposta:', errorText);
                    
                    if (response.status === 401) {
                        alert('Sess√£o expirada. Voc√™ ser√° redirecionado para o login.');
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        window.location.href = 'login.html';
                        return;
                    }
                    
                    // Tratar erro 503 (Service Unavailable) de forma especial
                    if (response.status === 503) {
                        const errorData = JSON.parse(errorText);
                        const resultadoDiv = document.getElementById('resultadoDuplicatas');
                        
                        resultadoDiv.innerHTML = `
                            <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 20px; border-radius: 8px; margin: 20px 0;">
                                <h3 style="color: #856404; margin: 0 0 15px 0;">‚ö†Ô∏è Funcionalidade Temporariamente Indispon√≠vel</h3>
                                <div style="color: #856404; line-height: 1.6;">
                                    <p><strong>üìã Status:</strong> ${errorData.details?.status || 'Em desenvolvimento'}</p>
                                    <p><strong>üìÖ Previs√£o:</strong> ${errorData.details?.previsao || 'Pr√≥xima atualiza√ß√£o'}</p>
                                    <p><strong>üí° Alternativa:</strong> ${errorData.details?.alternativa || 'Use a busca manual'}</p>
                                    <hr style="margin: 15px 0; border: none; border-top: 1px solid #ffeaa7;">
                                    <p style="margin: 0;"><strong>Mensagem:</strong> ${errorData.message}</p>
                                </div>
                                <div style="margin-top: 20px; text-align: center;">
                                    <button onclick="document.getElementById('resultadoDuplicatas').innerHTML=''" 
                                            style="background: #ffc107; color: #212529; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                                        ‚úÖ Entendi
                                    </button>
                                </div>
                            </div>
                        `;
                        
                        console.log('‚ÑπÔ∏è Funcionalidade indispon√≠vel:', errorData.message);
                        return; // N√£o lan√ßar erro, apenas mostrar a mensagem
                    }
                    
                    throw new Error(`Erro ${response.status}: ${response.statusText}\n${errorText}`);
                }
                
                if (usarProgresso && timerId) {
                    progressTimer.update(timerId, { message: 'Processando dados recebidos...' });
                    progressTimer.nextStep(timerId);
                }
                
                const dados = await response.json();
                console.log('Dados recebidos:', dados);
                gruposDuplicatas = dados.grupos;
                
                await new Promise(resolve => setTimeout(resolve, 600));
                
                if (usarProgresso && timerId) {
                    progressTimer.update(timerId, { message: 'Agrupando duplicatas encontradas...' });
                    progressTimer.nextStep(timerId);
                }
                
                await new Promise(resolve => setTimeout(resolve, 400));
                
                if (usarProgresso && timerId) {
                    progressTimer.update(timerId, { message: 'Formatando interface...' });
                    progressTimer.nextStep(timerId);
                }
                
                // Incluir estat√≠sticas no resumo
                const resumoComStats = statsHtml + `
                    <h4 style="margin-top: 0; color: #007bff;">üìä Resultado da An√°lise</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div style="background: white; padding: 15px; border-radius: 5px; text-align: center; border-left: 4px solid #dc3545;">
                            <div style="font-size: 24px; font-weight: bold; color: #dc3545;">${dados.total_grupos}</div>
                            <div style="color: #666;">Grupos de Duplicatas</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 5px; text-align: center; border-left: 4px solid #ffc107;">
                            <div style="font-size: 24px; font-weight: bold; color: #ffc107;">${dados.total_pessoas_duplicadas}</div>
                            <div style="color: #666;">Pessoas Envolvidas</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 5px; text-align: center; border-left: 4px solid #28a745;">
                            <div style="font-size: 24px; font-weight: bold; color: #28a745;">${(dados.threshold_usado * 100).toFixed(0)}%</div>
                            <div style="color: #666;">Limiar Usado</div>
                        </div>
                    </div>
                `;
                
                // Mostrar resumo
                document.getElementById('resumoDuplicatas').innerHTML = resumoComStats;
                
                // Mostrar lista de grupos
                if (dados.total_grupos === 0) {
                    document.getElementById('listaDuplicatas').innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #28a745;">
                            <h3>‚úÖ Nenhuma duplicata encontrada!</h3>
                            <p>Com o limiar de ${(dados.threshold_usado * 100).toFixed(0)}%, n√£o foram encontradas pessoas com nomes similares.</p>
                            <p style="color: #666; font-size: 14px;">Tente reduzir o limiar se suspeitar de duplicatas.</p>
                        </div>
                    `;
                } else {
                    let html = '<h4>üîç Grupos de Poss√≠veis Duplicatas</h4>';
                    
                    dados.grupos.forEach((grupo, index) => {
                        html += `
                            <div style="border: 1px solid #ddd; border-radius: 8px; margin-bottom: 20px; background: white;">
                                <div style="background: #f8f9fa; padding: 15px; border-bottom: 1px solid #ddd; border-radius: 8px 8px 0 0;">
                                    <h5 style="margin: 0; color: #dc3545;">
                                        Grupo ${index + 1} - Similaridade: ${(grupo.similaridade_media * 100).toFixed(1)}%
                                        <span style="float: right;">
                                            <button onclick="visualizarGrupo('${grupo.id}', [${grupo.pessoas.map(p => p.id).join(',')}])" 
                                                    style="background: #007bff; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px;">
                                                üëÅÔ∏è Visualizar
                                            </button>
                                        </span>
                                    </h5>
                                </div>
                                <div style="padding: 15px;">
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                                        ${grupo.pessoas.map(pessoa => `
                                            <div style="border: 1px solid #e9ecef; border-radius: 5px; padding: 10px;">
                                                <div style="font-weight: bold; color: #007bff;">${pessoa.nome}</div>
                                                <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                                    ID: ${pessoa.id} | 
                                                    Frequ√™ncias: ${pessoa.total_frequencias || 0} | 
                                                    ${pessoa.cidade || 'Cidade n√£o informada'}
                                                </div>
                                                <div style="font-size: 11px; color: #999; margin-top: 3px;">
                                                    ${pessoa.telefone ? `üìû ${pessoa.telefone}` : 'üìû N√£o informado'} | 
                                                    ${pessoa.email ? `üìß ${pessoa.email}` : 'üìß N√£o informado'}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    document.getElementById('listaDuplicatas').innerHTML = html;
                }
                
                await new Promise(resolve => setTimeout(resolve, 300));
                
                if (usarProgresso && timerId) {
                    progressTimer.complete(timerId, { 
                        message: `An√°lise conclu√≠da! ${dados.total_grupos} grupos encontrados.`
                    });
                }
                
                document.getElementById('resultadoDuplicatas').style.display = 'block';
                
            } catch (error) {
                if (usarProgresso && timerId) {
                    progressTimer.remove(timerId);
                }
                
                // Verificar se √© erro 503 (Service Unavailable) - n√£o √© um erro real
                if (error.message && error.message.includes('503')) {
                    console.log('‚ÑπÔ∏è Funcionalidade temporariamente indispon√≠vel:', error.message);
                    // N√£o mostrar como erro, pois j√° foi tratado no c√≥digo anterior
                    return;
                }
                
                // Para outros erros reais, mostrar na interface
                console.error('Erro ao analisar duplicatas:', error);
                document.getElementById('resumoDuplicatas').innerHTML = `
                    <div style="background: #f8d7da; border: 1px solid #f5c6cb; padding: 20px; border-radius: 8px; text-align: center;">
                        <h4 style="color: #721c24; margin-top: 0;">‚ùå Erro na An√°lise</h4>
                        <p style="color: #721c24; margin-bottom: 10px;">N√£o foi poss√≠vel analisar as duplicatas.</p>
                        <details style="text-align: left; margin-top: 15px;">
                            <summary style="cursor: pointer; color: #721c24; font-weight: bold;">Detalhes do erro</summary>
                            <pre style="background: #fff; padding: 10px; border-radius: 5px; margin-top: 10px; font-size: 12px; overflow-x: auto;">${error.message}</pre>
                        </details>
                        <div style="margin-top: 15px;">
                            <button onclick="analisarDuplicatas(this)" style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                                üîÑ Tentar Novamente
                            </button>
                        </div>
                    </div>
                `;
                document.getElementById('listaDuplicatas').innerHTML = '';
            } finally {
                setButtonLoading(button, false);
            }
        }
        
        // Limpar cache de duplicatas
        async function limparCache() {
            if (!confirm('Tem certeza que deseja limpar o cache de duplicatas?\n\nIsso far√° com que a pr√≥xima an√°lise seja mais lenta.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/duplicatas/cache', {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const resultado = await response.json();
                    alert(`‚úÖ ${resultado.message}\n\nCache limpo em: ${resultado.timestamp}\n\nüí° Execute "Analisar Duplicatas" novamente para gerar um novo cache.`);
                } else {
                    const error = await response.json();
                    alert('Erro ao limpar cache: ' + error.error);
                }
                
            } catch (error) {
                console.error('Erro ao limpar cache:', error);
                alert('Erro de conex√£o ao limpar cache');
            }
        }
        
        // Visualizar detalhes de um grupo
        async function visualizarGrupo(grupoId, pessoaIds) {
            try {
                const response = await fetch(`/api/duplicatas/grupo/${grupoId}?pessoaIds=${pessoaIds.join(',')}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) {
                    throw new Error(`Erro ${response.status}: ${response.statusText}`);
                }
                
                const dados = await response.json();
                mostrarModalMesclagem(dados);
                
            } catch (error) {
                console.error('Erro ao visualizar grupo:', error);
                alert('Erro ao carregar detalhes: ' + error.message);
            }
        }
        
        // Mostrar modal de mesclagem
        function mostrarModalMesclagem(dados) {
            mesclagem_atual = dados;
            
            // Encontrar pessoa principal e secund√°rias
            const pessoaPrincipal = dados.pessoas.find(p => p.id == dados.pessoa_principal_sugerida);
            const pessoasSecundarias = dados.pessoas.filter(p => p.id != dados.pessoa_principal_sugerida);
            
            if (!pessoaPrincipal) {
                console.error('Pessoa principal n√£o encontrada:', dados);
                alert('Erro: Pessoa principal n√£o encontrada nos dados');
                return;
            }
            
            let html = `
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #28a745;">‚úÖ Pessoa Principal (ser√° mantida)</h4>
                    <div style="background: #d4edda; border: 1px solid #c3e6cb; padding: 15px; border-radius: 5px;">
                        <strong>${pessoaPrincipal.nome}</strong> (ID: ${pessoaPrincipal.id})<br>
                        <small>Frequ√™ncias: ${pessoaPrincipal.total_frequencias || 0}</small><br>
                        ${pessoaPrincipal.telefone ? `<small>üìû ${pessoaPrincipal.telefone}</small><br>` : ''}
                        ${pessoaPrincipal.email ? `<small>üìß ${pessoaPrincipal.email}</small><br>` : ''}
                        ${pessoaPrincipal.cpf ? `<small>üÜî ${pessoaPrincipal.cpf}</small>` : ''}
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #dc3545;">‚ùå Pessoas que ser√£o removidas</h4>
                    ${pessoasSecundarias.map(pessoa => `
                        <div style="background: #f8d7da; border: 1px solid #f5c6cb; padding: 10px; border-radius: 5px; margin-bottom: 5px;">
                            <strong>${pessoa.nome}</strong> (ID: ${pessoa.id})<br>
                            <small>Frequ√™ncias: ${pessoa.total_frequencias || 0} (ser√£o transferidas)</small><br>
                            ${pessoa.telefone ? `<small>üìû ${pessoa.telefone}</small><br>` : ''}
                            ${pessoa.email ? `<small>üìß ${pessoa.email}</small><br>` : ''}
                            ${pessoa.cpf ? `<small>üÜî ${pessoa.cpf}</small>` : ''}
                        </div>
                    `).join('')}
                </div>
                
                ${dados.campos_conflitantes && dados.campos_conflitantes.length > 0 ? `
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #ffc107;">‚ö†Ô∏è Campos Conflitantes</h4>
                        <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 5px;">
                            ${dados.campos_conflitantes.map(conflito => `
                                <div style="margin-bottom: 8px;">
                                    <strong>${conflito.campo}:</strong> ${conflito.quantidade} valores diferentes
                                    <div style="font-size: 12px; color: #856404;">
                                        ${conflito.valores.join(', ')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #007bff;">üîÑ Dados ap√≥s mesclagem (mais completos)</h4>
                    <div style="background: #d1ecf1; border: 1px solid #bee5eb; padding: 15px; border-radius: 5px;">
                        ${dados.dados_mesclados ? `
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; font-size: 14px;">
                                <div><strong>Nome:</strong> ${dados.dados_mesclados.nome || 'N/A'}</div>
                                <div><strong>CPF:</strong> ${dados.dados_mesclados.cpf || 'N/A'}</div>
                                <div><strong>Telefone:</strong> ${dados.dados_mesclados.telefone || 'N/A'}</div>
                                <div><strong>E-mail:</strong> ${dados.dados_mesclados.email || 'N/A'}</div>
                                <div><strong>Cidade:</strong> ${dados.dados_mesclados.cidade || 'N/A'}</div>
                                <div><strong>Estado:</strong> ${dados.dados_mesclados.estado || 'N/A'}</div>
                                <div><strong>Religi√£o:</strong> ${dados.dados_mesclados.religiao || 'N/A'}</div>
                                <div><strong>Nascimento:</strong> ${dados.dados_mesclados.nascimento || 'N/A'}</div>
                                <div><strong>Indica√ß√£o:</strong> ${dados.dados_mesclados.indicacao || 'N/A'}</div>
                            </div>
                            ${dados.dados_mesclados.observacao ? `
                                <div style="margin-top: 10px;">
                                    <strong>Observa√ß√µes:</strong><br>
                                    <small>${dados.dados_mesclados.observacao}</small>
                                </div>
                            ` : ''}
                            <div style="margin-top: 15px; padding: 10px; background: #e7f3ff; border-radius: 5px; font-size: 12px; color: #0066cc;">
                                <strong>üí° Mesclagem Inteligente:</strong> Os dados foram combinados automaticamente para criar o registro mais completo poss√≠vel, 
                                preenchendo campos vazios com informa√ß√µes das outras pessoas e priorizando dados mais confi√°veis.
                            </div>
                        ` : `
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; font-size: 14px;">
                                <div><strong>Nome:</strong> ${pessoaPrincipal.nome || 'N/A'}</div>
                                <div><strong>CPF:</strong> ${pessoaPrincipal.cpf || 'N/A'}</div>
                                <div><strong>Telefone:</strong> ${pessoaPrincipal.telefone || 'N/A'}</div>
                                <div><strong>E-mail:</strong> ${pessoaPrincipal.email || 'N/A'}</div>
                                <div><strong>Cidade:</strong> ${pessoaPrincipal.cidade || 'N/A'}</div>
                                <div><strong>Estado:</strong> ${pessoaPrincipal.estado || 'N/A'}</div>
                                <div><strong>Religi√£o:</strong> ${pessoaPrincipal.religiao || 'N/A'}</div>
                            </div>
                        `}
                    </div>
                </div>
                
                <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 5px;">
                    <strong>‚ö†Ô∏è Resumo da opera√ß√£o:</strong><br>
                    ‚Ä¢ ${pessoasSecundarias.length} pessoa(s) ser√°(√£o) removida(s)<br>
                    ‚Ä¢ ${pessoasSecundarias.reduce((total, p) => total + (p.total_frequencias || 0), 0)} frequ√™ncia(s) ser√°(√£o) transferida(s)<br>
                    ‚Ä¢ Todos os dados ser√£o preservados na pessoa principal<br>
                    ‚Ä¢ <strong style="color: #dc3545;">Esta opera√ß√£o n√£o pode ser desfeita!</strong>
                </div>
            `;
            
            document.getElementById('conteudoMesclagem').innerHTML = html;
            document.getElementById('modalMesclagem').style.display = 'block';
        }
        
        // Fechar modal de mesclagem
        function fecharModalMesclagem() {
            document.getElementById('modalMesclagem').style.display = 'none';
            mesclagem_atual = null;
        }
        
        // Confirmar mesclagem com sistema de progresso otimizado
        async function confirmarMesclagem() {
            if (!mesclagem_atual) return;
            
            const pessoasSecundarias = mesclagem_atual.pessoas.filter(p => p.id != mesclagem_atual.pessoa_principal_sugerida);
            const totalPessoas = pessoasSecundarias.length;
            
            // Verificar se h√° muitas pessoas para mesclar
            if (totalPessoas > 7) {
                const confirmacao = confirm(`‚ö†Ô∏è ATEN√á√ÉO: Voc√™ est√° tentando mesclar ${totalPessoas} pessoas de uma vez.\n\nPara melhor performance, recomendamos mesclar no m√°ximo 7 pessoas por vez.\n\nDeseja continuar mesmo assim?`);
                if (!confirmacao) return;
            } else {
                const confirmacao = confirm(`ATEN√á√ÉO: Esta opera√ß√£o ir√° mesclar ${totalPessoas} cadastros permanentemente.\n\nTem certeza que deseja continuar?`);
                if (!confirmacao) return;
            }
            
            // Criar temporizador de progresso para mesclagem
            const timerId = progressTimer.create({
                title: 'Mesclando Cadastros',
                message: `Processando mesclagem de ${totalPessoas} pessoas...`,
                estimatedTime: Math.max(5, totalPessoas * 2), // 2 segundos por pessoa, m√≠nimo 5
                steps: [
                    { text: 'Validando dados' },
                    { text: 'Iniciando transa√ß√£o' },
                    { text: 'Transferindo frequ√™ncias' },
                    { text: 'Removendo duplicatas' },
                    { text: 'Finalizando mesclagem' }
                ],
                cancelable: false // Mesclagem n√£o pode ser cancelada uma vez iniciada
            });
            
            try {
                progressTimer.nextStep(timerId);
                await new Promise(resolve => setTimeout(resolve, 500));

                progressTimer.update(timerId, { message: 'Enviando dados para o servidor...' });
                progressTimer.nextStep(timerId);

                const response = await fetch('/api/duplicatas/mesclar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json; charset=utf-8',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        pessoa_principal_id: mesclagem_atual.pessoa_principal_sugerida,
                        pessoas_secundarias_ids: pessoasSecundarias.map(p => p.id),
                        dados_mesclados: {}
                    })
                });
                
                const resultado = await response.json();
                
                if (response.status === 401) {
                    progressTimer.remove(timerId);
                    alert('Sess√£o expirada. Voc√™ ser√° redirecionado para o login.');
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    window.location.href = 'login.html';
                    return;
                }
                
                if (response.ok) {
                    progressTimer.update(timerId, { message: 'Processando transfer√™ncias...' });
                    progressTimer.nextStep(timerId);
                    await new Promise(resolve => setTimeout(resolve, 800));

                    progressTimer.update(timerId, { message: 'Limpando registros duplicados...' });
                    progressTimer.nextStep(timerId);
                    await new Promise(resolve => setTimeout(resolve, 600));

                    progressTimer.update(timerId, { message: 'Atualizando interface...' });
                    progressTimer.nextStep(timerId);
                    await new Promise(resolve => setTimeout(resolve, 400));

                    // Mostrar detalhes do resultado
                    let mensagemSucesso = `‚úÖ Mesclagem realizada com sucesso!\n\n${resultado.message}`;
                    if (resultado.pessoas_removidas) {
                        mensagemSucesso += `\nPessoas removidas: ${resultado.pessoas_removidas}`;
                    }
                    if (resultado.total_frequencias_transferidas) {
                        mensagemSucesso += `\nFrequ√™ncias transferidas: ${resultado.total_frequencias_transferidas}`;
                    }
                    if (resultado.detalhes && resultado.detalhes.lotes_processados) {
                        mensagemSucesso += `\nProcessamento: ${resultado.detalhes.lotes_processados} lotes`;
                    }

                    progressTimer.complete(timerId, { 
                        message: `Mesclagem conclu√≠da! ${resultado.pessoas_removidas} pessoas processadas.`
                    });
                    
                    // Mostrar resultado detalhado ap√≥s o progresso
                    setTimeout(() => {
                        alert(mensagemSucesso);
                        fecharModalMesclagem();
                        // Cache foi limpo automaticamente no backend ap√≥s a mesclagem
                    }, 2000);
                    
                } else {
                    progressTimer.remove(timerId);
                    
                    // Mostrar erro mais detalhado
                    let mensagemErro = 'Erro ao mesclar: ' + (resultado.error || 'Erro desconhecido');
                    if (resultado.sugestao) {
                        mensagemErro += '\n\nüí° Sugest√£o: ' + resultado.sugestao;
                    }
                    if (resultado.tipo_erro === 'timeout') {
                        mensagemErro += '\n\n‚è±Ô∏è A opera√ß√£o demorou muito. Tente com menos pessoas por vez.';
                    }
                    
                    alert(mensagemErro);
                }
                
            } catch (error) {
                console.error('Erro ao mesclar:', error);
                progressTimer.remove(timerId);
                
                let mensagemErro = 'Erro de conex√£o ao mesclar cadastros';
                if (error.message.includes('timeout')) {
                    mensagemErro += '\n\n‚è±Ô∏è A opera√ß√£o demorou muito para responder. Verifique sua conex√£o e tente novamente.';
                }
                
                alert(mensagemErro);
            }
        }
        
        // Fechar modal ao clicar fora
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('modalMesclagem');
            if (event.target === modal) {
                fecharModalMesclagem();
            }
        });
        
        // ===== FUN√á√ïES DE CADASTRO =====
        
        // Fun√ß√£o para cadastrar nova pessoa
        async function cadastrarPessoa(button) {
            const resultado = document.getElementById('cadastroResultado');
            
            // Validar campos obrigat√≥rios
            const nome = document.getElementById('cadastroNome').value.trim();
            if (!nome) {
                resultado.innerHTML = '<div style="color: red; padding: 10px; background: #ffe6e6; border-radius: 5px;">‚ùå Nome √© obrigat√≥rio!</div>';
                return;
            }
            
            if (nome.length < 3) {
                resultado.innerHTML = '<div style="color: red; padding: 10px; background: #ffe6e6; border-radius: 5px;">‚ùå Nome deve ter pelo menos 3 caracteres!</div>';
                return;
            }
            
            // Validar CPF se fornecido
            const cpf = document.getElementById('cadastroCpf').value.trim();
            if (cpf && !validarCPF(cpf)) {
                resultado.innerHTML = '<div style="color: red; padding: 10px; background: #ffe6e6; border-radius: 5px;">‚ùå CPF inv√°lido!</div>';
                return;
            }
            
            // Validar email se fornecido
            const email = document.getElementById('cadastroEmail').value.trim();
            if (email && !validarEmail(email)) {
                resultado.innerHTML = '<div style="color: red; padding: 10px; background: #ffe6e6; border-radius: 5px;">‚ùå E-mail inv√°lido!</div>';
                return;
            }
            
            // Preparar dados
            const dadosPessoa = {
                nome: nome,
                cpf: cpf,
                nascimento: document.getElementById('cadastroNascimento').value,
                religiao: document.getElementById('cadastroReligiao').value.trim(),
                cidade: document.getElementById('cadastroCidade').value.trim(),
                estado: document.getElementById('cadastroEstado').value,
                telefone: document.getElementById('cadastroTelefone').value.trim(),
                email: email,
                indicacao: document.getElementById('cadastroIndicacao').value.trim(),
                observacao: document.getElementById('cadastroObservacao').value.trim()
            };
            
            // Criar temporizador de progresso
            const timerId = progressTimer.create({
                title: 'Cadastrando Pessoa',
                message: 'Validando e salvando dados...',
                estimatedTime: 3,
                steps: [
                    { text: 'Validando dados' },
                    { text: 'Verificando duplicatas' },
                    { text: 'Salvando no banco' },
                    { text: 'Finalizando cadastro' }
                ]
            });
            
            try {
                progressTimer.nextStep(timerId);
                await new Promise(resolve => setTimeout(resolve, 500));
                
                progressTimer.update(timerId, { message: 'Enviando dados para o servidor...' });
                progressTimer.nextStep(timerId);
                
                const response = await fetch('/api/pessoas', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dadosPessoa)
                });
                
                if (response.ok) {
                    progressTimer.update(timerId, { message: 'Finalizando cadastro...' });
                    progressTimer.nextStep(timerId);
                    
                    await new Promise(resolve => setTimeout(resolve, 300));
                    
                    const data = await response.json();
                    
                    progressTimer.complete(timerId, { 
                        message: 'Pessoa cadastrada com sucesso!' 
                    });
                    
                    resultado.innerHTML = `
                        <div style="color: green; padding: 15px; background: #e6ffe6; border-radius: 5px; margin-top: 10px;">
                            <h4>‚úÖ Cadastro realizado com sucesso!</h4>
                            <p><strong>ID:</strong> ${data.pessoa.id}</p>
                            <p><strong>Nome:</strong> ${data.pessoa.nome}</p>
                            <p><strong>Cidade:</strong> ${data.pessoa.cidade || 'N√£o informada'}</p>
                        </div>
                    `;
                    
                    // Limpar formul√°rio ap√≥s sucesso
                    setTimeout(() => {
                        limparFormularioCadastro();
                        resultado.innerHTML = '';
                    }, 3000);
                    
                } else {
                    const error = await response.json();
                    progressTimer.remove(timerId);
                    
                    let mensagemErro = error.error || 'Erro desconhecido';
                    if (error.code === 'CPF_EXISTS') {
                        mensagemErro = 'CPF j√° cadastrado no sistema!';
                    }
                    
                    resultado.innerHTML = `<div style="color: red; padding: 10px; background: #ffe6e6; border-radius: 5px;">‚ùå ${mensagemErro}</div>`;
                }
            } catch (error) {
                progressTimer.remove(timerId);
                console.error('Erro ao cadastrar pessoa:', error);
                resultado.innerHTML = `<div style="color: red; padding: 10px; background: #ffe6e6; border-radius: 5px;">‚ùå Erro de conex√£o: ${error.message}</div>`;
            }
        }
        
        // Fun√ß√£o para limpar formul√°rio de cadastro
        function limparFormularioCadastro() {
            document.getElementById('cadastroNome').value = '';
            document.getElementById('cadastroCpf').value = '';
            document.getElementById('cadastroNascimento').value = '';
            document.getElementById('cadastroReligiao').value = '';
            document.getElementById('cadastroCidade').value = '';
            document.getElementById('cadastroEstado').value = '';
            document.getElementById('cadastroTelefone').value = '';
            document.getElementById('cadastroEmail').value = '';
            document.getElementById('cadastroIndicacao').value = '';
            document.getElementById('cadastroObservacao').value = '';
        }
        
        // Fun√ß√£o para validar CPF
        function validarCPF(cpf) {
            cpf = cpf.replace(/[^\d]/g, '');
            
            if (cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) {
                return false;
            }
            
            let soma = 0;
            for (let i = 0; i < 9; i++) {
                soma += parseInt(cpf.charAt(i)) * (10 - i);
            }
            let resto = 11 - (soma % 11);
            if (resto === 10 || resto === 11) resto = 0;
            if (resto !== parseInt(cpf.charAt(9))) return false;
            
            soma = 0;
            for (let i = 0; i < 10; i++) {
                soma += parseInt(cpf.charAt(i)) * (11 - i);
            }
            resto = 11 - (soma % 11);
            if (resto === 10 || resto === 11) resto = 0;
            if (resto !== parseInt(cpf.charAt(10))) return false;
            
            return true;
        }
        
        // Fun√ß√£o para validar email
        function validarEmail(email) {
            const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return regex.test(email);
        }
        
        // M√°scara para CPF
        document.getElementById('cadastroCpf').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            value = value.replace(/(\d{3})(\d)/, '$1.$2');
            value = value.replace(/(\d{3})(\d)/, '$1.$2');
            value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
            e.target.value = value;
        });
        
        // M√°scara para telefone
        document.getElementById('cadastroTelefone').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length <= 10) {
                value = value.replace(/(\d{2})(\d)/, '($1) $2');
                value = value.replace(/(\d{4})(\d)/, '$1-$2');
            } else {
                value = value.replace(/(\d{2})(\d)/, '($1) $2');
                value = value.replace(/(\d{5})(\d)/, '$1-$2');
            }
            e.target.value = value;
        });
        
        // Ocultar se√ß√µes baseado no tipo de usu√°rio
        if (user.tipo === 'geral') {
            document.querySelector('button[onclick="showSection(\'voluntarios\')"]').style.display = 'none';
            document.querySelector('button[onclick="showSection(\'relatorios\')"]').style.display = 'none';
            document.querySelector('button[onclick="showSection(\'usuarios\')"]').style.display = 'none';
            document.querySelector('button[onclick="showSection(\'duplicatas\')"]').style.display = 'none';
            document.querySelector('button[onclick="abrirBackup()"]').style.display = 'none';
        }
        
        // Controlar visibilidade do bot√£o de relat√≥rio de volunt√°rios
        const btnRelatorioVoluntarios = document.getElementById('btnRelatorioVoluntarios');
        if (btnRelatorioVoluntarios) {
            if (user.tipo === 'administrador' || user.tipo === 'lider') {
                btnRelatorioVoluntarios.style.display = 'inline-block';
            } else {
                btnRelatorioVoluntarios.style.display = 'none';
            }
        } else if (user.tipo === 'lider') {
            document.querySelector('button[onclick="showSection(\'usuarios\')"]').style.display = 'none';
            document.querySelector('button[onclick="showSection(\'duplicatas\')"]').style.display = 'none';
            document.querySelector('button[onclick="abrirBackup()"]').style.display = 'none';
        }
        
        // Configurar evento para carregar cidades baseado no estado selecionado
        const estadoSelect = document.getElementById('cadastroEstado');
        if (estadoSelect) {
            estadoSelect.addEventListener('change', function(e) {
                carregarCidades('cadastroCidade', e.target.value);
            });
        }
        
        // Configurar evento para o campo de edi√ß√£o de estado
        const editEstadoSelect = document.getElementById('editEstado');
        if (editEstadoSelect) {
            editEstadoSelect.addEventListener('change', function(e) {
                carregarCidades('editCidade', e.target.value);
            });
        }
        
        // Fun√ß√£o para carregar cidades baseado no estado
        function carregarCidades(selectCidadeId, estado) {
            const selectCidade = document.getElementById(selectCidadeId);
            if (!selectCidade) return;
            
            // Limpar o select e adicionar a op√ß√£o padr√£o
            selectCidade.innerHTML = '<option value="">Selecione a cidade</option>';
            
            // Verificar se temos os dados de munic√≠pios carregados
            if (typeof estadosCidades !== 'undefined' && estado && estadosCidades[estado]) {
                estadosCidades[estado].forEach(cidade => {
                    const option = document.createElement('option');
                    option.value = cidade;
                    option.textContent = cidade;
                    selectCidade.appendChild(option);
                });
            } else if (estado) {
                // Se n√£o temos os dados, mostrar mensagem
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'Carregando cidades...';
                selectCidade.appendChild(option);
            }
        }

        // ==================== FUN√á√ïES DE VOLUNT√ÅRIOS ====================

        // Carregar lista de volunt√°rios
        async function carregarVoluntarios(busca = '') {
            try {
                const token = localStorage.getItem('token');
                const url = busca ? 
                    `/api/voluntarios?busca=${encodeURIComponent(busca)}` : 
                    '/api/voluntarios';
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        alert('Sess√£o expirada. Fa√ßa login novamente.');
                        window.location.href = 'login.html';
                        return;
                    }
                    if (response.status === 403) {
                        alert('Acesso negado. Apenas administradores e l√≠deres podem gerenciar volunt√°rios.');
                        return;
                    }
                    throw new Error(`Erro ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                exibirListaVoluntarios(data.voluntarios || []);
                
            } catch (error) {
                console.error('Erro ao carregar volunt√°rios:', error);
                document.getElementById('listaVoluntarios').innerHTML = 
                    '<p style="color: red;">Erro ao carregar volunt√°rios: ' + error.message + '</p>';
            }
        }

        // Exibir lista de volunt√°rios
        function exibirListaVoluntarios(voluntarios) {
            const container = document.getElementById('listaVoluntarios');
            
            if (voluntarios.length === 0) {
                container.innerHTML = '<p>Nenhum volunt√°rio encontrado.</p>';
                return;
            }
            
            let html = '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
            html += '<thead><tr style="background: #f8f9fa;">';
            html += '<th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Nome</th>';
            html += '<th style="padding: 10px; border: 1px solid #ddd; text-align: left;">CPF</th>';
            html += '<th style="padding: 10px; border: 1px solid #ddd; text-align: left;">E-mail</th>';
            html += '<th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Cidade/Estado</th>';
            html += '<th style="padding: 10px; border: 1px solid #ddd; text-align: center;">A√ß√µes</th>';
            html += '</tr></thead><tbody>';
            
            voluntarios.forEach(voluntario => {
                html += '<tr>';
                html += `<td style="padding: 10px; border: 1px solid #ddd;">${voluntario.nome}</td>`;
                html += `<td style="padding: 10px; border: 1px solid #ddd;">${voluntario.cpf || '-'}</td>`;
                html += `<td style="padding: 10px; border: 1px solid #ddd;">${voluntario.email || '-'}</td>`;
                
                let localizacao = '';
                if (voluntario.cidade && voluntario.estado) {
                    localizacao = `${voluntario.cidade}/${voluntario.estado}`;
                } else if (voluntario.cidade) {
                    localizacao = voluntario.cidade;
                } else if (voluntario.estado) {
                    localizacao = voluntario.estado;
                } else {
                    localizacao = '-';
                }
                html += `<td style="padding: 10px; border: 1px solid #ddd;">${localizacao}</td>`;
                
                html += '<td style="padding: 10px; border: 1px solid #ddd; text-align: center;">';
                html += `<button onclick="editarVoluntario(${voluntario.id})" style="background: #007bff; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; margin-right: 5px;">‚úèÔ∏è Editar</button>`;
                html += `<button onclick="excluirVoluntario(${voluntario.id}, '${voluntario.nome}')" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">üóëÔ∏è Excluir</button>`;
                html += '</td>';
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // Buscar volunt√°rios
        function buscarVoluntarios() {
            const busca = document.getElementById('buscaVoluntarios').value.trim();
            carregarVoluntarios(busca);
        }

        // Mostrar modal de novo volunt√°rio
        function mostrarModalNovoVoluntario() {
            document.getElementById('modalNovoVoluntario').style.display = 'block';
            document.getElementById('formNovoVoluntario').reset();
            
            // Resetar checkbox e campos de usu√°rio
            document.getElementById('criarUsuario').checked = true;
            toggleCamposUsuario();
            
            // Verificar se o usu√°rio atual √© administrador para mostrar op√ß√£o de admin
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            const opcaoAdmin = document.getElementById('opcaoAdmin');
            const infoTipoUsuario = document.getElementById('infoTipoUsuario');
            
            if (user.tipo === 'administrador') {
                opcaoAdmin.style.display = 'block';
                infoTipoUsuario.textContent = 'Como administrador, voc√™ pode criar usu√°rios de todos os tipos';
                infoTipoUsuario.style.color = '#28a745';
            } else {
                opcaoAdmin.style.display = 'none';
                infoTipoUsuario.textContent = 'Voc√™ pode criar usu√°rios do tipo Geral e L√≠der';
                infoTipoUsuario.style.color = '#666';
            }
            
            // Event listener para checkbox
            document.getElementById('criarUsuario').addEventListener('change', toggleCamposUsuario);
            
            // Aplicar m√°scara no CPF
            const cpfInput = document.getElementById('voluntarioCpf');
            cpfInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length <= 11) {
                    value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
                    e.target.value = value;
                }
            });
        }

        // Controlar visibilidade dos campos de usu√°rio
        function toggleCamposUsuario() {
            const checkbox = document.getElementById('criarUsuario');
            const campos = document.getElementById('camposUsuario');
            
            if (checkbox.checked) {
                campos.style.display = 'grid';
            } else {
                campos.style.display = 'none';
            }
        }

        // Gerar senha aleat√≥ria
        function gerarSenhaAleatoria() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789';
            let senha = '';
            for (let i = 0; i < 8; i++) {
                senha += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return senha;
        }

        // Fechar modal de novo volunt√°rio
        function fecharModalVoluntario() {
            document.getElementById('modalNovoVoluntario').style.display = 'none';
        }

        // Cadastrar novo volunt√°rio
        document.getElementById('formNovoVoluntario').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const voluntarioData = {
                nome: document.getElementById('voluntarioNome').value.trim(),
                cpf: document.getElementById('voluntarioCpf').value.trim(),
                data_nascimento: document.getElementById('voluntarioDataNascimento').value,
                religiao: document.getElementById('voluntarioReligiao').value.trim(),
                estado: document.getElementById('voluntarioEstado').value,
                cidade: document.getElementById('voluntarioCidade').value.trim(),
                email: document.getElementById('voluntarioEmail').value.trim()
            };

            // Adicionar dados de usu√°rio se checkbox marcado
            if (document.getElementById('criarUsuario').checked) {
                let senha = document.getElementById('senhaInicial').value.trim();
                if (!senha) {
                    senha = gerarSenhaAleatoria();
                }

                voluntarioData.criar_usuario = true;
                voluntarioData.usuario = {
                    tipo: document.getElementById('tipoUsuario').value,
                    senha: senha
                };
            }
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/voluntarios', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(voluntarioData)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    let mensagem = '‚úÖ Volunt√°rio cadastrado com sucesso!';
                    
                    // Se um usu√°rio foi criado, mostrar as credenciais
                    if (data.usuario_criado) {
                        mensagem += '\n\nüë§ Usu√°rio do sistema criado:';
                        mensagem += '\nüìß Email: ' + data.usuario_criado.email;
                        mensagem += '\nüîë Senha: ' + data.usuario_criado.senha_inicial;
                        mensagem += '\nüë• Tipo: ' + data.usuario_criado.tipo;
                        mensagem += '\n\n‚ö†Ô∏è IMPORTANTE: Anote essas credenciais! O volunt√°rio dever√° trocar a senha no primeiro login.';
                    }
                    
                    alert(mensagem);
                    fecharModalVoluntario();
                    carregarVoluntarios();
                } else {
                    alert('‚ùå Erro: ' + data.error);
                }
                
            } catch (error) {
                console.error('Erro ao cadastrar volunt√°rio:', error);
                alert('‚ùå Erro ao cadastrar volunt√°rio: ' + error.message);
            }
        });

        // Editar volunt√°rio
        async function editarVoluntario(id) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/voluntarios/${id}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Erro ${response.status}: ${response.statusText}`);
                }
                
                const voluntario = await response.json();
                
                // Preencher formul√°rio de edi√ß√£o
                document.getElementById('editVoluntarioId').value = voluntario.id;
                document.getElementById('editVoluntarioNome').value = voluntario.nome || '';
                document.getElementById('editVoluntarioCpf').value = voluntario.cpf || '';
                document.getElementById('editVoluntarioDataNascimento').value = voluntario.data_nascimento || '';
                document.getElementById('editVoluntarioReligiao').value = voluntario.religiao || '';
                document.getElementById('editVoluntarioEstado').value = voluntario.estado || '';
                document.getElementById('editVoluntarioCidade').value = voluntario.cidade || '';
                document.getElementById('editVoluntarioEmail').value = voluntario.email || '';
                
                // Mostrar modal
                document.getElementById('modalEditarVoluntario').style.display = 'block';
                
                // Aplicar m√°scara no CPF
                const cpfInput = document.getElementById('editVoluntarioCpf');
                cpfInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length <= 11) {
                        value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
                        e.target.value = value;
                    }
                });
                
            } catch (error) {
                console.error('Erro ao carregar volunt√°rio:', error);
                alert('‚ùå Erro ao carregar dados do volunt√°rio: ' + error.message);
            }
        }

        // Fechar modal de editar volunt√°rio
        function fecharModalEditarVoluntario() {
            document.getElementById('modalEditarVoluntario').style.display = 'none';
        }

        // Salvar altera√ß√µes do volunt√°rio
        document.getElementById('formEditarVoluntario').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const id = document.getElementById('editVoluntarioId').value;
            const voluntarioData = {
                nome: document.getElementById('editVoluntarioNome').value.trim(),
                cpf: document.getElementById('editVoluntarioCpf').value.trim(),
                data_nascimento: document.getElementById('editVoluntarioDataNascimento').value,
                religiao: document.getElementById('editVoluntarioReligiao').value.trim(),
                estado: document.getElementById('editVoluntarioEstado').value,
                cidade: document.getElementById('editVoluntarioCidade').value.trim(),
                email: document.getElementById('editVoluntarioEmail').value.trim()
            };
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/voluntarios/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(voluntarioData)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('‚úÖ Volunt√°rio atualizado com sucesso!');
                    fecharModalEditarVoluntario();
                    carregarVoluntarios();
                } else {
                    alert('‚ùå Erro: ' + data.error);
                }
                
            } catch (error) {
                console.error('Erro ao atualizar volunt√°rio:', error);
                alert('‚ùå Erro ao atualizar volunt√°rio: ' + error.message);
            }
        });

        // Excluir volunt√°rio
        async function excluirVoluntario(id, nome) {
            if (!confirm(`Tem certeza que deseja excluir o volunt√°rio "${nome}"?\n\nEsta a√ß√£o n√£o pode ser desfeita.`)) {
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/voluntarios/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('‚úÖ Volunt√°rio exclu√≠do com sucesso!');
                    carregarVoluntarios();
                } else {
                    alert('‚ùå Erro: ' + data.error);
                }
                
            } catch (error) {
                console.error('Erro ao excluir volunt√°rio:', error);
                alert('‚ùå Erro ao excluir volunt√°rio: ' + error.message);
            }
        }

        // ========== FUN√á√ïES DE FREQU√äNCIA DE VOLUNT√ÅRIOS ==========
        
        let voluntarioSelecionado = null;

        // Buscar volunt√°rio para frequ√™ncia
        async function buscarVoluntarioFrequencia() {
            const termo = document.getElementById('buscaVoluntario').value.trim();
            const resultado = document.getElementById('resultadoBuscaVoluntario');
            
            if (termo.length < 2) {
                resultado.innerHTML = '<p style="color: #666;">Digite pelo menos 2 caracteres para buscar</p>';
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/voluntarios?busca=${encodeURIComponent(termo)}&limit=10`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Erro ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.voluntarios && data.voluntarios.length > 0) {
                    let html = '<div style="max-height: 200px; overflow-y: auto;">';
                    data.voluntarios.forEach((voluntario, index) => {
                        html += `
                            <div class="voluntario-resultado" data-index="${index}" 
                                 style="padding: 10px; border: 1px solid #ddd; margin-bottom: 5px; cursor: pointer; background: white; border-radius: 4px;">
                                <strong>${voluntario.nome}</strong><br>
                                <small>CPF: ${voluntario.cpf || 'N√£o informado'} | Email: ${voluntario.email || 'N√£o informado'}</small>
                            </div>
                        `;
                    });
                    html += '</div>';
                    resultado.innerHTML = html;
                    
                    // Armazenar volunt√°rios encontrados
                    window.voluntariosEncontrados = data.voluntarios;
                    
                    // Adicionar event listeners
                    document.querySelectorAll('.voluntario-resultado').forEach(div => {
                        div.addEventListener('click', function() {
                            const index = parseInt(this.dataset.index);
                            selecionarVoluntarioFrequencia(index);
                        });
                        
                        div.addEventListener('mouseover', function() {
                            this.style.backgroundColor = '#f0f0f0';
                        });
                        
                        div.addEventListener('mouseout', function() {
                            this.style.backgroundColor = 'white';
                        });
                    });
                } else {
                    resultado.innerHTML = '<p style="color: #666;">Nenhum volunt√°rio encontrado</p>';
                }
                
            } catch (error) {
                console.error('Erro ao buscar volunt√°rios:', error);
                resultado.innerHTML = '<p style="color: #dc3545;">‚ùå Erro ao buscar volunt√°rios</p>';
            }
        }

        // Selecionar volunt√°rio para frequ√™ncia
        function selecionarVoluntarioFrequencia(index) {
            if (!window.voluntariosEncontrados || !window.voluntariosEncontrados[index]) {
                alert('Erro ao selecionar volunt√°rio');
                return;
            }
            
            voluntarioSelecionado = window.voluntariosEncontrados[index];
            
            // Mostrar dados do volunt√°rio selecionado
            const dadosDiv = document.getElementById('dadosVoluntarioSelecionado');
            dadosDiv.innerHTML = `
                <strong>üë§ ${voluntarioSelecionado.nome}</strong><br>
                <small>CPF: ${voluntarioSelecionado.cpf || 'N√£o informado'} | Email: ${voluntarioSelecionado.email || 'N√£o informado'}</small>
            `;
            
            // Mostrar formul√°rio
            document.getElementById('formularioFrequenciaVoluntario').style.display = 'block';
            
            // Limpar resultado da busca
            document.getElementById('resultadoBuscaVoluntario').innerHTML = '';
            document.getElementById('buscaVoluntario').value = voluntarioSelecionado.nome;
            
            // Definir data atual como padr√£o
            document.getElementById('dataTrabalhoVoluntario').value = new Date().toISOString().split('T')[0];
        }

        // Registrar frequ√™ncia de volunt√°rio
        async function registrarFrequenciaVoluntario() {
            if (!voluntarioSelecionado) {
                alert('Selecione um volunt√°rio');
                return;
            }
            
            const dataTrabalho = document.getElementById('dataTrabalhoVoluntario').value;
            const horaInicio = document.getElementById('horaInicioVoluntario').value;
            const horaFim = document.getElementById('horaFimVoluntario').value;
            const localInicio = document.getElementById('localInicioVoluntario').value;
            const localFim = document.getElementById('localFimVoluntario').value;
            const observacoes = document.getElementById('observacoesVoluntario').value;
            
            // Valida√ß√µes
            if (!dataTrabalho) {
                alert('Data do trabalho √© obrigat√≥ria');
                return;
            }
            
            if (!horaInicio) {
                alert('Hora de in√≠cio √© obrigat√≥ria');
                return;
            }
            
            if (!localInicio) {
                alert('Local de in√≠cio √© obrigat√≥rio');
                return;
            }
            
            const frequenciaData = {
                voluntario_id: voluntarioSelecionado.id,
                data_trabalho: dataTrabalho,
                hora_inicio: horaInicio,
                hora_fim: horaFim || null,
                local_inicio: localInicio,
                local_fim: localFim || null,
                observacoes: observacoes || null
            };
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/frequencia_voluntarios', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(frequenciaData)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert(`‚úÖ Frequ√™ncia registrada com sucesso!\n\nVolunt√°rio: ${voluntarioSelecionado.nome}\nData: ${formatarDataMySQL(dataTrabalho)}\nLocal: ${localInicio}`);
                    cancelarFrequenciaVoluntario();
                    carregarFrequenciasVoluntarios();
                } else {
                    alert('‚ùå Erro: ' + data.error);
                }
                
            } catch (error) {
                console.error('Erro ao registrar frequ√™ncia:', error);
                alert('‚ùå Erro ao registrar frequ√™ncia: ' + error.message);
            }
        }

        // Cancelar registro de frequ√™ncia
        function cancelarFrequenciaVoluntario() {
            voluntarioSelecionado = null;
            document.getElementById('formularioFrequenciaVoluntario').style.display = 'none';
            document.getElementById('buscaVoluntario').value = '';
            document.getElementById('resultadoBuscaVoluntario').innerHTML = '';
            
            // Limpar formul√°rio
            document.getElementById('dataTrabalhoVoluntario').value = '';
            document.getElementById('horaInicioVoluntario').value = '';
            document.getElementById('horaFimVoluntario').value = '';
            document.getElementById('localInicioVoluntario').value = '';
            document.getElementById('localFimVoluntario').value = '';
            document.getElementById('observacoesVoluntario').value = '';
        }

        // Carregar frequ√™ncias de volunt√°rios
        async function carregarFrequenciasVoluntarios() {
            const container = document.getElementById('listaFrequenciasVoluntarios');
            container.innerHTML = '<p>Carregando frequ√™ncias...</p>';
            
            try {
                const token = localStorage.getItem('token');
                let url = '/api/frequencia_voluntarios?limit=20';
                
                // Aplicar filtros se definidos
                const dataInicio = document.getElementById('filtroDataInicioVoluntarios').value;
                const dataFim = document.getElementById('filtroDataFimVoluntarios').value;
                const local = document.getElementById('filtroLocalVoluntarios').value;
                
                if (dataInicio) url += `&data_inicio=${dataInicio}`;
                if (dataFim) url += `&data_fim=${dataFim}`;
                if (local) url += `&local_inicio=${encodeURIComponent(local)}`;
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Erro ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.frequencias && data.frequencias.length > 0) {
                    let html = '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
                    html += `
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Volunt√°rio</th>
                                <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Data</th>
                                <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Hor√°rio</th>
                                <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Local In√≠cio</th>
                                <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Local Fim</th>
                                <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Lan√ßado por</th>
                                <th style="padding: 10px; border: 1px solid #ddd; text-align: center;">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                    `;
                    
                    data.frequencias.forEach(freq => {
                        html += '<tr>';
                        html += `<td style="padding: 10px; border: 1px solid #ddd;"><strong>${freq.voluntario_nome}</strong><br><small>${freq.voluntario_cpf || 'CPF n√£o informado'}</small></td>`;
                        html += `<td style="padding: 10px; border: 1px solid #ddd;">${formatarDataMySQL(freq.data_trabalho)}</td>`;
                        
                        let horario = freq.hora_inicio;
                        if (freq.hora_fim) {
                            horario += ` - ${freq.hora_fim}`;
                        }
                        html += `<td style="padding: 10px; border: 1px solid #ddd;">${horario}</td>`;
                        
                        html += `<td style="padding: 10px; border: 1px solid #ddd;"><span style="background: #e8f5e8; padding: 2px 6px; border-radius: 3px; font-size: 0.9em;">${freq.local_inicio}</span></td>`;
                        html += `<td style="padding: 10px; border: 1px solid #ddd;">${freq.local_fim ? `<span style="background: #fff3cd; padding: 2px 6px; border-radius: 3px; font-size: 0.9em;">${freq.local_fim}</span>` : '-'}</td>`;
                        html += `<td style="padding: 10px; border: 1px solid #ddd;"><small>${freq.lancado_por_nome}</small></td>`;
                        
                        html += '<td style="padding: 10px; border: 1px solid #ddd; text-align: center;">';
                        html += `<button onclick="excluirFrequenciaVoluntario(${freq.id}, '${freq.voluntario_nome}', '${formatarDataMySQL(freq.data_trabalho)}')" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 0.8em;">üóëÔ∏è Excluir</button>`;
                        html += '</td>';
                        html += '</tr>';
                        
                        // Adicionar linha de observa√ß√µes se houver
                        if (freq.observacoes) {
                            html += `<tr><td colspan="7" style="padding: 5px 10px; border: 1px solid #ddd; background: #f8f9fa; font-style: italic; font-size: 0.9em;"><strong>Obs:</strong> ${freq.observacoes}</td></tr>`;
                        }
                    });
                    
                    html += '</tbody></table></div>';
                    html += `<p style="margin-top: 10px; color: #666; font-size: 0.9em;">Total: ${data.total} frequ√™ncia(s) encontrada(s)</p>`;
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<p style="color: #666;">Nenhuma frequ√™ncia encontrada</p>';
                }
                
            } catch (error) {
                console.error('Erro ao carregar frequ√™ncias:', error);
                container.innerHTML = '<p style="color: #dc3545;">‚ùå Erro ao carregar frequ√™ncias</p>';
            }
        }

        // Excluir frequ√™ncia de volunt√°rio
        async function excluirFrequenciaVoluntario(id, nomeVoluntario, data) {
            if (!confirm(`Tem certeza que deseja excluir a frequ√™ncia?\n\nVolunt√°rio: ${nomeVoluntario}\nData: ${data}\n\nEsta a√ß√£o n√£o pode ser desfeita.`)) {
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/frequencia_voluntarios/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('‚úÖ Frequ√™ncia exclu√≠da com sucesso!');
                    carregarFrequenciasVoluntarios();
                } else {
                    alert('‚ùå Erro: ' + data.error);
                }
                
            } catch (error) {
                console.error('Erro ao excluir frequ√™ncia:', error);
                alert('‚ùå Erro ao excluir frequ√™ncia: ' + error.message);
            }
        }

        // Fun√ß√£o removida - verifica√ß√£o de permiss√µes agora √© feita inline ap√≥s autentica√ß√£o

        // Fun√ß√£o carregarVoluntariosParaFiltro j√° definida no in√≠cio do script - removendo duplicata

            } // Fim do else (usu√°rio autenticado e n√£o precisa trocar senha)
        } else {
            // Usu√°rio n√£o autenticado - redirecionar para login
            console.log('Redirecionando para login - Token ou usu√°rio inv√°lido');
            window.location.href = 'login.html';
        }

        // Inicializar frequ√™ncias de volunt√°rios quando a se√ß√£o for mostrada
        document.addEventListener('DOMContentLoaded', function() {
            // Carregar volunt√°rios para o filtro do relat√≥rio
            carregarVoluntariosParaFiltro();
        });
    </script>
</body>
</html>